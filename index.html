<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <title>日常生活記錄</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="生活記錄">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='35' fill='url(%23bg)'/%3E%3Ccircle cx='90' cy='70' r='25' fill='white' opacity='0.2'/%3E%3Ctext x='90' y='80' text-anchor='middle' fill='white' font-size='40' font-family='system-ui, sans-serif' font-weight='600'%3E記%3C/text%3E%3Crect x='50' y='110' width='80' height='4' rx='2' fill='white' opacity='0.7'/%3E%3Crect x='60' y='125' width='60' height='3' rx='1.5' fill='white' opacity='0.5'/%3E%3Crect x='70' y='138' width='40' height='3' rx='1.5' fill='white' opacity='0.3'/%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json,{%22name%22:%22日常生活記錄%22,%22short_name%22:%22生活記錄%22,%22description%22:%22個人日常記錄管理系統%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' rx='35' fill='url(%23bg)'/%3E%3Ccircle cx='96' cy='75' r='28' fill='white' opacity='0.2'/%3E%3Ctext x='96' y='85' text-anchor='middle' fill='white' font-size='45' font-family='system-ui, sans-serif' font-weight='600'%3E記%3C/text%3E%3Crect x='50' y='120' width='92' height='5' rx='2.5' fill='white' opacity='0.7'/%3E%3Crect x='60' y='135' width='72' height='4' rx='2' fill='white' opacity='0.5'/%3E%3Crect x='70' y='148' width='52' height='4' rx='2' fill='white' opacity='0.3'/%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22},{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='85' fill='url(%23bg)'/%3E%3Ccircle cx='256' cy='190' r='70' fill='white' opacity='0.2'/%3E%3Ctext x='256' y='215' text-anchor='middle' fill='white' font-size='110' font-family='system-ui, sans-serif' font-weight='600'%3E記%3C/text%3E%3Crect x='130' y='300' width='252' height='12' rx='6' fill='white' opacity='0.7'/%3E%3Crect x='150' y='330' width='212' height='10' rx='5' fill='white' opacity='0.5'/%3E%3Crect x='170' y='358' width='172' height='10' rx='5' fill='white' opacity='0.3'/%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #8b5cf6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .filter-controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(139, 92, 246, 0.3);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .date-inputs {
            display: none;
            gap: 10px;
            align-items: center;
        }

        .date-inputs.show {
            display: flex;
        }

        .date-inputs input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .records-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .record-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #8b5cf6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-content {
            flex: 1;
        }

        .record-date {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .record-details {
            font-weight: 500;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: #f8fafc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .health-advice {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .advice-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav {
                gap: 5px;
            }
            
            .nav-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            #monthlyExpenseOverview .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            #monthlyExpenseOverview h3 {
                font-size: 1rem !important;
                margin-bottom: 8px !important;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 任務相關樣式 */
        .task-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid #8b5cf6;
            transition: all 0.3s ease;
        }

        .task-item.overdue { border-left-color: #ef4444; background: #fef2f2; }
        .task-item.today { border-left-color: #f59e0b; background: #fffbeb; }
        .task-item.upcoming { border-left-color: #10b981; background: #f0fdf4; }

        .task-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .task-content { flex: 1; }
        .task-name { font-weight: 600; margin-bottom: 5px; }
        .task-date { font-size: 0.9rem; color: #6b7280; }

        .task-priority { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
        .task-priority.high { background: #fef2f2; color: #dc2626; }
        .task-priority.medium { background: #fffbeb; color: #d97706; }
        .task-priority.low { background: #f0fdf4; color: #059669; }

        /* 習慣相關樣式 */
        .habit-item {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .habit-item.checked { background: #f0fdf4; border-color: #10b981; }
        .habit-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .habit-name { flex: 1; font-weight: 500; }
        .habit-streak { font-size: 0.8rem; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 12px; }

        /* 日誌相關樣式 */
        .diary-entry { background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #8b5cf6; }
        .diary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .diary-date { font-weight: 600; color: #374151; }
        .diary-mood { padding: 4px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 500; }

        .mood-5 { background: #f0fdf4; color: #059669; }
        .mood-4 { background: #f0f9ff; color: #0284c7; }
        .mood-3 { background: #f9fafb; color: #6b7280; }
        .mood-2 { background: #fffbeb; color: #d97706; }
        .mood-1 { background: #fef2f2; color: #dc2626; }

        .diary-content { margin: 10px 0; line-height: 1.6; }
        .diary-stats { display: flex; gap: 15px; font-size: 0.9rem; color: #6b7280; margin-top: 10px; }
        .diary-habits { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
        .diary-habit-tag { background: #e5e7eb; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
        .diary-habit-tag.completed { background: #dcfce7; color: #059669; }

        /* 番茄鐘浮動按鈕樣式 */
        .pomodoro-float {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .pomodoro-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .pomodoro-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
        }

        .pomodoro-btn.running {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            animation: pulse 2s infinite;
        }

        .pomodoro-btn.break {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pomodoro-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 280px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 20px;
            transform: translateY(10px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .pomodoro-panel.show {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }

        .pomodoro-time-display {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .pomodoro-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .pomodoro-control-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pomodoro-start {
            background: #22c55e;
            color: white;
        }

        .pomodoro-pause {
            background: #f59e0b;
            color: white;
        }

        .pomodoro-reset {
            background: #ef4444;
            color: white;
        }

        .pomodoro-settings {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .pomodoro-settings input {
            width: 50px;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }

        .pomodoro-stats {
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 10px;
        }

        /* 專注時間提醒條 */
        .focus-reminder {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 8px 20px;
            z-index: 999;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .focus-reminder.show {
            transform: translateY(0);
        }

        .focus-reminder button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* 手機適配 */
        @media (max-width: 768px) {
            .pomodoro-float {
                bottom: 20px;
                right: 15px;
            }
            
            .pomodoro-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .pomodoro-panel {
                width: 250px;
                bottom: 60px;
                right: -20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>📊 日常生活記錄</h1>
            <p>輕鬆管理您的支出、健康與生活數據</p>
        </header>

        <nav class="nav">
            <button class="nav-btn active" onclick="showSection('expenses')">💰 支出記錄</button>
            <button class="nav-btn" onclick="showSection('weight')">⚖️ 體重記錄</button>
            <button class="nav-btn" onclick="showSection('blood-pressure')">❤️ 血壓記錄</button>
            <button class="nav-btn" onclick="showSection('exercise')">🏃 運動記錄</button>
            <button class="nav-btn" onclick="showSection('tasks')">📋 例行任務</button>
            <button class="nav-btn" onclick="showSection('diary')">📖 簡易日誌</button>
            <button class="nav-btn" onclick="showSection('charts')">📈 圖表分析</button>
            <button class="nav-btn" onclick="showSection('profile')">👤 基本資料</button>
            <button class="nav-btn" onclick="showSection('settings')">⚙️ 設定管理</button>
        </nav>

        <!-- 支出記錄 -->
        <section id="expenses" class="section active">
            <div class="card">
                <h2 class="card-title">📊 本月支出概覽</h2>
                <div id="monthlyExpenseOverview">
                    <!-- 本月支出統計將在這裡顯示 -->
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">💰 新增支出記錄</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>分類</label>
                        <select id="expenseCategory" required>
                            <option value="">請選擇分類</option>
                            <option value="食物">🍽️ 食物</option>
                            <option value="交通">🚗 交通</option>
                            <option value="娛樂">🎬 娛樂</option>
                            <option value="購物">🛍️ 購物</option>
                            <option value="醫療">🏥 醫療</option>
                            <option value="教育">📚 教育</option>
                            <option value="規費">💸 規費</option>
                            <option value="其他">📝 其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>項目</label>
                        <input type="text" id="expenseItem" placeholder="例如：午餐" required>
                    </div>
                    <div class="form-group">
                        <label>金額 (NT$)</label>
                        <input type="number" id="expenseAmount" placeholder="0" required>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>備註</label>
                        <textarea id="expenseNote" placeholder="選填..." rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addExpense()">新增支出記錄</button>
            </div>

            <div class="card">
                <h3 class="card-title">📋 支出記錄</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">篩選範圍：</span>
                    <button class="filter-btn active" onclick="setExpenseFilter('all')">所有記錄</button>
                    <button class="filter-btn" onclick="setExpenseFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setExpenseFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setExpenseFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setExpenseFilter('custom')">自訂區間</button>
                    <div class="date-inputs" id="expenseDateInputs">
                        <input type="date" id="expenseStartDate">
                        <span>至</span>
                        <input type="date" id="expenseEndDate">
                        <button class="filter-btn" onclick="applyExpenseCustomFilter()">套用</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="expenseCount">0</span> 筆記錄</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('expenses')">📊 匯出 CSV</button>
                </div>
                <div id="expensesList" class="records-list"></div>
            </div>
        </section>

        <!-- 體重記錄 -->
        <section id="weight" class="section">
            <div class="card">
                <h2 class="card-title">⚖️ 新增體重記錄</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" id="weightDate" required>
                    </div>
                    <div class="form-group">
                        <label>時間</label>
                        <input type="time" id="weightTime" required>
                    </div>
                    <div class="form-group">
                        <label>體重 (kg)</label>
                        <input type="number" step="0.1" id="weightValue" placeholder="例如：65.5" required>
                    </div>
                    <div class="form-group">
                        <label>腰圍 (cm)</label>
                        <input type="number" step="0.1" id="waistValue" placeholder="例如：80.5">
                    </div>
                </div>
                <button class="btn" onclick="addWeight()">新增體重記錄</button>
            </div>

            <div class="card">
                <h3 class="card-title">📊 體重統計</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgWeight">--</div>
                        <div class="stat-label">平均體重</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="latestBMI">--</div>
                        <div class="stat-label">最新 BMI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weightChange">--</div>
                        <div class="stat-label">本月變化</div>
                    </div>
                </div>
                <div id="weightAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">💡 健康建議</div>
                    <div id="weightAdviceContent"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📋 體重記錄</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">篩選範圍：</span>
                    <button class="filter-btn active" onclick="setWeightFilter('all')">所有記錄</button>
                    <button class="filter-btn" onclick="setWeightFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setWeightFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setWeightFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setWeightFilter('custom')">自訂區間</button>
                    <div class="date-inputs" id="weightDateInputs">
                        <input type="date" id="weightStartDate">
                        <span>至</span>
                        <input type="date" id="weightEndDate">
                        <button class="filter-btn" onclick="applyWeightCustomFilter()">套用</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="weightCount">0</span> 筆記錄</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('weights')">📊 匯出 CSV</button>
                </div>
                <div id="weightsList" class="records-list"></div>
            </div>
        </section>

        <!-- 血壓記錄 -->
        <section id="blood-pressure" class="section">
            <div class="card">
                <h2 class="card-title">❤️ 新增血壓記錄</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" id="bpDate" required>
                    </div>
                    <div class="form-group">
                        <label>時間</label>
                        <input type="time" id="bpTime" required>
                    </div>
                    <div class="form-group">
                        <label>收縮壓 (mmHg)</label>
                        <input type="number" id="systolic" placeholder="例如：120" required>
                    </div>
                    <div class="form-group">
                        <label>舒張壓 (mmHg)</label>
                        <input type="number" id="diastolic" placeholder="例如：80" required>
                    </div>
                    <div class="form-group">
                        <label>脈搏 (次/分)</label>
                        <input type="number" id="pulse" placeholder="例如：72">
                    </div>
                </div>
                <button class="btn" onclick="addBloodPressure()">新增血壓記錄</button>
            </div>

            <div class="card">
                <h3 class="card-title">📊 血壓統計</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgSystolic">--</div>
                        <div class="stat-label">平均收縮壓</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDiastolic">--</div>
                        <div class="stat-label">平均舒張壓</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgPulse">--</div>
                        <div class="stat-label">平均脈搏</div>
                    </div>
                </div>
                <div id="bpAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">💡 血壓建議</div>
                    <div id="bpAdviceContent"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📋 血壓記錄</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">篩選範圍：</span>
                    <button class="filter-btn active" onclick="setBPFilter('all')">所有記錄</button>
                    <button class="filter-btn" onclick="setBPFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setBPFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setBPFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setBPFilter('custom')">自訂區間</button>
                    <div class="date-inputs" id="bpDateInputs">
                        <input type="date" id="bpStartDate">
                        <span>至</span>
                        <input type="date" id="bpEndDate">
                        <button class="filter-btn" onclick="applyBPCustomFilter()">套用</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="bpCount">0</span> 筆記錄</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('bloodPressure')">📊 匯出 CSV</button>
                </div>
                <div id="bpList" class="records-list"></div>
            </div>
        </section>

        <!-- 運動記錄 -->
        <section id="exercise" class="section">
            <div class="card">
                <h2 class="card-title">🏃 新增運動記錄</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" id="exerciseDate" required>
                    </div>
                    <div class="form-group">
                        <label>開始時間</label>
                        <input type="time" id="exerciseStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>運動類型</label>
                        <select id="exerciseType" required>
                            <option value="">請選擇運動類型</option>
                            <option value="跑步">🏃 跑步</option>
                            <option value="健走">🚶 健走</option>
                            <option value="騎車">🚴 騎車</option>
                            <option value="游泳">🏊 游泳</option>
                            <option value="重訓">🏋️ 重量訓練</option>
                            <option value="瑜珈">🧘 瑜珈</option>
                            <option value="球類">⚽ 球類運動</option>
                            <option value="其他">📝 其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>運動時間 (分鐘)</label>
                        <input type="number" id="exerciseDuration" placeholder="例如：30" required>
                    </div>
                    <div class="form-group">
                        <label>消耗卡路里 (選填)</label>
                        <input type="number" id="exerciseCalories" placeholder="例如：200">
                    </div>
                    <div class="form-group">
                        <label>運動強度</label>
                        <select id="exerciseIntensity">
                            <option value="輕度">😌 輕度</option>
                            <option value="中度" selected>😊 中度</option>
                            <option value="高強度">😤 高強度</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>備註</label>
                        <textarea id="exerciseNote" placeholder="運動心得、地點等..." rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addExercise()">新增運動記錄</button>
            </div>

            <div class="card">
                <h3 class="card-title">📊 運動統計</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyExercises">0</div>
                        <div class="stat-label">本週運動次數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyDuration">0</div>
                        <div class="stat-label">本週運動時間 (分)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyCalories">0</div>
                        <div class="stat-label">本週消耗卡路里</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="exerciseStreak">0</div>
                        <div class="stat-label">連續運動天數</div>
                    </div>
                </div>
                <div id="exerciseAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">💡 運動建議</div>
                    <div id="exerciseAdviceContent"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📋 運動記錄</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">篩選範圍：</span>
                    <button class="filter-btn active" onclick="setExerciseFilter('all')">所有記錄</button>
                    <button class="filter-btn" onclick="setExerciseFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setExerciseFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setExerciseFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setExerciseFilter('custom')">自訂區間</button>
                    <div class="date-inputs" id="exerciseDateInputs">
                        <input type="date" id="exerciseStartDate">
                        <span>至</span>
                        <input type="date" id="exerciseEndDate">
                        <button class="filter-btn" onclick="applyExerciseCustomFilter()">套用</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="exerciseCount">0</span> 筆記錄</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('exercises')">📊 匯出 CSV</button>
                </div>
                <div id="exercisesList" class="records-list"></div>
            </div>
        </section>

        <!-- 例行任務 -->
        <section id="tasks" class="section">
            <div class="card">
                <h2 class="card-title">📋 新增例行任務</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>任務名稱</label>
                        <input type="text" id="taskName" placeholder="例如：繳電費" required>
                    </div>        
                    <div class="form-group">
                        <label>下次到期日</label>
                        <input type="date" id="taskNextDate" required>
                    </div>
                    <div class="form-group">
                        <label>重複間隔</label>
                        <select id="taskInterval" required>
                            <option value="">請選擇重複間隔</option>
                            <option value="weekly">每週</option>
                            <option value="biweekly">每雙週</option>
                            <option value="monthly">每月</option>
                            <option value="quarterly">每季</option>
                            <option value="semiannual">每半年</option>
                            <option value="annual">每年</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>優先級</label>
                        <select id="taskPriority">
                            <option value="low">🟢 低</option>
                            <option value="medium" selected>🟡 中</option>
                            <option value="high">🔴 高</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>備註</label>
                        <textarea id="taskNote" placeholder="任務說明、提醒事項等..." rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addTask()">新增例行任務</button>
            </div>

            <div class="card">
                <h3 class="card-title">📅 待辦任務列表</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="taskCount">0</span> 項任務</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="showCompletedTasks()">📋 已完成記錄</button>
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('tasks')">📊 匯出 CSV</button>
                    </div>
                </div>
                <div id="tasksList" class="records-list"></div>
            </div>

            <div class="card" id="completedTasksCard" style="display: none;">
                <h3 class="card-title">✅ 已完成任務記錄</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">篩選範圍：</span>
                    <button class="filter-btn active" onclick="setCompletedTaskFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setCompletedTaskFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setCompletedTaskFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setCompletedTaskFilter('all')">所有記錄</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="completedTaskCount">0</span> 筆記錄</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="hideCompletedTasks()">隱藏</button>
                </div>
                <div id="completedTasksList" class="records-list"></div>
            </div>
        </section>
 
        <!-- 簡易日誌 -->
        <section id="diary" class="section">
            <div class="card">
                <h2 class="card-title">📖 今日記錄</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 500;">日期:</label>
                        <input type="date" id="diaryDate" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="loadDiaryForDate()">載入該日記錄</button>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>今日步數</label>
                        <input type="number" id="diarySteps" placeholder="例如：8000">
                    </div>
                    <div class="form-group">
                        <label>心情評分</label>
                        <select id="diaryMood">
                            <option value="">請選擇</option>
                            <option value="5">😄 非常好</option>
                            <option value="4">😊 很好</option>
                            <option value="3">😐 普通</option>
                            <option value="2">😔 不太好</option>
                            <option value="1">😞 很糟</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>習慣打卡</label>
                    <div id="habitsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <!-- 習慣項目將在這裡動態生成 -->
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;" onclick="addHabit()">+ 新增習慣</button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>今日小記</label>
                    <textarea id="diaryContent" placeholder="記錄今天發生的事情、感想、收穫..." rows="5"></textarea>
                </div>

                <button class="btn" onclick="saveDiary()">儲存今日記錄</button>
            </div>

            <div class="card">
                <h3 class="card-title">📊 習慣統計</h3>
                <div id="habitsStats" class="stats-grid">
                    <!-- 習慣統計將在這裡顯示 -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📝 日誌記錄</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">篩選範圍：</span>
                    <button class="filter-btn active" onclick="setDiaryFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setDiaryFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setDiaryFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setDiaryFilter('all')">所有記錄</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">共 <span id="diaryCount">0</span> 筆記錄</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('diary')">📊 匯出 CSV</button>
                </div>
                <div id="diaryList" class="records-list"></div>
            </div>
        </section>

        <!-- 基本資料 -->
        <section id="profile" class="section">
            <div class="card">
                <h2 class="card-title">👤 基本資料設定</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" id="profileName" placeholder="您的姓名">
                    </div>
                    <div class="form-group">
                        <label>生日</label>
                        <input type="date" id="profileBirthday">
                    </div>
                    <div class="form-group">
                        <label>性別</label>
                        <select id="profileGender">
                            <option value="">請選擇</option>
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>身高 (cm)</label>
                        <input type="number" id="profileHeight" placeholder="例如：170" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>活動量</label>
                        <select id="profileActivity">
                            <option value="sedentary">久坐少動</option>
                            <option value="light" selected>輕度活動</option>
                            <option value="moderate">中度活動</option>
                            <option value="active">積極活動</option>
                            <option value="very_active">非常活躍</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="saveProfile()">儲存基本資料</button>
            </div>

            <div class="card">
                <h3 class="card-title">📊 個人資訊</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="displayAge">--</div>
                        <div class="stat-label">年齡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="displayBMI">--</div>
                        <div class="stat-label">目前 BMI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="displayTargetWeight">--</div>
                        <div class="stat-label">建議體重範圍</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="displayDailyCalories">--</div>
                        <div class="stat-label">建議日消耗</div>
                    </div>
                </div>
                <div id="profileAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">💡 個人化建議</div>
                    <div id="profileAdviceContent"></div>
                </div>
            </div>
        </section>

        <!-- 圖表分析 -->
        <section id="charts" class="section">
            <div class="card">
                <h2 class="card-title">📈 數據圖表分析</h2>
        
                <!-- 時間區間選擇 -->
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">分析時間範圍：</span>
                    <button class="filter-btn active" onclick="setChartFilter('week')">近七日</button>
                    <button class="filter-btn" onclick="setChartFilter('month')">近一個月</button>
                    <button class="filter-btn" onclick="setChartFilter('quarter')">近三個月</button>
                    <button class="filter-btn" onclick="setChartFilter('half-year')">近半年</button>
                    <button class="filter-btn" onclick="setChartFilter('year')">近一年</button>
                    <button class="filter-btn" onclick="setChartFilter('all')">全部數據</button>
                </div>
        
                <div style="text-align: center; margin: 15px 0; color: #6b7280;">
                    <span>當前分析範圍：<span id="chartRangeText">近七日</span> | 數據更新時間：<span id="chartUpdateTime">--</span></span>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">💰 支出分類分析</h3>
                <div class="chart-container">
                    <canvas id="expenseChart" width="400" height="300"></canvas>
                </div>
                <div id="expenseChartStats" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <!-- 支出統計數據將在此顯示 -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">⚖️ 體重變化趨勢</h3>
                <div class="chart-container">
                    <canvas id="weightChart" width="400" height="300"></canvas>
                </div>
                <div id="weightChartStats" style="margin-top: 15px;">
                    <!-- 體重統計將在此顯示 -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">❤️ 血壓監控圖表</h3>
                <div class="chart-container">
                    <canvas id="bpChart" width="400" height="300"></canvas>
                </div>
                <div id="bpChartStats" style="margin-top: 15px;">
                    <!-- 血壓統計將在此顯示 -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">🏃 運動統計圖表</h3>
                <div class="chart-container">
                    <canvas id="exerciseChart" width="400" height="300"></canvas>
                </div>
                <div id="exerciseChartStats" style="margin-top: 15px;">
                    <!-- 運動統計將在此顯示 -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📋 任務完成率統計</h3>
                <div class="chart-container">
                    <canvas id="taskChart" width="400" height="300"></canvas>
                </div>
                <div id="taskChartStats" style="margin-top: 15px;">
                    <!-- 任務統計將在此顯示 -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📖 習慣養成分析</h3>
                <div class="chart-container">
                    <canvas id="habitChart" width="400" height="300"></canvas>
                </div>
                <div id="habitChartStats" style="margin-top: 15px;">
                    <!-- 習慣統計將在此顯示 -->
                </div>
            </div>
        </section>

        <!-- 設定管理 -->
        <section id="settings" class="section">
            <div class="card">
                <h2 class="card-title">💰 預算設定</h2>
                <p style="color: #6b7280; margin-bottom: 15px;">設定每月各類別的預算上限，系統會在支出頁面顯示使用狀況</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>🍽️ 食物預算 (NT$)</label>
                        <input type="number" id="budgetFood" placeholder="8000">
                    </div>
                    <div class="form-group">
                        <label>🚗 交通預算 (NT$)</label>
                        <input type="number" id="budgetTransport" placeholder="3000">
                    </div>
                    <div class="form-group">
                        <label>🎬 娛樂預算 (NT$)</label>
                        <input type="number" id="budgetEntertainment" placeholder="2000">
                    </div>
                    <div class="form-group">
                        <label>🛍️ 購物預算 (NT$)</label>
                        <input type="number" id="budgetShopping" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>🏥 醫療預算 (NT$)</label>
                        <input type="number" id="budgetMedical" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>📚 教育預算 (NT$)</label>
                        <input type="number" id="budgetEducation" placeholder="3000">
                    </div>
                    <div class="form-group">
                        <label>💸 規費預算 (NT$)</label>
                        <input type="number" id="budgetUtilities" placeholder="4000">
                    </div>
                    <div class="form-group">
                        <label>📝 其他預算 (NT$)</label>
                        <input type="number" id="budgetOther" placeholder="2000">
                    </div>
                </div>
                <button class="btn" onclick="saveBudgets()">儲存預算設定</button>
            </div>

            <div class="card">
                <h2 class="card-title">⚙️ 資料管理</h2>
                <div class="export-buttons">
                    <button class="btn" onclick="exportData('json')">📤 匯出 JSON</button>
                    <button class="btn" onclick="exportData('csv')">📊 匯出 CSV</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">📥 匯入數據</button>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ 清除所有數據</button>
                    <button class="btn btn-secondary" onclick="clearTestData()">🔄 重置為範例數據</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)">
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">📱 PWA 安裝</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">在手機瀏覽器中，您可以將此應用「新增到主畫面」，就像安裝 App 一樣使用。</p>
                    <button class="btn btn-secondary" onclick="installPWA()" id="installBtn" style="display: none;">📱 安裝應用</button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">📊 數據統計</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalExpenses">0</div>
                        <div class="stat-label">支出記錄數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalWeight">0</div>
                        <div class="stat-label">體重記錄數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalBP">0</div>
                        <div class="stat-label">血壓記錄數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalExercise">0</div>
                        <div class="stat-label">運動記錄數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dataSize">0KB</div>
                        <div class="stat-label">數據大小</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
    // 數據存儲
    let appData = {
        expenses: [],
        weights: [],
        bloodPressure: [],
        exercises: [],
        tasks: [],
        completedTasks: [],
        diary: [],
        habits: [],
        profile: {
            name: '',
            birthday: '',
            gender: '',
            height: '',
            activity: 'light'
        },
        budgets: {
            '食物': 8000,
            '交通': 3000,
            '娛樂': 2000,
            '購物': 5000,
            '醫療': 1000,
            '教育': 3000,
            '規費': 4000,
            '其他': 2000
        },
        pomodoro: {
            workTime: 25,
            breakTime: 5,
            completedToday: 0,
            totalCompleted: 0,
            lastDate: null
        }
    };

    // 番茄鐘狀態
    let pomodoroState = {
        isRunning: false,
        isPaused: false,
        isBreak: false,
        timeLeft: 25 * 60, // 秒
        interval: null,
        reminderShown: false
    };

    // 篩選狀態
    let filters = {
        expense: 'all',
        weight: 'all',
        bloodPressure: 'all',
        exercise: 'all',
        completedTask: 'week',
        diary: 'week'
    };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date().toTimeString().slice(0, 5);
            
            document.getElementById('expenseDate').value = today;
            document.getElementById('weightDate').value = today;
            document.getElementById('weightTime').value = now;
            document.getElementById('bpDate').value = today;
            document.getElementById('bpTime').value = now;
            document.getElementById('exerciseDate').value = today;
            document.getElementById('exerciseStartTime').value = now;
            document.getElementById('taskNextDate').value = today;
            document.getElementById('diaryDate').value = today;

            loadData();
            updateAllDisplays();
            loadTodayDiary();
            loadProfile();
            loadBudgets();
            setupPWAInstall();
            initPomodoro();
        });

        // 頁面切換
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            
            const navBtns = document.querySelectorAll('.nav-btn');
            const sections = ['expenses', 'weight', 'blood-pressure', 'exercise', 'tasks', 'diary', 'charts', 'profile', 'settings'];
            const index = sections.indexOf(sectionName);
            if (index !== -1) {
                navBtns[index].classList.add('active');
            }
        }

        // 載入數據
        function loadData() {
            try {
                const savedData = localStorage.getItem('dailyTrackerData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // 確保數據結構完整
                    appData = {
                        expenses: parsed.expenses || [],
                        weights: parsed.weights || [],
                        bloodPressure: parsed.bloodPressure || [],
                        exercises: parsed.exercises || [],
                        tasks: parsed.tasks || [],
                        completedTasks: parsed.completedTasks || [],
                        diary: parsed.diary || [],
                        habits: parsed.habits || [],
                        profile: {
                            name: '',
                            birthday: '',
                            gender: '',
                            height: '',
                            activity: 'light',
                            ...parsed.profile
                        },
                       budgets: {
                           '食物': 8000,
                           '交通': 3000,
                           '娛樂': 2000,
                           '購物': 5000,
                           '醫療': 1000,
                           '教育': 3000,
                           '規費': 4000,
                           '其他': 2000,
                           ...parsed.budgets
                       },
                       pomodoro: {
                            workTime: 25,
                            breakTime: 5,
                            completedToday: 0,
                            totalCompleted: 0,
                            lastDate: null,
                            ...parsed.pomodoro
                        }
                    };
                    console.log('載入已保存的數據');
                } else {
                    // 第一次使用，載入範例數據
                    addSampleData();
                    console.log('載入範例數據');
                }
            } catch (error) {
                console.error('載入數據失敗:', error);
                addSampleData();
            }
        }

        // 保存數據
        function saveData() {
            try {
                localStorage.setItem('dailyTrackerData', JSON.stringify(appData));
                console.log('數據已保存到本機');
            } catch (error) {
                console.error('保存數據失敗:', error);
                // 如果保存失敗，可能是因為儲存空間不足或瀏覽器限制
                alert('保存數據失敗，請檢查瀏覽器設定或清除部分數據');
            }
        }

        // 添加示例數據
        function addSampleData() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            appData.expenses = [
                {
                    id: Date.now() + 1,
                    date: today.toISOString().split('T')[0],
                    category: '食物',
                    item: '午餐',
                    amount: 150,
                    note: '便當'
                },
                {
                    id: Date.now() + 2,
                    date: yesterday.toISOString().split('T')[0],
                    category: '交通',
                    item: '捷運',
                    amount: 30,
                    note: ''
                }
            ];

            appData.weights = [
                {
                    id: Date.now() + 3,
                    date: today.toISOString().split('T')[0],
                    time: '08:00',
                    weight: 65.5,
                    waist: 80,
                    height: 170,
                    bmi: 22.7
                }
            ];

            appData.bloodPressure = [
                {
                    id: Date.now() + 4,
                    date: today.toISOString().split('T')[0],
                    time: '09:00',
                    systolic: 120,
                    diastolic: 80,
                    pulse: 72
                }
            ];

            appData.exercises = [
                {
                    id: Date.now() + 5,
                    date: today.toISOString().split('T')[0],
                    startTime: '07:00',
                    type: '跑步',
                    duration: 30,
                    calories: 200,
                    intensity: '中度',
                    note: '晨跑'
                }
            ];

            appData.tasks = [
                {
                    id: Date.now() + 6,
                    name: '繳電費',
                    nextDate: nextWeek.toISOString().split('T')[0],
                    interval: 'monthly',
                    priority: 'medium',
                    note: '記得在期限前繳費',
                    created: today.toISOString().split('T')[0]
                }
            ];

            appData.habits = [
                { id: Date.now() + 7, name: '喝水8杯', created: today.toISOString().split('T')[0] },
                { id: Date.now() + 8, name: '早睡早起', created: today.toISOString().split('T')[0] },
                { id: Date.now() + 9, name: '閱讀30分鐘', created: today.toISOString().split('T')[0] }
            ];

            appData.diary = [
                {
                    id: Date.now() + 10,
                    date: today.toISOString().split('T')[0],
                    steps: 8000,
                    mood: 4,
                    habits: { [Date.now() + 7]: true, [Date.now() + 8]: false, [Date.now() + 9]: true },
                    content: '今天天氣很好，出門散步了一會兒。',
                    created: new Date().toISOString()
                }
            ];
        }

        // 日期篩選輔助函數
        function getDateRange(range) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(range) {
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return { start: weekAgo, end: today };
                    
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return { start: monthAgo, end: today };
                    
                case 'quarter':
                    const quarterAgo = new Date(today);
                    quarterAgo.setMonth(quarterAgo.getMonth() - 3);
                    return { start: quarterAgo, end: today };
                    
                default:
                    return { start: null, end: null };
            }
        }

        function filterRecordsByDate(records, range, customStart = null, customEnd = null) {
            if (range === 'all') return records;
            
            let dateRange;
            if (range === 'custom' && customStart && customEnd) {
                dateRange = {
                    start: new Date(customStart),
                    end: new Date(customEnd)
                };
            } else {
                dateRange = getDateRange(range);
            }
            
            if (!dateRange.start || !dateRange.end) return records;
            
            return records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= dateRange.start && recordDate <= dateRange.end;
            });
        }

        // 篩選功能
        function setExpenseFilter(range) {
            filters.expense = range;
            updateFilterButtons('expenses', range);
            const dateInputs = document.getElementById('expenseDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateExpensesList();
            }
        }

        function setWeightFilter(range) {
            filters.weight = range;
            updateFilterButtons('weight', range);
            const dateInputs = document.getElementById('weightDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateWeightsList();
            }
        }

        function setBPFilter(range) {
            filters.bloodPressure = range;
            updateFilterButtons('blood-pressure', range);
            const dateInputs = document.getElementById('bpDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateBPList();
            }
        }

        function setExerciseFilter(range) {
            filters.exercise = range;
            updateFilterButtons('exercise', range);
            const dateInputs = document.getElementById('exerciseDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateExercisesList();
            }
        }

        function updateFilterButtons(sectionId, range) {
            const filterTexts = {
                'all': '所有記錄',
                'week': '近七日',
                'month': '近一個月',
                'quarter': '近三個月',
                'custom': '自訂區間'
            };
            
            document.querySelectorAll(`#${sectionId} .filter-btn`).forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(filterTexts[range])) {
                    btn.classList.add('active');
                }
            });
        }

        function applyExpenseCustomFilter() {
            const startDate = document.getElementById('expenseStartDate').value;
            const endDate = document.getElementById('expenseEndDate').value;
            
            if (!startDate || !endDate) {
                alert('請選擇開始和結束日期');
                return;
            }
            
            filters.expenseCustomStart = startDate;
            filters.expenseCustomEnd = endDate;
            updateExpensesList();
        }

        function applyWeightCustomFilter() {
            const startDate = document.getElementById('weightStartDate').value;
            const endDate = document.getElementById('weightEndDate').value;
            
            if (!startDate || !endDate) {
                alert('請選擇開始和結束日期');
                return;
            }
            
            filters.weightCustomStart = startDate;
            filters.weightCustomEnd = endDate;
            updateWeightsList();
        }

        function applyBPCustomFilter() {
            const startDate = document.getElementById('bpStartDate').value;
            const endDate = document.getElementById('bpEndDate').value;
            
            if (!startDate || !endDate) {
                alert('請選擇開始和結束日期');
                return;
            }
            
            filters.bpCustomStart = startDate;
            filters.bpCustomEnd = endDate;
            updateBPList();
        }

        function applyExerciseCustomFilter() {
            const startDate = document.getElementById('exerciseStartDate').value;
            const endDate = document.getElementById('exerciseEndDate').value;
            
            if (!startDate || !endDate) {
                alert('請選擇開始和結束日期');
                return;
            }
            
            filters.exerciseCustomStart = startDate;
            filters.exerciseCustomEnd = endDate;
            updateExercisesList();
        }

        // 新增記錄函數
        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const item = document.getElementById('expenseItem').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const note = document.getElementById('expenseNote').value;

            if (!date || !category || !item || !amount) {
                alert('請填寫所有必填欄位');
                return;
            }

            const expense = {
                id: Date.now(),
                date,
                category,
                item,
                amount,
                note
            };

            appData.expenses.unshift(expense);
            saveData();
            updateExpensesList();
            updateStats();

            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseItem').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseNote').value = '';
            
            showSuccessMessage('支出記錄已新增！');
        }

        function addWeight() {
            const date = document.getElementById('weightDate').value;
            const time = document.getElementById('weightTime').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            const waist = parseFloat(document.getElementById('waistValue').value) || null;

            if (!date || !time || !weight) {
                alert('請填寫日期、時間和體重');
                return;
            }

            const height = appData.profile.height;
            let bmi = null;
            if (height) {
                bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            }

            const weightRecord = {
                id: Date.now(),
                date,
                time,
                weight,
                waist,
                height,
                bmi: parseFloat(bmi)
            };

            appData.weights.unshift(weightRecord);
            saveData();
            updateWeightsList();
            updateWeightStats();
            updateProfileDisplay();

            document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weightTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('weightValue').value = '';
            document.getElementById('waistValue').value = '';
            
            showSuccessMessage('體重記錄已新增！');
        }

        function addBloodPressure() {
            const date = document.getElementById('bpDate').value;
            const time = document.getElementById('bpTime').value;
            const systolic = parseInt(document.getElementById('systolic').value);
            const diastolic = parseInt(document.getElementById('diastolic').value);
            const pulse = parseInt(document.getElementById('pulse').value) || null;

            if (!date || !time || !systolic || !diastolic) {
                alert('請填寫日期、時間、收縮壓和舒張壓');
                return;
            }

            const bpRecord = {
                id: Date.now(),
                date,
                time,
                systolic,
                diastolic,
                pulse
            };

            appData.bloodPressure.unshift(bpRecord);
            saveData();
            updateBPList();
            updateBPStats();

            document.getElementById('bpDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('bpTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('pulse').value = '';
            
            showSuccessMessage('血壓記錄已新增！');
        }

        function addExercise() {
            const date = document.getElementById('exerciseDate').value;
            const startTime = document.getElementById('exerciseStartTime').value;
            const type = document.getElementById('exerciseType').value;
            const duration = parseInt(document.getElementById('exerciseDuration').value);
            const calories = parseInt(document.getElementById('exerciseCalories').value) || null;
            const intensity = document.getElementById('exerciseIntensity').value;
            const note = document.getElementById('exerciseNote').value;

            if (!date || !startTime || !type || !duration) {
                alert('請填寫日期、時間、運動類型和運動時間');
                return;
            }

            const exercise = {
                id: Date.now(),
                date,
                startTime,
                type,
                duration,
                calories,
                intensity,
                note
            };

            appData.exercises.unshift(exercise);
            saveData();
            updateExercisesList();
            updateExerciseStats();

            document.getElementById('exerciseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('exerciseStartTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('exerciseType').value = '';
            document.getElementById('exerciseDuration').value = '';
            document.getElementById('exerciseCalories').value = '';
            document.getElementById('exerciseIntensity').value = '中度';
            document.getElementById('exerciseNote').value = '';
            
            showSuccessMessage('運動記錄已新增！');
        }

        // 更新列表函數
        function updateExpensesList() {
            const container = document.getElementById('expensesList');
            const countElement = document.getElementById('expenseCount');
            
            let filteredExpenses = filterRecordsByDate(
                appData.expenses, 
                filters.expense, 
                filters.expenseCustomStart, 
                filters.expenseCustomEnd
            );
            
            countElement.textContent = filteredExpenses.length;
            
            if (filteredExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">此時間範圍內無支出記錄</p>';
                return;
            }

            container.innerHTML = filteredExpenses.map(expense => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${expense.date}</div>
                        <div class="record-details">
                            <strong>${expense.category}</strong> - ${expense.item}
                            <span style="color: #ef4444; font-weight: 600; margin-left: 10px;">NT$ ${expense.amount}</span>
                            ${expense.note ? `<br><small style="color: #6b7280;">${expense.note}</small>` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('expenses', ${expense.id})">刪除</button>
                </div>
            `).join('');

            // 更新本月支出概覽
            updateMonthlyExpenseOverview();
        }

        // 更新本月支出概覽
        function updateMonthlyExpenseOverview() {
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
            const thisMonthExpenses = appData.expenses.filter(expense => 
                expense.date.startsWith(currentMonth)
            );

            // 按類別統計本月支出
            const categoryTotals = {};
            let totalThisMonth = 0;

            thisMonthExpenses.forEach(expense => {
                if (!categoryTotals[expense.category]) {
                    categoryTotals[expense.category] = 0;
                }
                categoryTotals[expense.category] += expense.amount;
                totalThisMonth += expense.amount;
            });

            const container = document.getElementById('monthlyExpenseOverview');
    
            if (Object.keys(categoryTotals).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        本月尚無支出記錄
                    </div>
                `;
                return;
            }

            // 生成預算vs實際支出的卡片
            const categoryCards = Object.keys(appData.budgets).map(category => {
            const spent = categoryTotals[category] || 0;
            const budget = appData.budgets[category] || 0;
            const percentage = budget > 0 ? Math.round((spent / budget) * 100) : 0;
            
            let statusColor = '#10b981';
            let statusText = '正常';
            
            if (percentage >= 100) {
                statusColor = '#ef4444';
                statusText = '超支';
            } else if (percentage >= 80) {
                statusColor = '#f59e0b';
                statusText = '警示';
            }

            return `
                <div style="background: #f8fafc; border-radius: 8px; padding: 10px; border-left: 4px solid ${statusColor}; position: relative;">
                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 2px;">${getCategoryIcon(category)} ${category}</div>
                    <div style="font-size: 1rem; font-weight: 600; color: ${statusColor}; margin-bottom: 2px;">
                        NT$ ${spent.toLocaleString()}
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280;">
                        ${budget.toLocaleString()} (${percentage}%)
                    </div>
                    ${percentage >= 80 ? `<div style="font-size: 0.7rem; color: ${statusColor}; font-weight: 500;">${statusText}</div>` : ''}
                </div>
            `;
        }).join('');

            // 總支出卡片
            const totalBudget = Object.values(appData.budgets).reduce((sum, budget) => sum + budget, 0);
            const totalPercentage = totalBudget > 0 ? Math.round((totalThisMonth / totalBudget) * 100) : 0;
    
            let totalStatusColor = '#10b981';
            if (totalPercentage >= 100) totalStatusColor = '#ef4444';
            else if (totalPercentage >= 80) totalStatusColor = '#f59e0b';

            container.innerHTML = `
                <div style="margin-bottom: 15px; text-align: center;">
                    <h3 style="color: #374151; margin-bottom: 10px; font-size: 1.1rem;">📅 ${new Date().getFullYear()}年${new Date().getMonth() + 1}月支出統計</h3>
                </div>
                
                <!-- 總支出概要 -->
                <div style="background: linear-gradient(135deg, ${totalStatusColor}, ${totalStatusColor}dd); border-radius: 15px; padding: 15px; margin-bottom: 15px; color: white; text-align: center;">
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 5px;">NT$ ${totalThisMonth.toLocaleString()}</div>
                    <div style="opacity: 0.9;">本月總支出 / 預算: NT$ ${totalBudget.toLocaleString()} (${totalPercentage}%)</div>
                </div>
                
                <!-- 分類概覽 - 緊湊格式 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 15px;">
                    ${categoryCards}
                </div>
            `;
        }

        function updateWeightsList() {
            const container = document.getElementById('weightsList');
            const countElement = document.getElementById('weightCount');
            
            let filteredWeights = filterRecordsByDate(
                appData.weights, 
                filters.weight, 
                filters.weightCustomStart, 
                filters.weightCustomEnd
            );
            
            countElement.textContent = filteredWeights.length;
            
            if (filteredWeights.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">此時間範圍內無體重記錄</p>';
                return;
            }

            container.innerHTML = filteredWeights.map(weight => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${weight.date} ${weight.time}</div>
                        <div class="record-details">
                            <strong>體重:</strong> ${weight.weight} kg
                            ${weight.waist ? ` | <strong>腰圍:</strong> ${weight.waist} cm` : ''}
                            ${weight.bmi ? ` | <strong>BMI:</strong> ${weight.bmi}` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('weights', ${weight.id})">刪除</button>
                </div>
            `).join('');
        }

        function updateBPList() {
            const container = document.getElementById('bpList');
            const countElement = document.getElementById('bpCount');
            
            let filteredBP = filterRecordsByDate(
                appData.bloodPressure, 
                filters.bloodPressure, 
                filters.bpCustomStart, 
                filters.bpCustomEnd
            );
            
            countElement.textContent = filteredBP.length;
            
            if (filteredBP.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">此時間範圍內無血壓記錄</p>';
                return;
            }

            container.innerHTML = filteredBP.map(bp => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${bp.date} ${bp.time}</div>
                        <div class="record-details">
                            <strong>${bp.systolic}/${bp.diastolic}</strong> mmHg
                            ${bp.pulse ? ` | <strong>脈搏:</strong> ${bp.pulse} 次/分` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('bloodPressure', ${bp.id})">刪除</button>
                </div>
            `).join('');
        }

        function updateExercisesList() {
            const container = document.getElementById('exercisesList');
            const countElement = document.getElementById('exerciseCount');
            
            let filteredExercises = filterRecordsByDate(
                appData.exercises, 
                filters.exercise, 
                filters.exerciseCustomStart, 
                filters.exerciseCustomEnd
            );
            
            countElement.textContent = filteredExercises.length;
            
            if (filteredExercises.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">此時間範圍內無運動記錄</p>';
                return;
            }

            container.innerHTML = filteredExercises.map(exercise => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${exercise.date} ${exercise.startTime}</div>
                        <div class="record-details">
                            <strong>${exercise.type}</strong> - ${exercise.duration} 分鐘 (${exercise.intensity})
                            ${exercise.calories ? ` | <span style="color: #ef4444;">${exercise.calories} 卡路里</span>` : ''}
                            ${exercise.note ? `<br><small style="color: #6b7280;">${exercise.note}</small>` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('exercises', ${exercise.id})">刪除</button>
                </div>
            `).join('');
        }

        // 例行任務功能
        function addTask() {
            const name = document.getElementById('taskName').value;
            const nextDate = document.getElementById('taskNextDate').value;
            const interval = document.getElementById('taskInterval').value;
            const priority = document.getElementById('taskPriority').value;
            const note = document.getElementById('taskNote').value;

            if (!name || !nextDate || !interval) {
                alert('請填寫任務名稱、下次到期日和重複間隔');
                return;
            }

            const task = {
                id: Date.now(),
                name,
                nextDate,
                interval,
                priority,
                note,
                created: new Date().toISOString().split('T')[0]
            };

            appData.tasks.push(task);
            saveData();
            updateTasksList();

            // 清空表單
            document.getElementById('taskName').value = '';
            document.getElementById('taskNextDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('taskInterval').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskNote').value = '';
    
            showSuccessMessage('例行任務已新增！');
        }

        function completeTask(id) {
            const taskIndex = appData.tasks.findIndex(task => task.id === id);
            if (taskIndex === -1) return;

            const task = appData.tasks[taskIndex];
    
            // 記錄完成
            const completedTask = {
                ...task,
                completedDate: new Date().toISOString().split('T')[0],
                completedTime: new Date().toTimeString().slice(0, 5)
            };
            appData.completedTasks.unshift(completedTask);

            // 計算下次日期
            const currentDate = new Date(task.nextDate);
            const nextDate = calculateNextDate(currentDate, task.interval);
            task.nextDate = nextDate.toISOString().split('T')[0];

            saveData();
            updateTasksList();
            updateCompletedTasksList();
            showSuccessMessage(`任務「${task.name}」已完成！下次日期：${task.nextDate}`);
        }

        function calculateNextDate(currentDate, interval) {
            const nextDate = new Date(currentDate);
    
            switch(interval) {
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    break;
                case 'semiannual':
                    nextDate.setMonth(nextDate.getMonth() + 6);
                    break;
                case 'annual':
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    break;
            }
    
            return nextDate;
        }

        function updateTasksList() {
            const container = document.getElementById('tasksList');
            const countElement = document.getElementById('taskCount');
    
            // 按照到期日排序
            const sortedTasks = [...appData.tasks].sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
    
            countElement.textContent = sortedTasks.length;
    
            if (sortedTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">尚無例行任務</p>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
    
            container.innerHTML = sortedTasks.map(task => {
                const taskDate = new Date(task.nextDate);
                const todayDate = new Date(today);
                const daysDiff = Math.ceil((taskDate - todayDate) / (1000 * 60 * 60 * 24));
        
                let statusClass = 'upcoming';
                let statusText = `還有 ${daysDiff} 天`;
        
                if (daysDiff < 0) {
                    statusClass = 'overdue';
                    statusText = `逾期 ${Math.abs(daysDiff)} 天`;
                } else if (daysDiff === 0) {
                    statusClass = 'today';
                    statusText = '今天到期';
                } else if (daysDiff <= 3) {
                    statusClass = 'today';
                    statusText = `還有 ${daysDiff} 天`;
                }

                return `
                    <div class="task-item ${statusClass}">
                        <input type="checkbox" class="task-checkbox" onclick="completeTask(${task.id})">
                        <div class="task-content">
                            <div class="task-name">${task.name}</div>
                            <div class="task-date">到期日：${task.nextDate} (${statusText})</div>
                            ${task.note ? `<div style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;">${task.note}</div>` : ''}
                        </div>
                        <div class="task-priority ${task.priority}">${getPriorityText(task.priority)}</div>
                        <button class="delete-btn" onclick="deleteRecord('tasks', ${task.id})">刪除</button>
                    </div>
                `;
            }).join('');
        }

        function getPriorityText(priority) {
            const priorities = {
                'high': '🔴 高',
                'medium': '🟡 中',
                'low': '🟢 低'
            };
            return priorities[priority] || '🟡 中';
        }

        function showCompletedTasks() {
            document.getElementById('completedTasksCard').style.display = 'block';
            updateCompletedTasksList();
        }

        function hideCompletedTasks() {
            document.getElementById('completedTasksCard').style.display = 'none';
        }

        function setCompletedTaskFilter(range) {
            filters.completedTask = range;
            updateCompletedTasksList();
        }

        function updateCompletedTasksList() {
            const container = document.getElementById('completedTasksList');
            const countElement = document.getElementById('completedTaskCount');
    
            let filteredTasks = filterRecordsByDate(
                appData.completedTasks, 
                filters.completedTask, 
                null, 
                null
            );
    
            countElement.textContent = filteredTasks.length;
    
            if (filteredTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">此時間範圍內無已完成任務</p>';
                return;
            }

            container.innerHTML = filteredTasks.map(task => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${task.completedDate} ${task.completedTime}</div>
                        <div class="record-details">
                            <strong>${task.name}</strong> (${getPriorityText(task.priority)})
                            ${task.note ? `<br><small style="color: #6b7280;">${task.note}</small>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 簡易日誌功能
        function loadTodayDiary() {
            const today = new Date().toISOString().split('T')[0];
            loadDiaryForSpecificDate(today);
            updateHabitsDisplay();
            updateHabitsStats();
        }

        function loadDiaryForDate() {
            const date = document.getElementById('diaryDate').value;
            if (!date) {
                alert('請選擇日期');
                return;
            }
            loadDiaryForSpecificDate(date);
        }

        function loadDiaryForSpecificDate(date) {
            const diary = appData.diary.find(d => d.date === date);
    
            if (diary) {
                document.getElementById('diarySteps').value = diary.steps || '';
                document.getElementById('diaryMood').value = diary.mood || '';
                document.getElementById('diaryContent').value = diary.content || '';
        
                // 載入習慣完成狀態
                appData.habits.forEach(habit => {
                    const checkbox = document.querySelector(`input[data-habit-id="${habit.id}"]`);
                    if (checkbox) {
                        checkbox.checked = diary.habits && diary.habits[habit.id] || false;
                    }
                });
            } else {
                // 清空表單
                document.getElementById('diarySteps').value = '';
                document.getElementById('diaryMood').value = '';
                document.getElementById('diaryContent').value = '';
        
                // 清空習慣勾選
                appData.habits.forEach(habit => {
                    const checkbox = document.querySelector(`input[data-habit-id="${habit.id}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                });
            }
        }

        function addHabit() {
            const habitName = prompt('請輸入新習慣名稱：');
            if (!habitName || !habitName.trim()) return;

            const habit = {
                id: Date.now(),
                name: habitName.trim(),
                created: new Date().toISOString().split('T')[0]
            };

            appData.habits.push(habit);
            saveData();
            updateHabitsDisplay();
            updateHabitsStats();
            showSuccessMessage('習慣已新增！');
        }

        function updateHabitsDisplay() {
            const container = document.getElementById('habitsContainer');
    
            if (appData.habits.length === 0) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">尚未建立習慣項目</p>';
                return;
            }

            container.innerHTML = appData.habits.map(habit => {
                const streak = calculateHabitStreak(habit.id);
                return `
                    <div class="habit-item">
                        <input type="checkbox" class="habit-checkbox" data-habit-id="${habit.id}">
                        <span class="habit-name">${habit.name}</span>
                        <span class="habit-streak">${streak}天</span>
                        <button onclick="deleteHabit(${habit.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">刪除</button>
                    </div>
                `;
            }).join('');
        }

        function deleteHabit(habitId) {
            if (!confirm('確定要刪除這個習慣嗎？')) return;
    
            appData.habits = appData.habits.filter(habit => habit.id !== habitId);
            saveData();
            updateHabitsDisplay();
            updateHabitsStats();
            showSuccessMessage('習慣已刪除！');
        }

        function calculateHabitStreak(habitId) {
            let streak = 0;
            const today = new Date();
    
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
        
                const diary = appData.diary.find(d => d.date === dateStr);
                if (diary && diary.habits && diary.habits[habitId]) {
                    streak++;
                } else {
                    break;
                }
            }
    
            return streak;
        }

        function saveDiary() {
            const date = document.getElementById('diaryDate').value;
            const steps = parseInt(document.getElementById('diarySteps').value) || null;
            const mood = parseInt(document.getElementById('diaryMood').value) || null;
            const content = document.getElementById('diaryContent').value;

            if (!date) {
                alert('請選擇日期');
                return;
            }

            // 收集習慣完成狀態
            const habits = {};
            appData.habits.forEach(habit => {
                const checkbox = document.querySelector(`input[data-habit-id="${habit.id}"]`);
                if (checkbox) {
                    habits[habit.id] = checkbox.checked;
                }
            });

            // 查找是否已有該日期的記錄
            const existingIndex = appData.diary.findIndex(d => d.date === date);
    
            const diaryRecord = {
                id: existingIndex >= 0 ? appData.diary[existingIndex].id : Date.now(),
                date,
                steps,
                mood,
                habits,
                content,
                pomodoroCount: appData.pomodoro.completedToday || 0,
                created: existingIndex >= 0 ? appData.diary[existingIndex].created : new Date().toISOString(),
                updated: new Date().toISOString()
            };

            if (existingIndex >= 0) {
                appData.diary[existingIndex] = diaryRecord;
            } else {
                appData.diary.unshift(diaryRecord);
            }

            saveData();
            updateDiaryList();
            updateHabitsStats();
            showSuccessMessage('日誌記錄已儲存！');
        }

        function updateHabitsStats() {
            const container = document.getElementById('habitsStats');
    
            if (appData.habits.length === 0) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">尚未建立習慣統計</p>';
                return;
            }

            container.innerHTML = appData.habits.map(habit => {
                const streak = calculateHabitStreak(habit.id);
        
                return `
                    <div class="stat-card">
                        <div class="stat-value">${streak}</div>
                        <div class="stat-label">${habit.name}連續天數</div>
                    </div>
                `;
            }).join('');
        }

        function setDiaryFilter(range) {
            filters.diary = range;
            updateDiaryList();
        }

        function updateDiaryList() {
            const container = document.getElementById('diaryList');
            const countElement = document.getElementById('diaryCount');
    
            let filteredDiary = filterRecordsByDate(
                appData.diary, 
                filters.diary, 
                null, 
                null
            );
    
            countElement.textContent = filteredDiary.length;
    
            if (filteredDiary.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">此時間範圍內無日誌記錄</p>';
                return;
            }

            container.innerHTML = filteredDiary.map(diary => {
                const moodText = getMoodText(diary.mood);
                const completedHabits = appData.habits.filter(habit => diary.habits && diary.habits[habit.id]);
        
                return `
                    <div class="diary-entry">
                        <div class="diary-header">
                            <span class="diary-date">${diary.date}</span>
                            ${diary.mood ? `<span class="diary-mood mood-${diary.mood}">${moodText}</span>` : ''}
                        </div>
                
                        ${diary.content ? `<div class="diary-content">${diary.content}</div>` : ''}
                
                        ${completedHabits.length > 0 ? `
                            <div class="diary-habits">
                                ${completedHabits.map(habit => `<span class="diary-habit-tag completed">${habit.name}</span>`).join('')}
                            </div>
                        ` : ''}
                
                        <div class="diary-stats">
                            ${diary.steps ? `<span>📱 ${diary.steps} 步</span>` : ''}
                            <span>✅ ${completedHabits.length}/${appData.habits.length} 習慣</span>
                        </div>
                
                        <button class="delete-btn" onclick="deleteRecord('diary', ${diary.id})">刪除</button>
                    </div>
                `;
            }).join('');
        }

        function getMoodText(mood) {
            const moods = {
                5: '😄 非常好',
                4: '😊 很好',
                3: '😐 普通',
                2: '😔 不太好',
                1: '😞 很糟'
            };
            return moods[mood] || '';
        }

        // 統計函數
        function updateWeightStats() {
            if (appData.weights.length === 0) {
                document.getElementById('avgWeight').textContent = '--';
                document.getElementById('latestBMI').textContent = '--';
                document.getElementById('weightChange').textContent = '--';
                document.getElementById('weightAdvice').style.display = 'none';
                return;
            }

            const avgWeight = (appData.weights.reduce((sum, w) => sum + w.weight, 0) / appData.weights.length).toFixed(1);
            document.getElementById('avgWeight').textContent = avgWeight + ' kg';

            const latestWithBMI = appData.weights.find(w => w.bmi);
            if (latestWithBMI) {
                document.getElementById('latestBMI').textContent = latestWithBMI.bmi;
                
                const bmi = latestWithBMI.bmi;
                let advice = '';
                if (bmi < 18.5) {
                    advice = '您的 BMI 偏低，建議增加營養攝取並諮詢醫師。';
                } else if (bmi >= 18.5 && bmi < 24) {
                    advice = '您的 BMI 在正常範圍內，請保持健康的生活方式。';
                } else if (bmi >= 24 && bmi < 27) {
                    advice = '您的 BMI 稍微偏高，建議適度運動和均衡飲食。';
                } else {
                    advice = '您的 BMI 過高，建議諮詢醫師制定減重計畫。';
                }
                
                document.getElementById('weightAdviceContent').textContent = advice;
                document.getElementById('weightAdvice').style.display = 'block';
            } else {
                document.getElementById('latestBMI').textContent = '--';
                document.getElementById('weightAdvice').style.display = 'none';
            }

            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthWeights = appData.weights.filter(w => w.date.startsWith(thisMonth));
            
            if (thisMonthWeights.length >= 2) {
                const latest = thisMonthWeights[0].weight;
                const earliest = thisMonthWeights[thisMonthWeights.length - 1].weight;
                const change = (latest - earliest).toFixed(1);
                const changeText = change > 0 ? `+${change}` : change;
                document.getElementById('weightChange').textContent = changeText + ' kg';
            } else {
                document.getElementById('weightChange').textContent = '--';
            }
        }

        function updateBPStats() {
            if (appData.bloodPressure.length === 0) {
                document.getElementById('avgSystolic').textContent = '--';
                document.getElementById('avgDiastolic').textContent = '--';
                document.getElementById('avgPulse').textContent = '--';
                document.getElementById('bpAdvice').style.display = 'none';
                return;
            }

            const avgSystolic = Math.round(appData.bloodPressure.reduce((sum, bp) => sum + bp.systolic, 0) / appData.bloodPressure.length);
            const avgDiastolic = Math.round(appData.bloodPressure.reduce((sum, bp) => sum + bp.diastolic, 0) / appData.bloodPressure.length);
            
            document.getElementById('avgSystolic').textContent = avgSystolic;
            document.getElementById('avgDiastolic').textContent = avgDiastolic;

            const pulseBPs = appData.bloodPressure.filter(bp => bp.pulse);
            if (pulseBPs.length > 0) {
                const avgPulse = Math.round(pulseBPs.reduce((sum, bp) => sum + bp.pulse, 0) / pulseBPs.length);
                document.getElementById('avgPulse').textContent = avgPulse;
            } else {
                document.getElementById('avgPulse').textContent = '--';
            }

            let advice = '';
            if (avgSystolic < 120 && avgDiastolic < 80) {
                advice = '您的血壓在理想範圍內，請保持健康的生活方式。';
            } else if (avgSystolic <= 139 && avgDiastolic <= 89) {
                advice = '您的血壓稍微偏高，建議減少鹽分攝取、多運動，並定期監測。';
            } else {
                advice = '您的血壓偏高，建議盡快諮詢醫師，並遵循醫師指示。';
            }
            
            document.getElementById('bpAdviceContent').textContent = advice;
            document.getElementById('bpAdvice').style.display = 'block';
        }

        function updateExerciseStats() {
            if (appData.exercises.length === 0) {
                document.getElementById('weeklyExercises').textContent = '0';
                document.getElementById('weeklyDuration').textContent = '0';
                document.getElementById('weeklyCalories').textContent = '0';
                document.getElementById('exerciseStreak').textContent = '0';
                document.getElementById('exerciseAdvice').style.display = 'none';
                return;
            }

            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            
            const thisWeekExercises = appData.exercises.filter(ex => {
                const exerciseDate = new Date(ex.date);
                return exerciseDate >= weekStart;
            });

            document.getElementById('weeklyExercises').textContent = thisWeekExercises.length;

            const weeklyDuration = thisWeekExercises.reduce((sum, ex) => sum + ex.duration, 0);
            document.getElementById('weeklyDuration').textContent = weeklyDuration;

            const weeklyCalories = thisWeekExercises.reduce((sum, ex) => sum + (ex.calories || 0), 0);
            document.getElementById('weeklyCalories').textContent = weeklyCalories;

            const sortedDates = [...new Set(appData.exercises.map(ex => ex.date))].sort().reverse();
            let streak = 0;
            
            for (let i = 0; i < sortedDates.length; i++) {
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                const expectedDateStr = expectedDate.toISOString().split('T')[0];
                
                if (sortedDates[i] === expectedDateStr) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('exerciseStreak').textContent = streak;

            let advice = '';
            if (weeklyDuration < 150) {
                advice = '建議每週至少運動 150 分鐘。試著增加運動頻率，您目前還需要 ' + (150 - weeklyDuration) + ' 分鐘！';
            } else if (weeklyDuration >= 150 && weeklyDuration < 300) {
                advice = '很好！您已達到基本運動建議。如果想要更好的健康效果，可以增加到每週 300 分鐘。';
            } else {
                advice = '太棒了！您的運動量超過建議標準，請保持這個好習慣，注意適度休息避免過度訓練。';
            }
            
            if (streak >= 7) {
                advice += ` 連續運動 ${streak} 天真是太厲害了！`;
            } else if (streak >= 3) {
                advice += ` 連續 ${streak} 天運動，保持下去！`;
            }
            
            document.getElementById('exerciseAdviceContent').textContent = advice;
            document.getElementById('exerciseAdvice').style.display = 'block';
        }

        function updateStats() {
            document.getElementById('totalExpenses').textContent = appData.expenses.length;
            document.getElementById('totalWeight').textContent = appData.weights.length;
            document.getElementById('totalBP').textContent = appData.bloodPressure.length;
            document.getElementById('totalExercise').textContent = appData.exercises.length;
            
            const dataSize = new Blob([JSON.stringify(appData)]).size;
            const sizeKB = (dataSize / 1024).toFixed(1);
            document.getElementById('dataSize').textContent = sizeKB + ' KB';
        }

        // 基本資料相關函數
        function saveProfile() {
            const name = document.getElementById('profileName').value;
            const birthday = document.getElementById('profileBirthday').value;
            const gender = document.getElementById('profileGender').value;
            const height = parseFloat(document.getElementById('profileHeight').value);
            const activity = document.getElementById('profileActivity').value;

            appData.profile = {
                name,
                birthday,
                gender,
                height,
                activity
            };

            saveData();
            updateProfileDisplay();
            showSuccessMessage('基本資料已儲存！');
        }

        function loadProfile() {
            if (appData.profile) {
                document.getElementById('profileName').value = appData.profile.name || '';
                document.getElementById('profileBirthday').value = appData.profile.birthday || '';
                document.getElementById('profileGender').value = appData.profile.gender || '';
                document.getElementById('profileHeight').value = appData.profile.height || '';
                document.getElementById('profileActivity').value = appData.profile.activity || 'light';
                
                updateProfileDisplay();
            }
        }

        function updateProfileDisplay() {
            const profile = appData.profile;
            
            if (profile.birthday) {
                const today = new Date();
                const birthDate = new Date(profile.birthday);
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                const finalAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate()) ? age - 1 : age;
                document.getElementById('displayAge').textContent = finalAge + ' 歲';
            } else {
                document.getElementById('displayAge').textContent = '--';
            }

            if (appData.weights.length > 0 && profile.height) {
                const latestWeight = appData.weights[0];
                const bmi = (latestWeight.weight / ((profile.height / 100) ** 2)).toFixed(1);
                document.getElementById('displayBMI').textContent = bmi;
            } else {
                document.getElementById('displayBMI').textContent = '--';
            }

            if (profile.height) {
                const heightM = profile.height / 100;
                const minWeight = (18.5 * heightM * heightM).toFixed(1);
                const maxWeight = (24 * heightM * heightM).toFixed(1);
                document.getElementById('displayTargetWeight').textContent = `${minWeight}-${maxWeight} kg`;
            } else {
                document.getElementById('displayTargetWeight').textContent = '--';
            }

            if (profile.height && profile.gender && appData.weights.length > 0) {
                const weight = appData.weights[0].weight;
                const age = profile.birthday ? new Date().getFullYear() - new Date(profile.birthday).getFullYear() : 30;
                
                let bmr;
                if (profile.gender === 'male') {
                    bmr = 10 * weight + 6.25 * profile.height - 5 * age + 5;
                } else {
                    bmr = 10 * weight + 6.25 * profile.height - 5 * age - 161;
                }

                const activityMultipliers = {
                    'sedentary': 1.2,
                    'light': 1.375,
                    'moderate': 1.55,
                    'active': 1.725,
                    'very_active': 1.9
                };

                const tdee = Math.round(bmr * activityMultipliers[profile.activity]);
                document.getElementById('displayDailyCalories').textContent = tdee + ' 卡';
            } else {
                document.getElementById('displayDailyCalories').textContent = '--';
            }

            if (profile.height && profile.gender && appData.weights.length > 0) {
                let advice = [];
                
                const latestWeight = appData.weights[0].weight;
                const bmi = latestWeight / ((profile.height / 100) ** 2);
                
                if (bmi < 18.5) {
                    advice.push('您的 BMI 偏低，建議增加營養攝取。');
                } else if (bmi >= 18.5 && bmi < 24) {
                    advice.push('您的 BMI 在理想範圍內，請保持目前的健康習慣。');
                } else if (bmi >= 24 && bmi < 27) {
                    advice.push('您的 BMI 稍微偏高，建議控制飲食並增加運動。');
                } else {
                    advice.push('您的 BMI 過高，建議諮詢營養師制定減重計畫。');
                }

                const age = profile.birthday ? new Date().getFullYear() - new Date(profile.birthday).getFullYear() : null;
                if (age) {
                    if (age >= 65) {
                        advice.push('建議進行適度的有氧運動和阻力訓練，注意平衡訓練預防跌倒。');
                    } else if (age >= 40) {
                        advice.push('建議每週至少 150 分鐘中等強度運動，包含肌力訓練。');
                    } else {
                        advice.push('年輕就是本錢！建議養成規律運動習慣，為未來健康打基礎。');
                    }
                }

                const weeklyExercises = appData.exercises.filter(ex => {
                    const exerciseDate = new Date(ex.date);
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    return exerciseDate >= weekStart;
                });

                if (weeklyExercises.length < 3) {
                    advice.push('建議每週至少運動 3 次，每次 30 分鐘以上。');
                }

                if (advice.length > 0) {
                    document.getElementById('profileAdviceContent').innerHTML = advice.join('<br>');
                    document.getElementById('profileAdvice').style.display = 'block';
                } else {
                    document.getElementById('profileAdvice').style.display = 'none';
                }
            } else {
                document.getElementById('profileAdvice').style.display = 'none';
            }
        }

        // 刪除記錄
        function deleteRecord(type, id) {
            if (!confirm('確定要刪除這筆記錄嗎？')) return;
            
            appData[type] = appData[type].filter(record => record.id !== id);
            saveData();
            updateAllDisplays();
            showSuccessMessage('記錄已刪除！');
        }

        // 更新所有顯示
        function updateAllDisplays() {
            updateExpensesList();
            updateWeightsList();
            updateBPList();
            updateExercisesList();
            updateTasksList();
            updateCompletedTasksList();
            updateDiaryList();
            updateWeightStats();
            updateBPStats();
            updateExerciseStats();
            updateHabitsDisplay();
            updateHabitsStats();
            updateStats();
            updateProfileDisplay();
            updateAllCharts();
        }

        // 匯出功能
        function exportData(format = 'json') {
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (format === 'json') {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `daily_tracker_backup_${timestamp}.json`;
                link.click();
                
                showSuccessMessage('JSON 數據匯出完成！');
            } else if (format === 'csv') {
                exportCSV(timestamp);
            }
        }

        function exportCSV(timestamp) {
            const csvContent = [];
            
            if (appData.profile && (appData.profile.name || appData.profile.birthday)) {
                csvContent.push('=== 基本資料 ===');
                csvContent.push('項目,內容');
                csvContent.push(`姓名,${appData.profile.name || ''}`);
                csvContent.push(`生日,${appData.profile.birthday || ''}`);
                csvContent.push(`性別,${appData.profile.gender === 'male' ? '男性' : appData.profile.gender === 'female' ? '女性' : ''}`);
                csvContent.push(`身高,${appData.profile.height || ''}`);
                csvContent.push(`活動量,${appData.profile.activity || ''}`);
                csvContent.push('');
            }

            if (appData.expenses.length > 0) {
                csvContent.push('=== 支出記錄 ===');
                csvContent.push('日期,分類,項目,金額,備註');
                appData.expenses.forEach(expense => {
                    csvContent.push(`${expense.date},${expense.category},${expense.item},${expense.amount},"${expense.note || ''}"`);
                });
                csvContent.push('');
            }

            if (appData.weights.length > 0) {
                csvContent.push('=== 體重記錄 ===');
                csvContent.push('日期,時間,體重(kg),腰圍(cm),身高(cm),BMI');
                appData.weights.forEach(weight => {
                    csvContent.push(`${weight.date},${weight.time},${weight.weight},${weight.waist || ''},${weight.height || ''},${weight.bmi || ''}`);
                });
                csvContent.push('');
            }

            if (appData.bloodPressure.length > 0) {
                csvContent.push('=== 血壓記錄 ===');
                csvContent.push('日期,時間,收縮壓(mmHg),舒張壓(mmHg),脈搏(次/分)');
                appData.bloodPressure.forEach(bp => {
                    csvContent.push(`${bp.date},${bp.time},${bp.systolic},${bp.diastolic},${bp.pulse || ''}`);
                });
                csvContent.push('');
            }

            if (appData.exercises.length > 0) {
                csvContent.push('=== 運動記錄 ===');
                csvContent.push('日期,開始時間,運動類型,時長(分鐘),消耗卡路里,強度,備註');
                appData.exercises.forEach(exercise => {
                    csvContent.push(`${exercise.date},${exercise.startTime},${exercise.type},${exercise.duration},${exercise.calories || ''},${exercise.intensity},"${exercise.note || ''}"`);
                });
                csvContent.push('');
            }

            if (appData.tasks.length > 0) {
                csvContent.push('=== 例行任務 ===');
                csvContent.push('任務名稱,下次到期日,重複間隔,優先級,備註,建立日期');
                appData.tasks.forEach(task => {
                    const taskNote = (task.note || '').replace(/"/g, '""');
                    csvContent.push(`${task.name},${task.nextDate},${task.interval},${task.priority},"${taskNote}",${task.created}`);
                });
                csvContent.push('');
            }

            if (appData.completedTasks.length > 0) {
                csvContent.push('=== 已完成任務記錄 ===');
                csvContent.push('任務名稱,完成日期,完成時間,重複間隔,優先級,備註');
                appData.completedTasks.forEach(task => {
                    csvContent.push(`${task.name},${task.completedDate},${task.completedTime},${task.interval},${task.priority},"${task.note || ''}"`);
                });
                csvContent.push('');
            }

            if (appData.habits.length > 0) {
                csvContent.push('=== 習慣列表 ===');
                csvContent.push('習慣名稱,建立日期');
                appData.habits.forEach(habit => {
                    csvContent.push(`${habit.name},${habit.created}`);
                });
                csvContent.push('');
            }

            if (appData.diary.length > 0) {
                csvContent.push('=== 日誌記錄 ===');
                csvContent.push('日期,步數,心情評分,日誌內容,完成習慣數,習慣詳情');
                appData.diary.forEach(diary => {
                    const completedHabits = appData.habits.filter(habit => diary.habits && diary.habits[habit.id]);
                    const habitsDetail = completedHabits.map(h => h.name).join(';');
                    const content = (diary.content || '').replace(/"/g, '""'); // 處理雙引號
                    csvContent.push(`${diary.date},${diary.steps || ''},${diary.mood || ''},"${content}",${completedHabits.length},"${habitsDetail}"`);
                });
                csvContent.push('');
            }

            csvContent.push('=== 數據統計 ===');
            csvContent.push('類型,記錄數量');
            csvContent.push(`支出記錄,${appData.expenses.length}`);
            csvContent.push(`體重記錄,${appData.weights.length}`);
            csvContent.push(`血壓記錄,${appData.bloodPressure.length}`);
            csvContent.push(`運動記錄,${appData.exercises.length}`);
            csvContent.push(`例行任務,${appData.tasks.length}`);
            csvContent.push(`已完成任務,${appData.completedTasks.length}`);
            csvContent.push(`習慣項目,${appData.habits.length}`);
            csvContent.push(`日誌記錄,${appData.diary.length}`);
            csvContent.push(`匯出日期,${timestamp}`);

            const csvString = csvContent.join('\n');
            const BOM = '\uFEFF';
            const dataBlob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `daily_tracker_data_${timestamp}.csv`;
            link.click();
            
            showSuccessMessage('CSV 數據匯出完成！');
        }

        function exportSingleCSV(type) {
            const timestamp = new Date().toISOString().split('T')[0];
            let csvContent = [];
            let filename = '';

            switch(type) {
                case 'expenses':
                    csvContent.push('日期,分類,項目,金額,備註');
                    appData.expenses.forEach(expense => {
                        const expenseNote = (expense.note || '').replace(/"/g, '""');
                        csvContent.push(`${expense.date},${expense.category},${expense.item},${expense.amount},"${expenseNote}"`);
                    });
                    filename = `expenses_${timestamp}.csv`;
                    break;

                case 'weights':
                    csvContent.push('日期,時間,體重(kg),腰圍(cm),身高(cm),BMI');
                    appData.weights.forEach(weight => {
                        csvContent.push(`${weight.date},${weight.time},${weight.weight},${weight.waist || ''},${weight.height || ''},${weight.bmi || ''}`);
                    });
                    filename = `weights_${timestamp}.csv`;
                    break;

                case 'bloodPressure':
                    csvContent.push('日期,時間,收縮壓(mmHg),舒張壓(mmHg),脈搏(次/分)');
                    appData.bloodPressure.forEach(bp => {
                        csvContent.push(`${bp.date},${bp.time},${bp.systolic},${bp.diastolic},${bp.pulse || ''}`);
                    });
                    filename = `blood_pressure_${timestamp}.csv`;
                    break;

                case 'exercises':
                    csvContent.push('日期,開始時間,運動類型,時長(分鐘),消耗卡路里,強度,備註');
                    appData.exercises.forEach(exercise => {
                        const exerciseNote = (exercise.note || '').replace(/"/g, '""');
                        csvContent.push(`${exercise.date},${exercise.startTime},${exercise.type},${exercise.duration},${exercise.calories || ''},${exercise.intensity},"${exerciseNote}"`);
                    });
                    filename = `exercises_${timestamp}.csv`;
                    break;

                case 'tasks':
                    csvContent.push('任務名稱,下次到期日,重複間隔,優先級,備註,建立日期');
                    appData.tasks.forEach(task => {
                        csvContent.push(`${task.name},${task.nextDate},${task.interval},${task.priority},"${task.note || ''}",${task.created}`);
                    });
                    filename = `tasks_${timestamp}.csv`;
                    break;

                case 'diary':
                    csvContent.push('日期,步數,心情評分,日誌內容,完成習慣數,習慣詳情');
                    appData.diary.forEach(diary => {
                        const completedHabits = appData.habits.filter(habit => diary.habits && diary.habits[habit.id]);
                        const habitsDetail = completedHabits.map(h => h.name).join(';');
                        csvContent.push(`${diary.date},${diary.steps || ''},${diary.mood || ''},"${diary.content || ''}",${completedHabits.length},"${habitsDetail}"`);
                    });
                    filename = `diary_${timestamp}.csv`;
                    break;
            }

            if (csvContent.length <= 1) {
                alert('沒有數據可以匯出');
                return;
            }

            const csvString = csvContent.join('\n');
            const BOM = '\uFEFF';
            const dataBlob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            showSuccessMessage('CSV 匯出完成！');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('匯入數據將覆蓋現有數據，確定要繼續嗎？')) {
                        appData = importedData;
                        saveData();
                        updateAllDisplays();
                        loadProfile();
                        showSuccessMessage('數據匯入成功！');
                    }
                } catch (error) {
                    alert('匯入失敗：文件格式不正確');
                }
            };
            reader.readAsText(file);
            
            input.value = '';
        }

        function clearAllData() {
            if (!confirm('確定要清除所有數據嗎？此操作無法復原！')) return;
            
            appData = {
                expenses: [],
                weights: [],
                bloodPressure: [],
                exercises: [],
                tasks: [],
                completedTasks: [],
                diary: [],
                habits: [],
                profile: {
                    name: '',
                    birthday: '',
                    gender: '',
                    height: '',
                    activity: 'light'
                }
            };
            
            saveData();
            updateAllDisplays();
            loadProfile();
            showSuccessMessage('所有數據已清除！');
        }

        function clearTestData() {
            if (!confirm('確定要清除測試數據並重新載入範例嗎？')) return;
            
            try {
                localStorage.removeItem('dailyTrackerData');
                location.reload(); // 重新載入頁面以載入新的範例數據
            } catch (error) {
                console.error('清除數據失敗:', error);
            }
        }

        // PWA 功能
        let deferredPrompt;

        function setupPWAInstall() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'inline-block';
            });
        }

        setTimeout(() => {
            updateAllCharts();
        }, 500);

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showSuccessMessage('應用安裝成功！');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                });
            }
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 500;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 圖表相關變數
        let chartFilter = 'week';
        let charts = {};

        // 圖表時間區間設定
        function setChartFilter(range) {
            chartFilter = range;
    
            // 更新按鈕狀態
            document.querySelectorAll('#charts .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
    
            // 更新顯示文字
            const rangeTexts = {
                'week': '近七日',
                'month': '近一個月', 
                'quarter': '近三個月',
                'half-year': '近半年',
                'year': '近一年',
                'all': '全部數據'
            };
    
            document.getElementById('chartRangeText').textContent = rangeTexts[range];
            document.getElementById('chartUpdateTime').textContent = new Date().toLocaleString();
    
            // 重新渲染所有圖表
            updateAllCharts();
        }

        // 獲取圖表數據的時間範圍
        function getChartDateRange(range) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
            switch(range) {
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return { start: weekAgo, end: today };
            
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return { start: monthAgo, end: today };
            
                case 'quarter':
                    const quarterAgo = new Date(today);
                    quarterAgo.setMonth(quarterAgo.getMonth() - 3);
                    return { start: quarterAgo, end: today };
            
                case 'half-year':
                    const halfYearAgo = new Date(today);
                    halfYearAgo.setMonth(halfYearAgo.getMonth() - 6);
                    return { start: halfYearAgo, end: today };
            
                case 'year':
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                    return { start: yearAgo, end: today };
            
                default: // 'all'
                    return { start: null, end: null };
            }
        }

        // 根據時間範圍過濾數據
        function filterDataByChartRange(records, range) {
            if (range === 'all') return records;
    
            const dateRange = getChartDateRange(range);
            if (!dateRange.start || !dateRange.end) return records;
    
            return records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= dateRange.start && recordDate <= dateRange.end;
            });
        }

        // 更新所有圖表
        function updateAllCharts() {
            updateExpenseChart();
            updateWeightChart();
            updateBPChart();
            updateExerciseChart();
            updateTaskChart();
            updateHabitChart();
        }

        // 支出分類圓餅圖
        function updateExpenseChart() {
            const filteredExpenses = filterDataByChartRange(appData.expenses, chartFilter);
    
            if (filteredExpenses.length === 0) {
                showEmptyChart('expenseChart', '此時間範圍內無支出數據');
                document.getElementById('expenseChartStats').innerHTML = '';
                return;
            }

            // 按分類統計支出
            const categoryData = {};
            let totalAmount = 0;
    
            filteredExpenses.forEach(expense => {
                if (!categoryData[expense.category]) {
                    categoryData[expense.category] = 0;
                }
                categoryData[expense.category] += expense.amount;
                totalAmount += expense.amount;
            });

            const labels = Object.keys(categoryData);
            const amounts = Object.values(categoryData);
            const colors = ['#8b5cf6', '#06d6a0', '#f72585', '#4cc9f0', '#f77f00', '#fcbf49'];

            const ctx = document.getElementById('expenseChart').getContext('2d');
    
            if (charts.expense) {
                charts.expense.destroy();
            }
    
            charts.expense = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // 顯示統計數據
            const statsHTML = labels.map((label, index) => {
                const percentage = ((amounts[index] / totalAmount) * 100).toFixed(1);
                return `
                    <div style="text-align: center; padding: 10px; background: ${colors[index]}20; border-radius: 8px;">
                        <div style="font-weight: 600; color: ${colors[index]};">${label}</div>
                        <div style="font-size: 0.9rem;">NT$ ${amounts[index]}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">${percentage}%</div>
                    </div>
                `;
            }).join('');
    
            document.getElementById('expenseChartStats').innerHTML = statsHTML;
        }

        // 體重變化趨勢線圖
        function updateWeightChart() {
            const filteredWeights = filterDataByChartRange(appData.weights, chartFilter);
    
            if (filteredWeights.length === 0) {
                showEmptyChart('weightChart', '此時間範圍內無體重數據');
                document.getElementById('weightChartStats').innerHTML = '';
                return;
            }

            // 按日期排序
            const sortedWeights = filteredWeights.sort((a, b) => new Date(a.date) - new Date(b.date));
    
            const labels = sortedWeights.map(w => w.date);
            const weights = sortedWeights.map(w => w.weight);
            const bmis = sortedWeights.map(w => w.bmi).filter(bmi => bmi);

            const ctx = document.getElementById('weightChart').getContext('2d');
    
            if (charts.weight) {
                charts.weight.destroy();
            }
    
            charts.weight = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '體重 (kg)',
                        data: weights,
                        borderColor: '#8b5cf6',
                        backgroundColor: '#8b5cf620',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '體重 (kg)'
                            }
                        }
                    }
                }
            });

            // 顯示統計
            const avgWeight = (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1);
            const weightChange = weights.length > 1 ? (weights[weights.length - 1] - weights[0]).toFixed(1) : '0';
            const avgBMI = bmis.length > 0 ? (bmis.reduce((a, b) => a + b, 0) / bmis.length).toFixed(1) : '--';
    
            document.getElementById('weightChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgWeight} kg</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">平均體重</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: ${weightChange > 0 ? '#ef4444' : '#10b981'};">${weightChange > 0 ? '+' : ''}${weightChange} kg</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">期間變化</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgBMI}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">平均 BMI</div>
                    </div>
                </div>
            `;
        }

        // 血壓監控圖表（早晚分別顯示）
        function updateBPChart() {
            const filteredBP = filterDataByChartRange(appData.bloodPressure, chartFilter);
    
            if (filteredBP.length === 0) {
                showEmptyChart('bpChart', '此時間範圍內無血壓數據');
                document.getElementById('bpChartStats').innerHTML = '';
                return;
            }

            // 按日期排序
            const sortedBP = filteredBP.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
    
            // 分早上（06:00-12:00）和晚上（18:00-23:59）
            const morningBP = sortedBP.filter(bp => {
                const hour = parseInt(bp.time.split(':')[0]);
                return hour >= 6 && hour < 12;
            });
    
            const eveningBP = sortedBP.filter(bp => {
                const hour = parseInt(bp.time.split(':')[0]);
                return hour >= 18 && hour < 24;
            });

            // 準備圖表數據
            const allDates = [...new Set(sortedBP.map(bp => bp.date))].sort();
    
            const morningSystolic = allDates.map(date => {
                const dayData = morningBP.find(bp => bp.date === date);
                return dayData ? dayData.systolic : null;
            });
    
            const morningDiastolic = allDates.map(date => {
                const dayData = morningBP.find(bp => bp.date === date);
                return dayData ? dayData.diastolic : null;
            });
    
            const eveningSystolic = allDates.map(date => {
                const dayData = eveningBP.find(bp => bp.date === date);
                return dayData ? dayData.systolic : null;
            });
    
            const eveningDiastolic = allDates.map(date => {
                const dayData = eveningBP.find(bp => bp.date === date);
                return dayData ? dayData.diastolic : null;
            });

            const ctx = document.getElementById('bpChart').getContext('2d');
    
            if (charts.bp) {
                charts.bp.destroy();
            }
    
            charts.bp = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [
                        {
                            label: '早上收縮壓',
                            data: morningSystolic,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef444420',
                            borderWidth: 2,
                            borderDash: [],
                            tension: 0.4
                        },
                        {
                            label: '早上舒張壓', 
                            data: morningDiastolic,
                            borderColor: '#f97316',
                            backgroundColor: '#f9731620',
                            borderWidth: 2,
                            borderDash: [],
                            tension: 0.4
                        },
                        {
                            label: '晚上收縮壓',
                            data: eveningSystolic,
                            borderColor: '#8b5cf6',
                            backgroundColor: '#8b5cf620',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        },
                        {
                            label: '晚上舒張壓',
                            data: eveningDiastolic,
                            borderColor: '#06d6a0',
                            backgroundColor: '#06d6a020',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '血壓 (mmHg)'
                            },
                            min: 40,
                            max: 180
                        }
                    }
                }
            });

            // 計算統計數據
            const allSystolic = sortedBP.map(bp => bp.systolic);
            const allDiastolic = sortedBP.map(bp => bp.diastolic);
            const avgSystolic = Math.round(allSystolic.reduce((a, b) => a + b, 0) / allSystolic.length);
            const avgDiastolic = Math.round(allDiastolic.reduce((a, b) => a + b, 0) / allDiastolic.length);
    
            const morningAvgSys = morningBP.length > 0 ? Math.round(morningBP.reduce((sum, bp) => sum + bp.systolic, 0) / morningBP.length) : '--';
            const eveningAvgSys = eveningBP.length > 0 ? Math.round(eveningBP.reduce((sum, bp) => sum + bp.systolic, 0) / eveningBP.length) : '--';
    
            document.getElementById('bpChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgSystolic}/${avgDiastolic}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">整體平均</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">${morningAvgSys}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">早上平均收縮壓</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${eveningAvgSys}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">晚上平均收縮壓</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">${sortedBP.length}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">測量次數</div>
                    </div>
                </div>
            `;
        }

        // 運動統計圖表
        function updateExerciseChart() {
            const filteredExercises = filterDataByChartRange(appData.exercises, chartFilter);
    
            if (filteredExercises.length === 0) {
                showEmptyChart('exerciseChart', '此時間範圍內無運動數據');
                document.getElementById('exerciseChartStats').innerHTML = '';
                return;
            }

            // 按運動類型統計時長
            const typeData = {};
            let totalDuration = 0;
            let totalCalories = 0;
    
            filteredExercises.forEach(exercise => {
                if (!typeData[exercise.type]) {
                    typeData[exercise.type] = { duration: 0, calories: 0, count: 0 };
                }
                typeData[exercise.type].duration += exercise.duration;
                typeData[exercise.type].calories += exercise.calories || 0;
                typeData[exercise.type].count += 1;
                totalDuration += exercise.duration;
                totalCalories += exercise.calories || 0;
            });

            const labels = Object.keys(typeData);
            const durations = Object.values(typeData).map(data => data.duration);
            const colors = ['#8b5cf6', '#06d6a0', '#f72585', '#4cc9f0', '#f77f00', '#fcbf49', '#c77dff', '#7209b7'];

            const ctx = document.getElementById('exerciseChart').getContext('2d');
    
            if (charts.exercise) {
                charts.exercise.destroy();
            }
    
            charts.exercise = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '運動時長 (分鐘)',
                        data: durations,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '時長 (分鐘)'
                            }
                        }
                    }
                }
            });

            document.getElementById('exerciseChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${totalDuration}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">總運動時長 (分)</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #f77f00;">${totalCalories}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">總消耗卡路里</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #06d6a0;">${filteredExercises.length}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">運動次數</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #f72585;">${Math.round(totalDuration / filteredExercises.length)}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">平均時長 (分)</div>
                    </div>
                </div>
            `;
        }

        // 任務完成率統計
        function updateTaskChart() {
            const dateRange = getChartDateRange(chartFilter);
            let filteredCompletedTasks;
    
            if (chartFilter === 'all') {
                filteredCompletedTasks = appData.completedTasks;
            } else {
                filteredCompletedTasks = appData.completedTasks.filter(task => {
                    const taskDate = new Date(task.completedDate);
                    return taskDate >= dateRange.start && taskDate <= dateRange.end;
                });
            }
    
            if (filteredCompletedTasks.length === 0) {
                showEmptyChart('taskChart', '此時間範圍內無完成任務數據');
                document.getElementById('taskChartStats').innerHTML = '';
                return;
            }

            // 按優先級統計
            const priorityData = { high: 0, medium: 0, low: 0 };
            filteredCompletedTasks.forEach(task => {
                priorityData[task.priority]++;
            });

            const labels = ['高優先級', '中優先級', '低優先級'];
            const counts = [priorityData.high, priorityData.medium, priorityData.low];
            const colors = ['#ef4444', '#f59e0b', '#10b981'];

            const ctx = document.getElementById('taskChart').getContext('2d');
    
            if (charts.task) {
                charts.task.destroy();
            }
    
            charts.task = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // 計算完成率（假設未完成任務也在時間範圍內）
            const totalTasks = appData.tasks.length + filteredCompletedTasks.length;
            const completionRate = totalTasks > 0 ? Math.round((filteredCompletedTasks.length / totalTasks) * 100) : 0;
    
            document.getElementById('taskChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">${filteredCompletedTasks.length}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">已完成任務</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">${priorityData.high}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">高優先級完成</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #0ea5e9;">${completionRate}%</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">完成率</div>
                    </div>
                </div>
            `;
        }

        // 習慣養成分析
        function updateHabitChart() {
            if (appData.habits.length === 0) {
                showEmptyChart('habitChart', '尚未建立習慣項目');
                document.getElementById('habitChartStats').innerHTML = '';
                return;
            }

            const dateRange = getChartDateRange(chartFilter);
            let dateList = [];
    
            if (chartFilter === 'all') {
                // 取所有日誌記錄的日期
                dateList = [...new Set(appData.diary.map(d => d.date))].sort();
            } else {
                // 生成日期範圍內的所有日期
                const start = dateRange.start;
                const end = dateRange.end;
                const current = new Date(start);
        
                while (current <= end) {
                    dateList.push(current.toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }
            }

            // 計算每個習慣的完成率
            const habitData = appData.habits.map(habit => {
                let completedDays = 0;
                let totalDays = 0;
        
                dateList.forEach(date => {
                    const diary = appData.diary.find(d => d.date === date);
                    if (diary) {
                        totalDays++;
                        if (diary.habits && diary.habits[habit.id]) {
                            completedDays++;
                        }
                    }
                });
        
                return {
                    name: habit.name,
                    rate: totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0,
                    completed: completedDays,
                    total: totalDays
                };
            });

            const labels = habitData.map(h => h.name);
            const rates = habitData.map(h => h.rate);
            const colors = ['#8b5cf6', '#06d6a0', '#f72585', '#4cc9f0', '#f77f00', '#fcbf49', '#c77dff', '#7209b7'];

            const ctx = document.getElementById('habitChart').getContext('2d');
    
            if (charts.habit) {
                charts.habit.destroy();
            }
    
            charts.habit = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '完成率 (%)',
                        data: rates,
                        borderColor: '#8b5cf6',
                        backgroundColor: '#8b5cf620',
                        borderWidth: 2,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });

            const avgRate = habitData.length > 0 ? Math.round(rates.reduce((a, b) => a + b, 0) / rates.length) : 0;
            const bestHabit = habitData.reduce((best, current) => current.rate > best.rate ? current : best, habitData[0]);
    
            document.getElementById('habitChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgRate}%</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">平均完成率</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 10px;">
                        <div style="font-size: 1rem; font-weight: 600; color: #10b981;">${bestHabit ? bestHabit.name : '--'}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">表現最佳習慣</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">${bestHabit ? bestHabit.rate : 0}%</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">最高完成率</div>
                    </div>
                </div>
            `;
        }

        // 空圖表顯示函數
        function showEmptyChart(canvasId, message) {
            const ctx = document.getElementById(canvasId).getContext('2d');
    
            if (charts[canvasId.replace('Chart', '')]) {
                charts[canvasId.replace('Chart', '')].destroy();
            }
    
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = '#6b7280';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        // 獲取分類圖示
        function getCategoryIcon(category) {
            const icons = {
                '食物': '🍽️',
                '交通': '🚗',
                '娛樂': '🎬',
                '購物': '🛍️',
                '醫療': '🏥',
                '教育': '📚',
                '規費': '💸',
                '其他': '📝'
            };
            return icons[category] || '📝';
        }

        // 預算設定相關函數
        function saveBudgets() {
            const budgetMapping = {
                budgetFood: '食物',
                budgetTransport: '交通',
                budgetEntertainment: '娛樂',
                budgetShopping: '購物',
                budgetMedical: '醫療',
                budgetEducation: '教育',
                budgetUtilities: '規費',
                budgetOther: '其他'
            };

            Object.keys(budgetMapping).forEach(inputId => {
                const value = parseFloat(document.getElementById(inputId).value);
                if (value && value > 0) {
                    appData.budgets[budgetMapping[inputId]] = value;
                }
            });

            saveData();
            updateMonthlyExpenseOverview();
            showSuccessMessage('預算設定已儲存！');
        }

        function loadBudgets() {
            const budgetMapping = {
                budgetFood: '食物',
                budgetTransport: '交通',
                budgetEntertainment: '娛樂',
                budgetShopping: '購物',
                budgetMedical: '醫療',
                budgetEducation: '教育',
                budgetUtilities: '規費',
                budgetOther: '其他'
            };

            Object.keys(budgetMapping).forEach(inputId => {
                const category = budgetMapping[inputId];
                if (appData.budgets && appData.budgets[category]) {
                    document.getElementById(inputId).value = appData.budgets[category];
                }
            });
        }

        function showBudgetSettings() {
            showSection('settings');
        }

        // 番茄鐘功能函數
        function togglePomodoroPanel() {
            const panel = document.getElementById('pomodoroPanel');
            panel.classList.toggle('show');
        }

        function startPomodoro() {
            if (pomodoroState.isPaused) {
                // 從暫停狀態恢復
                pomodoroState.isPaused = false;
            } else {
                // 開始新的番茄鐘
                const workMinutes = parseInt(document.getElementById('workTime').value) || 25;
                pomodoroState.timeLeft = workMinutes * 60;
                pomodoroState.isBreak = false;
            }
            
            pomodoroState.isRunning = true;
            updatePomodoroButton();
            
            pomodoroState.interval = setInterval(() => {
                pomodoroState.timeLeft--;
                updatePomodoroDisplay();
                
                if (pomodoroState.timeLeft <= 0) {
                    pomodoroComplete();
                }
            }, 1000);
            
            showFocusReminder();
            updatePomodoroDisplay();
        }

        function pausePomodoro() {
            if (pomodoroState.isRunning) {
                pomodoroState.isRunning = false;
                pomodoroState.isPaused = true;
                clearInterval(pomodoroState.interval);
                updatePomodoroButton();
                hideFocusReminder();
            }
        }

        function resetPomodoro() {
            pomodoroState.isRunning = false;
            pomodoroState.isPaused = false;
            pomodoroState.isBreak = false;
            clearInterval(pomodoroState.interval);
            
            const workMinutes = parseInt(document.getElementById('workTime').value) || 25;
            pomodoroState.timeLeft = workMinutes * 60;
            
            updatePomodoroDisplay();
            updatePomodoroButton();
            hideFocusReminder();
        }

        function pomodoroComplete() {
            clearInterval(pomodoroState.interval);
            pomodoroState.isRunning = false;
            
            if (!pomodoroState.isBreak) {
                // 工作時間結束，開始休息
                appData.pomodoro.completedToday++;
                appData.pomodoro.totalCompleted++;
                appData.pomodoro.lastDate = new Date().toISOString().split('T')[0];
                
                const breakMinutes = parseInt(document.getElementById('breakTime').value) || 5;
                pomodoroState.timeLeft = breakMinutes * 60;
                pomodoroState.isBreak = true;
                
                saveData();
                updatePomodoroStats();
                showPomodoroNotification('工作完成！開始休息時間', '你剛完成了一個番茄鐘，現在開始休息吧！');
                
                // 自動開始休息計時
                startPomodoro();
            } else {
                // 休息時間結束
                const workMinutes = parseInt(document.getElementById('workTime').value) || 25;
                pomodoroState.timeLeft = workMinutes * 60;
                pomodoroState.isBreak = false;
                
                showPomodoroNotification('休息完成！', '準備開始下一個番茄鐘了嗎？');
                updatePomodoroDisplay();
                updatePomodoroButton();
                hideFocusReminder();
            }
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroState.timeLeft / 60);
            const seconds = pomodoroState.timeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('pomodoroDisplay').textContent = timeString;
            
            // 更新提醒條
            if (pomodoroState.isRunning) {
                const statusText = pomodoroState.isBreak ? '休息時間' : '專注時間';
                document.getElementById('focusReminderText').textContent = `${statusText}進行中：還剩 ${timeString}`;
            }
        }

        function updatePomodoroButton() {
            const btn = document.getElementById('pomodoroBtn');
            
            if (pomodoroState.isRunning) {
                const minutes = Math.floor(pomodoroState.timeLeft / 60);
                btn.textContent = minutes.toString();
                btn.className = pomodoroState.isBreak ? 'pomodoro-btn break' : 'pomodoro-btn running';
            } else {
                btn.textContent = '🍅';
                btn.className = 'pomodoro-btn';
            }
        }

        function showFocusReminder() {
            if (pomodoroState.isRunning && !pomodoroState.isBreak) {
                document.getElementById('focusReminder').classList.add('show');
                pomodoroState.reminderShown = true;
            }
        }

        function hideFocusReminder() {
            document.getElementById('focusReminder').classList.remove('show');
            pomodoroState.reminderShown = false;
        }

        function updatePomodoroStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // 重置每日計數
            if (appData.pomodoro.lastDate !== today) {
                appData.pomodoro.completedToday = 0;
                appData.pomodoro.lastDate = today;
            }
            
            document.getElementById('pomodoroStats').textContent = 
                `今日完成: ${appData.pomodoro.completedToday} 個番茄`;
        }

        function showPomodoroNotification(title, message) {
            // 使用現有的成功訊息系統
            showSuccessMessage(`${title} ${message}`);
            
            // 播放提示音（如果瀏覽器支持）
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgaBCSF0fPTgjMGHm7A7+OZSA0PVqzn77BdGAg+ltryxnkpBSl+zPLZiToIGGS57OihUgwLUKXh8bllHgg2jdXzzn0vBSF1xe/glEILElyx6OyrWBUIQ5zd8sFuIAUuhM/z3YU2Bhxqvu7mnEoODlOq5O+zYBoGPJPY88p9KwUme8rx4I5FDBFYr+ftrVoXCECY2/PHdSMELYDN8tuJOQcZZ7zs5Z1NEgxPpeDwtWUcBjiS2fDOeSsFJHfH8N2QQAoUXrTp66hVFApGnt/yvmgaBCOB0PPTgjQGHW/A7eSaRw4OVKzm7bJeGQc9k9nxy3osBSZ8y/DdkUMKElmt5+qvVhgIQ5zb88NwIwUsf8zy3Io5CBhnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0OY2fLGdSMELYDN8tyJOQcZZ7vs5Z1NHQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgI');
                audio.play().catch(() => {}); // 忽略播放失敗的錯誤
            } catch (e) {}
        }

        // 初始化番茄鐘
        function initPomodoro() {
            // 載入設定
            if (appData.pomodoro) {
                document.getElementById('workTime').value = appData.pomodoro.workTime;
                document.getElementById('breakTime').value = appData.pomodoro.breakTime;
                
                // 檢查是否是新的一天，重置每日計數
                const today = new Date().toISOString().split('T')[0];
                if (appData.pomodoro.lastDate !== today) {
                    appData.pomodoro.completedToday = 0;
                    appData.pomodoro.lastDate = today;
                    saveData();
                }
                
                updatePomodoroStats();
            }
            
            // 監聽時間設定變更
            document.getElementById('workTime').addEventListener('change', savePomodoroSettings);
            document.getElementById('breakTime').addEventListener('change', savePomodoroSettings);
            
            // 監聽頁面切換
            setupNavigationListeners();
            
            // 監聽頁面離開
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // 點擊外部關閉面板
            document.addEventListener('click', function(e) {
                const panel = document.getElementById('pomodoroPanel');
                const btn = document.getElementById('pomodoroBtn');
                
                if (!panel.contains(e.target) && !btn.contains(e.target)) {
                    panel.classList.remove('show');
                }
            });
        }

        function savePomodoroSettings() {
            appData.pomodoro.workTime = parseInt(document.getElementById('workTime').value) || 25;
            appData.pomodoro.breakTime = parseInt(document.getElementById('breakTime').value) || 5;
            saveData();
            
            // 如果當前沒有在運行，更新顯示時間
            if (!pomodoroState.isRunning) {
                pomodoroState.timeLeft = appData.pomodoro.workTime * 60;
                updatePomodoroDisplay();
            }
        }

        function setupNavigationListeners() {
            // 監聽導航按鈕點擊
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (pomodoroState.isRunning && !pomodoroState.isBreak && !pomodoroState.reminderShown) {
                        showFocusReminder();
                    }
                });
            });
        }

        function handleBeforeUnload(e) {
            if (pomodoroState.isRunning && !pomodoroState.isBreak) {
                e.preventDefault();
                e.returnValue = '專注時間尚未結束，確定要離開嗎？';
                return '專注時間尚未結束，確定要離開嗎？';
            }
        }

        // Service Worker 註冊
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,const CACHE_NAME="daily-tracker-v1";const urlsToCache=["/"];self.addEventListener("install",event=>{event.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(urlsToCache)))});self.addEventListener("fetch",event=>{event.respondWith(caches.match(event.request).then(response=>{return response||fetch(event.request)}))});')
                .then(registration => {
                    console.log('Service Worker 註冊成功');
                })
                .catch(error => {
                    console.log('Service Worker 註冊失敗:', error);
                });
        }
    </script>
    <!-- 浮動番茄鐘 -->
    <div class="pomodoro-float">
        <button class="pomodoro-btn" id="pomodoroBtn" onclick="togglePomodoroPanel()">🍅</button>
        
        <div class="pomodoro-panel" id="pomodoroPanel">
            <div class="pomodoro-time-display" id="pomodoroDisplay">25:00</div>
            
            <div class="pomodoro-controls">
                <button class="pomodoro-control-btn pomodoro-start" onclick="startPomodoro()">開始</button>
                <button class="pomodoro-control-btn pomodoro-pause" onclick="pausePomodoro()">暫停</button>
                <button class="pomodoro-control-btn pomodoro-reset" onclick="resetPomodoro()">重置</button>
            </div>
            
            <div class="pomodoro-settings">
                <span>工作: <input type="number" id="workTime" value="25" min="1" max="60"> 分</span>
                <span>休息: <input type="number" id="breakTime" value="5" min="1" max="30"> 分</span>
            </div>
            
            <div class="pomodoro-stats" id="pomodoroStats">
                今日完成: 0 個番茄
            </div>
        </div>
    </div>

    <!-- 專注提醒條 -->
    <div class="focus-reminder" id="focusReminder">
        <span id="focusReminderText">番茄鐘進行中：還剩 25:00</span>
        <button onclick="hideFocusReminder()">我知道了</button>
    </div>
</body>
</html>