<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>日常記錄 JSONP 前端 + 歷史</title>
<style>
  body { font-family: "Microsoft JhengHei", sans-serif; padding: 1rem; background: #f8f0fb; }
  h2 { color: #6a1b9a; }
  form, .history { margin: 1rem 0; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  label { display: block; margin-top: 0.5rem; }
  input, select, button { width: 100%; padding: 0.5rem; margin-top: 0.2rem; border: 1px solid #ccc; border-radius: 4px; }
  button { background: #9c27b0; color: white; cursor: pointer; margin-top: 1rem; }
  table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
  th, td { border: 1px solid #ccc; padding: 0.3rem; text-align: center; }
  pre { background: #eee; padding: 0.5rem; border-radius: 4px; }
</style>
</head>
<body>

<h2>日常記錄</h2>

<!-- 表單 -->
<form id="expenseForm">
  <h3>支出</h3>
  <label>日期：<input type="date" name="date" required></label>
  <label>時間：<input type="time" name="time" required></label>
  <label>分類：
    <select name="category">
      <option>食</option><option>衣</option><option>住</option>
      <option>行</option><option>育</option><option>樂</option>
      <option>健康</option><option>其他</option>
    </select>
  </label>
  <label>金額：<input type="number" name="amount" required></label>
  <label>備註：<input type="text" name="note"></label>
  <button type="submit">送出支出</button>
</form>

<form id="weightForm">
  <h3>體重</h3>
  <label>日期：<input type="date" name="date" required></label>
  <label>時間：<input type="time" name="time" required></label>
  <label>體重 (kg)：<input type="number" step="0.1" name="weight" required></label>
  <button type="submit">送出體重</button>
</form>

<form id="bpForm">
  <h3>血壓</h3>
  <label>日期：<input type="date" name="date" required></label>
  <label>時間：<input type="time" name="time" required></label>
  <label>收縮壓：<input type="number" name="sys" required></label>
  <label>舒張壓：<input type="number" name="dia" required></label>
  <label>脈搏：<input type="number" name="pulse"></label>
  <button type="submit">送出血壓</button>
</form>

<h3>伺服器回應</h3>
<pre id="result"></pre>

<div class="history">
  <h3>歷史紀錄</h3>
  <div id="historyTables"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxzOX642s3Z4xr_VrilBF-BmUWFmhip2z2UEonlSLeVA7YomN0IvPnaOOzKZQ_8CTgmuA/exec";
const API_KEY = "1qazxsw23edc"; 

// 自動填入當前日期與時間
function setCurrentDateTime() {
  const now = new Date();
  const dateStr = now.toISOString().split('T')[0];
  const timeStr = now.toTimeString().split(':').slice(0,2).join(':');
  document.querySelectorAll('input[type="date"]').forEach(input => input.value = dateStr);
  document.querySelectorAll('input[type="time"]').forEach(input => input.value = timeStr);
}

// JSONP 請求
function sendJSONP(params) {
  params.apiKey = API_KEY;
  params.callback = "handleResponse";
  const query = new URLSearchParams(params).toString();
  const script = document.createElement("script");
  script.src = `${SCRIPT_URL}?${query}`;
  document.body.appendChild(script);
  setTimeout(() => document.body.removeChild(script), 5000);
}

// JSONP 回呼
function handleResponse(response) {
  console.log("伺服器回應:", response);
  document.getElementById("result").textContent = JSON.stringify(response, null, 2);
  if(response.success && response.data) {
    renderHistory(response.data);
  }
}

// 表單送出
document.getElementById("expenseForm").onsubmit = e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  sendJSONP({ type: "expense", ...data });
};
document.getElementById("weightForm").onsubmit = e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  sendJSONP({ type: "weight", ...data });
};
document.getElementById("bpForm").onsubmit = e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  sendJSONP({ type: "bp", ...data });
};

// 顯示歷史資料
function renderHistory(data) {
  const container = document.getElementById("historyTables");
  container.innerHTML = "";
  ["expense","weight","bp"].forEach(type=>{
    if(data[type] && data[type].length){
      let html = `<h4>${type.toUpperCase()}</h4><table><tr>`;
      Object.keys(data[type][0]).forEach(k=> html+=`<th>${k}</th>`);
      html += "</tr>";
      data[type].forEach(row=>{
        html += "<tr>";
        Object.values(row).forEach(v=> html+=`<td>${v}</td>`);
        html += "</tr>";
      });
      html += "</table>";
      container.innerHTML += html;
    }
  });
}

document.addEventListener('DOMContentLoaded', setCurrentDateTime);
</script>

</body>
</html>
