<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>æ—¥å¸¸è¨˜éŒ„ â€” æ”¯å‡º / é«”é‡ / è¡€å£“</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ç°¡æ½”ç´” CSS æ¨£å¼ */
    :root { --accent: #8e44ad; --muted: #f3f0f6; --card: #fff; font-size:16px; }
    body { font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; background: #f8f6fb; color:#222; margin:0; padding:24px; }
    header { text-align:center; margin-bottom:18px; }
    h1 { margin:0; color:var(--accent); }
    .container { max-width:900px; margin:0 auto; }

    /* tabs */
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab {
      padding:10px 16px; background:var(--muted); border-radius:8px; cursor:pointer; user-select:none;
      border: 1px solid rgba(0,0,0,0.06);
    }
    .tab.active { background:var(--card); box-shadow: 0 6px 18px rgba(0,0,0,0.06); color:var(--accent); font-weight:600; }

    /* content card */
    .card { background:var(--card); padding:16px; border-radius:10px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px; align-items:center; }
    label { display:block; font-size:14px; color:#444; }
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
      padding:8px; border:1px solid #ddd; border-radius:6px; min-width:160px;
    }
    .col { flex:1 1 200px; min-width:160px; }
    button { padding:10px 14px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer; }
    button.secondary { background:#eee; color:#333; }
    .small { font-size:13px; color:#666; margin-top:6px; }

    /* list */
    ul.record-list { list-style:none; padding:0; margin:8px 0; max-height:300px; overflow:auto; }
    li.record { padding:8px; border-bottom:1px solid #f0f0f0; font-size:14px; }

    /* responsive */
    @media (max-width:600px) {
      .row { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>æˆ‘çš„æ—¥å¸¸è¨˜éŒ„</h1>
      <p class="small">æ”¯å‡º / é«”é‡ / è¡€å£“ â€” èˆ‡ Google Sheets åŒæ­¥</p>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="tab-expense">ğŸ’° æ”¯å‡º</div>
      <div class="tab" data-tab="tab-weight">âš–ï¸ é«”é‡</div>
      <div class="tab" data-tab="tab-bp">â¤ï¸ è¡€å£“</div>
    </div>

    <!-- æ”¯å‡º -->
    <section id="tab-expense" class="card">
      <h3>æ–°å¢æ”¯å‡º</h3>
      <form id="form-expense">
        <div class="row">
          <div class="col">
            <label>æ—¥æœŸ</label>
            <input type="date" name="date" required>
          </div>
          <div class="col">
            <label>é¡åˆ¥</label>
            <select name="category">
              <option>é£Ÿ</option><option>è¡£</option><option>ä½</option><option>è¡Œ</option>
              <option>è‚²</option><option>æ¨‚</option><option>å¥åº·</option><option>è¦è²»</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>é …ç›®</label>
            <input type="text" name="item" placeholder="ä¾‹å¦‚ï¼šåˆé¤/è¨ˆç¨‹è»Š" required>
          </div>
          <div class="col">
            <label>é‡‘é¡</label>
            <input type="number" name="amount" min="0" step="0.01" placeholder="0" required>
          </div>
        </div>

        <div class="row">
          <div class="col" style="flex-basis:100%">
            <label>å‚™è¨»</label>
            <input type="text" name="note" placeholder="å¯é¸">
          </div>
        </div>

        <div class="row">
          <button type="submit" id="expenseSubmit">é€å‡ºæ”¯å‡º</button>
          <button type="button" class="secondary" onclick="loadData('expense')">è¼‰å…¥æ”¯å‡ºè³‡æ–™</button>
        </div>
      </form>

      <p id="expenseMessage" class="small"></p>
      <ul id="expenseList" class="record-list"></ul>
    </section>

    <!-- é«”é‡ -->
    <section id="tab-weight" class="card" style="display:none; margin-top:12px;">
      <h3>æ–°å¢é«”é‡</h3>
      <form id="form-weight">
        <div class="row">
          <div class="col">
            <label>æ—¥æœŸ</label>
            <input type="date" name="date" required>
          </div>
          <div class="col">
            <label>æ™‚é–“</label>
            <input type="time" name="time" required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>é«”é‡ (kg)</label>
            <input type="number" step="0.1" name="weight" required>
          </div>
          <div class="col">
            <label>å‚™è¨»</label>
            <input type="text" name="note" placeholder="å¯é¸">
          </div>
        </div>

        <div class="row">
          <button type="submit" id="weightSubmit">é€å‡ºé«”é‡</button>
          <button type="button" class="secondary" onclick="loadData('weight')">è¼‰å…¥é«”é‡è³‡æ–™</button>
        </div>
      </form>

      <p id="weightMessage" class="small"></p>
      <ul id="weightList" class="record-list"></ul>
    </section>

    <!-- è¡€å£“ -->
    <section id="tab-bp" class="card" style="display:none; margin-top:12px;">
      <h3>æ–°å¢è¡€å£“</h3>
      <form id="form-bp">
        <div class="row">
          <div class="col">
            <label>æ—¥æœŸ</label>
            <input type="date" name="date" required>
          </div>
          <div class="col">
            <label>æ™‚é–“</label>
            <input type="time" name="time" required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>æ”¶ç¸®å£“ (mmHg)</label>
            <input type="number" name="systolic" required>
          </div>
          <div class="col">
            <label>èˆ’å¼µå£“ (mmHg)</label>
            <input type="number" name="diastolic" required>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>è„ˆæ</label>
            <input type="number" name="pulse" placeholder="å¯é¸">
          </div>
          <div class="col">
            <label>å‚™è¨»</label>
            <input type="text" name="note" placeholder="å¯é¸">
          </div>
        </div>

        <div class="row">
          <button type="submit" id="bpSubmit">é€å‡ºè¡€å£“</button>
          <button type="button" class="secondary" onclick="loadData('blood pressure')">è¼‰å…¥è¡€å£“è³‡æ–™</button>
        </div>
      </form>

      <p id="bpMessage" class="small"></p>
      <ul id="bpList" class="record-list"></ul>
    </section>
  </div>

  <script>
    /***************** é…ç½® *****************/
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzKTwV8TB24duAcQzhnci_SbD5ojTR95N4Obp3LDHFUxbw4puDzzu-NV4PFi32X6Ty-vQ/exec"; // <- æŠŠé€™è£¡æ”¹æˆä½ éƒ¨ç½²å¾Œçš„ Apps Script Web App URL
    const API_KEY = "1qazxsw23edc"; // <- è‹¥å¾Œç«¯å•Ÿç”¨é‡‘é‘°é©—è­‰ï¼ŒæŠŠç›¸åŒå­—ä¸²æ”¾é€™è£¡ï¼›å¦å‰‡ç•™ç©º ""

    /************ Tab åˆ‡æ› (ç´” CSS é¡¯ç¤º/éš±è—) ************/
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        // hide all sections
        document.querySelectorAll('section.card').forEach(s => s.style.display = 'none');
        // show selected
        const id = tab.getAttribute('data-tab');
        document.getElementById(id).style.display = 'block';
      });
    });

    /************ é è¨­å¡«å…¥ç•¶å‰æ—¥æœŸ/æ™‚é–“ ************/
    function setDefaults() {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const timeStr = now.toTimeString().split(':').slice(0,2).join(':');
      document.querySelectorAll('input[type="date"]').forEach(i => i.value = dateStr);
      document.querySelectorAll('input[type="time"]').forEach(i => i.value = timeStr);
    }
    setDefaults();

    /************ æäº¤è™•ç†ï¼ˆPOST via FormDataï¼‰ ************/
    async function postForm(formElem, sheetName, messageElem, listReloadName) {
      const btn = formElem.querySelector('button[type="submit"]');
      const formData = new FormData(formElem);
      formData.append('sheet', sheetName);
      if (API_KEY) formData.append('apiKey', API_KEY);

      try {
        btn.disabled = true;
        btn.textContent = 'é€å‡ºä¸­...';
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const json = await res.json();
        if (json && json.success) {
          messageElem.textContent = 'âœ… ' + (json.message || 'å·²å„²å­˜');
          formElem.reset();
          setDefaults();
          // è‡ªå‹• reload æœ€æ–°å¹¾ç­†
          loadData(listReloadName || sheetName, 20);
        } else {
          messageElem.textContent = 'âŒ ' + (json.error || JSON.stringify(json));
        }
      } catch (err) {
        messageElem.textContent = 'âŒ ç¶²è·¯éŒ¯èª¤: ' + err;
      } finally {
        btn.disabled = false;
        btn.textContent = btn.id === 'expenseSubmit' || btn.id === 'weightSubmit' || btn.id === 'bpSubmit' ? (btn.id === 'expenseSubmit' ? 'é€å‡ºæ”¯å‡º' : btn.id === 'weightSubmit' ? 'é€å‡ºé«”é‡' : 'é€å‡ºè¡€å£“') : 'é€å‡º';
      }
    }

    // ç¶å®šè¡¨å–®
    document.getElementById('form-expense').addEventListener('submit', e => {
      e.preventDefault();
      postForm(e.target, 'expense', document.getElementById('expenseMessage'), 'expense');
    });
    document.getElementById('form-weight').addEventListener('submit', e => {
      e.preventDefault();
      postForm(e.target, 'weight', document.getElementById('weightMessage'), 'weight');
    });
    document.getElementById('form-bp').addEventListener('submit', e => {
      e.preventDefault();
      postForm(e.target, 'blood pressure', document.getElementById('bpMessage'), 'blood pressure');
    });

    /************ è¼‰å…¥è³‡æ–™ï¼ˆGET: action=read&sheet=...ï¼‰ ************/
    async function loadData(sheet, limit = 50) {
      try {
        const url = `${SCRIPT_URL}?action=read&sheet=${encodeURIComponent(sheet)}&limit=${limit}` + (API_KEY ? `&apiKey=${encodeURIComponent(API_KEY)}` : '');
        const res = await fetch(url);
        const json = await res.json();
        if (!Array.isArray(json)) {
          console.error('è®€å–å›å‚³éé™£åˆ—', json);
          return;
        }

        // ä¾ sheet å¡«å…¥å°æ‡‰ list
        if (sheet === 'expense') renderExpense(json);
        else if (sheet === 'weight') renderWeight(json);
        else if (sheet === 'blood pressure') renderBP(json);
      } catch (err) {
        console.error('è¼‰å…¥è³‡æ–™éŒ¯èª¤', err);
      }
    }

    function formatDT(isoStr) {
      if (!isoStr) return '';
      // ä¼ºæœå™¨å›å‚³æ ¼å¼ç‚º yyyy-MM-dd'T'HH:mm:ss'Z' (string)
      // ç›´æ¥é¡¯ç¤ºè¼ƒå‹å–„
      return isoStr.replace('T', ' ').replace(/Z$/, '');
    }

    // render functions
    function renderExpense(rows) {
      const el = document.getElementById('expenseList');
      el.innerHTML = '';
      // é¡¯ç¤ºæœ€è¿‘åœ¨å‰
      rows.slice().reverse().forEach(r => {
        const li = document.createElement('li');
        li.className = 'record';
        li.textContent = `${formatDT(r.date)} | ${r.category} | ${r.item} | ${r.amount} å…ƒ ${r.note ? ' | ' + r.note : ''}`;
        el.appendChild(li);
      });
    }

    function renderWeight(rows) {
      const el = document.getElementById('weightList');
      el.innerHTML = '';
      rows.slice().reverse().forEach(r => {
        const li = document.createElement('li');
        li.className = 'record';
        li.textContent = `${formatDT(r.date_time)} | ${r.weight} kg ${r.note ? ' | ' + r.note : ''}`;
        el.appendChild(li);
      });
    }

    function renderBP(rows) {
      const el = document.getElementById('bpList');
      el.innerHTML = '';
      rows.slice().reverse().forEach(r => {
        const li = document.createElement('li');
        li.className = 'record';
        li.textContent = `${formatDT(r.date_time)} | ${r.systolic}/${r.diastolic} mmHg | è„ˆæ ${r.pulse || '-'} ${r.note ? ' | ' + r.note : ''}`;
        el.appendChild(li);
      });
    }

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥æ¯å€‹è¡¨æ ¼çš„æœ€æ–° 10 ç­†ä»¥ä¾›é è¦½
    document.addEventListener('DOMContentLoaded', () => {
      setDefaults();
      loadData('expense', 10);
      loadData('weight', 10);
      loadData('blood pressure', 10);
    });
  </script>
</body>
</html>
