<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <title>æ—¥å¸¸ç”Ÿæ´»è¨˜éŒ„</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç”Ÿæ´»è¨˜éŒ„">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='35' fill='url(%23bg)'/%3E%3Ccircle cx='90' cy='70' r='25' fill='white' opacity='0.2'/%3E%3Ctext x='90' y='80' text-anchor='middle' fill='white' font-size='40' font-family='system-ui, sans-serif' font-weight='600'%3Eè¨˜%3C/text%3E%3Crect x='50' y='110' width='80' height='4' rx='2' fill='white' opacity='0.7'/%3E%3Crect x='60' y='125' width='60' height='3' rx='1.5' fill='white' opacity='0.5'/%3E%3Crect x='70' y='138' width='40' height='3' rx='1.5' fill='white' opacity='0.3'/%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json,{%22name%22:%22æ—¥å¸¸ç”Ÿæ´»è¨˜éŒ„%22,%22short_name%22:%22ç”Ÿæ´»è¨˜éŒ„%22,%22description%22:%22å€‹äººæ—¥å¸¸è¨˜éŒ„ç®¡ç†ç³»çµ±%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%238b5cf6%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='192' height='192' rx='35' fill='url(%23bg)'/%3E%3Ccircle cx='96' cy='75' r='28' fill='white' opacity='0.2'/%3E%3Ctext x='96' y='85' text-anchor='middle' fill='white' font-size='45' font-family='system-ui, sans-serif' font-weight='600'%3Eè¨˜%3C/text%3E%3Crect x='50' y='120' width='92' height='5' rx='2.5' fill='white' opacity='0.7'/%3E%3Crect x='60' y='135' width='72' height='4' rx='2' fill='white' opacity='0.5'/%3E%3Crect x='70' y='148' width='52' height='4' rx='2' fill='white' opacity='0.3'/%3E%3C/svg%3E%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22},{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%237c3aed'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='85' fill='url(%23bg)'/%3E%3Ccircle cx='256' cy='190' r='70' fill='white' opacity='0.2'/%3E%3Ctext x='256' y='215' text-anchor='middle' fill='white' font-size='110' font-family='system-ui, sans-serif' font-weight='600'%3Eè¨˜%3C/text%3E%3Crect x='130' y='300' width='252' height='12' rx='6' fill='white' opacity='0.7'/%3E%3Crect x='150' y='330' width='212' height='10' rx='5' fill='white' opacity='0.5'/%3E%3Crect x='170' y='358' width='172' height='10' rx='5' fill='white' opacity='0.3'/%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #8b5cf6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .filter-controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(139, 92, 246, 0.3);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .date-inputs {
            display: none;
            gap: 10px;
            align-items: center;
        }

        .date-inputs.show {
            display: flex;
        }

        .date-inputs input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .records-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .record-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #8b5cf6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-content {
            flex: 1;
        }

        .record-date {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .record-details {
            font-weight: 500;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: #f8fafc;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .health-advice {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .advice-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .nav {
                gap: 5px;
            }
            
            .nav-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            #monthlyExpenseOverview .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            #monthlyExpenseOverview h3 {
                font-size: 1rem !important;
                margin-bottom: 8px !important;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ä»»å‹™ç›¸é—œæ¨£å¼ */
        .task-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 4px solid #8b5cf6;
            transition: all 0.3s ease;
        }

        .task-item.overdue { border-left-color: #ef4444; background: #fef2f2; }
        .task-item.today { border-left-color: #f59e0b; background: #fffbeb; }
        .task-item.upcoming { border-left-color: #10b981; background: #f0fdf4; }

        .task-checkbox { width: 20px; height: 20px; cursor: pointer; }
        .task-content { flex: 1; }
        .task-name { font-weight: 600; margin-bottom: 5px; }
        .task-date { font-size: 0.9rem; color: #6b7280; }

        .task-priority { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; }
        .task-priority.high { background: #fef2f2; color: #dc2626; }
        .task-priority.medium { background: #fffbeb; color: #d97706; }
        .task-priority.low { background: #f0fdf4; color: #059669; }

        /* ç¿’æ…£ç›¸é—œæ¨£å¼ */
        .habit-item {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .habit-item.checked { background: #f0fdf4; border-color: #10b981; }
        .habit-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .habit-name { flex: 1; font-weight: 500; }
        .habit-streak { font-size: 0.8rem; color: #6b7280; background: #f3f4f6; padding: 2px 8px; border-radius: 12px; }

        /* æ—¥èªŒç›¸é—œæ¨£å¼ */
        .diary-entry { background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #8b5cf6; }
        .diary-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .diary-date { font-weight: 600; color: #374151; }
        .diary-mood { padding: 4px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 500; }

        .mood-5 { background: #f0fdf4; color: #059669; }
        .mood-4 { background: #f0f9ff; color: #0284c7; }
        .mood-3 { background: #f9fafb; color: #6b7280; }
        .mood-2 { background: #fffbeb; color: #d97706; }
        .mood-1 { background: #fef2f2; color: #dc2626; }

        .diary-content { margin: 10px 0; line-height: 1.6; }
        .diary-stats { display: flex; gap: 15px; font-size: 0.9rem; color: #6b7280; margin-top: 10px; }
        .diary-habits { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 8px; }
        .diary-habit-tag { background: #e5e7eb; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
        .diary-habit-tag.completed { background: #dcfce7; color: #059669; }

        /* ç•ªèŒ„é˜æµ®å‹•æŒ‰éˆ•æ¨£å¼ */
        .pomodoro-float {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .pomodoro-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .pomodoro-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
        }

        .pomodoro-btn.running {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            animation: pulse 2s infinite;
        }

        .pomodoro-btn.break {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pomodoro-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 280px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 20px;
            transform: translateY(10px) scale(0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .pomodoro-panel.show {
            transform: translateY(0) scale(1);
            opacity: 1;
            visibility: visible;
        }

        .pomodoro-time-display {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .pomodoro-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .pomodoro-control-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pomodoro-start {
            background: #22c55e;
            color: white;
        }

        .pomodoro-pause {
            background: #f59e0b;
            color: white;
        }

        .pomodoro-reset {
            background: #ef4444;
            color: white;
        }

        .pomodoro-settings {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .pomodoro-settings input {
            width: 50px;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-size: 0.8rem;
        }

        .pomodoro-stats {
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 10px;
        }

        /* å°ˆæ³¨æ™‚é–“æé†’æ¢ */
        .focus-reminder {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 8px 20px;
            z-index: 999;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .focus-reminder.show {
            transform: translateY(0);
        }

        .focus-reminder button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* æ‰‹æ©Ÿé©é… */
        @media (max-width: 768px) {
            .pomodoro-float {
                bottom: 20px;
                right: 15px;
            }
            
            .pomodoro-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .pomodoro-panel {
                width: 250px;
                bottom: 60px;
                right: -20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ“Š æ—¥å¸¸ç”Ÿæ´»è¨˜éŒ„</h1>
            <p>è¼•é¬†ç®¡ç†æ‚¨çš„æ”¯å‡ºã€å¥åº·èˆ‡ç”Ÿæ´»æ•¸æ“š</p>
        </header>

        <nav class="nav">
            <button class="nav-btn active" onclick="showSection('expenses')">ğŸ’° æ”¯å‡ºè¨˜éŒ„</button>
            <button class="nav-btn" onclick="showSection('weight')">âš–ï¸ é«”é‡è¨˜éŒ„</button>
            <button class="nav-btn" onclick="showSection('blood-pressure')">â¤ï¸ è¡€å£“è¨˜éŒ„</button>
            <button class="nav-btn" onclick="showSection('exercise')">ğŸƒ é‹å‹•è¨˜éŒ„</button>
            <button class="nav-btn" onclick="showSection('tasks')">ğŸ“‹ ä¾‹è¡Œä»»å‹™</button>
            <button class="nav-btn" onclick="showSection('diary')">ğŸ“– ç°¡æ˜“æ—¥èªŒ</button>
            <button class="nav-btn" onclick="showSection('charts')">ğŸ“ˆ åœ–è¡¨åˆ†æ</button>
            <button class="nav-btn" onclick="showSection('profile')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</button>
            <button class="nav-btn" onclick="showSection('settings')">âš™ï¸ è¨­å®šç®¡ç†</button>
        </nav>

        <!-- æ”¯å‡ºè¨˜éŒ„ -->
        <section id="expenses" class="section active">
            <div class="card">
                <h2 class="card-title">ğŸ“Š æœ¬æœˆæ”¯å‡ºæ¦‚è¦½</h2>
                <div id="monthlyExpenseOverview">
                    <!-- æœ¬æœˆæ”¯å‡ºçµ±è¨ˆå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">ğŸ’° æ–°å¢æ”¯å‡ºè¨˜éŒ„</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label>åˆ†é¡</label>
                        <select id="expenseCategory" required>
                            <option value="">è«‹é¸æ“‡åˆ†é¡</option>
                            <option value="é£Ÿç‰©">ğŸ½ï¸ é£Ÿç‰©</option>
                            <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                            <option value="å¨›æ¨‚">ğŸ¬ å¨›æ¨‚</option>
                            <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="é†«ç™‚">ğŸ¥ é†«ç™‚</option>
                            <option value="æ•™è‚²">ğŸ“š æ•™è‚²</option>
                            <option value="è¦è²»">ğŸ’¸ è¦è²»</option>
                            <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é …ç›®</label>
                        <input type="text" id="expenseItem" placeholder="ä¾‹å¦‚ï¼šåˆé¤" required>
                    </div>
                    <div class="form-group">
                        <label>é‡‘é¡ (NT$)</label>
                        <input type="number" id="expenseAmount" placeholder="0" required>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>å‚™è¨»</label>
                        <textarea id="expenseNote" placeholder="é¸å¡«..." rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addExpense()">æ–°å¢æ”¯å‡ºè¨˜éŒ„</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“‹ æ”¯å‡ºè¨˜éŒ„</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">ç¯©é¸ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setExpenseFilter('all')">æ‰€æœ‰è¨˜éŒ„</button>
                    <button class="filter-btn" onclick="setExpenseFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setExpenseFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setExpenseFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setExpenseFilter('custom')">è‡ªè¨‚å€é–“</button>
                    <div class="date-inputs" id="expenseDateInputs">
                        <input type="date" id="expenseStartDate">
                        <span>è‡³</span>
                        <input type="date" id="expenseEndDate">
                        <button class="filter-btn" onclick="applyExpenseCustomFilter()">å¥—ç”¨</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="expenseCount">0</span> ç­†è¨˜éŒ„</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('expenses')">ğŸ“Š åŒ¯å‡º CSV</button>
                </div>
                <div id="expensesList" class="records-list"></div>
            </div>
        </section>

        <!-- é«”é‡è¨˜éŒ„ -->
        <section id="weight" class="section">
            <div class="card">
                <h2 class="card-title">âš–ï¸ æ–°å¢é«”é‡è¨˜éŒ„</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="weightDate" required>
                    </div>
                    <div class="form-group">
                        <label>æ™‚é–“</label>
                        <input type="time" id="weightTime" required>
                    </div>
                    <div class="form-group">
                        <label>é«”é‡ (kg)</label>
                        <input type="number" step="0.1" id="weightValue" placeholder="ä¾‹å¦‚ï¼š65.5" required>
                    </div>
                    <div class="form-group">
                        <label>è…°åœ (cm)</label>
                        <input type="number" step="0.1" id="waistValue" placeholder="ä¾‹å¦‚ï¼š80.5">
                    </div>
                </div>
                <button class="btn" onclick="addWeight()">æ–°å¢é«”é‡è¨˜éŒ„</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“Š é«”é‡çµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgWeight">--</div>
                        <div class="stat-label">å¹³å‡é«”é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="latestBMI">--</div>
                        <div class="stat-label">æœ€æ–° BMI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weightChange">--</div>
                        <div class="stat-label">æœ¬æœˆè®ŠåŒ–</div>
                    </div>
                </div>
                <div id="weightAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">ğŸ’¡ å¥åº·å»ºè­°</div>
                    <div id="weightAdviceContent"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“‹ é«”é‡è¨˜éŒ„</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">ç¯©é¸ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setWeightFilter('all')">æ‰€æœ‰è¨˜éŒ„</button>
                    <button class="filter-btn" onclick="setWeightFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setWeightFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setWeightFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setWeightFilter('custom')">è‡ªè¨‚å€é–“</button>
                    <div class="date-inputs" id="weightDateInputs">
                        <input type="date" id="weightStartDate">
                        <span>è‡³</span>
                        <input type="date" id="weightEndDate">
                        <button class="filter-btn" onclick="applyWeightCustomFilter()">å¥—ç”¨</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="weightCount">0</span> ç­†è¨˜éŒ„</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('weights')">ğŸ“Š åŒ¯å‡º CSV</button>
                </div>
                <div id="weightsList" class="records-list"></div>
            </div>
        </section>

        <!-- è¡€å£“è¨˜éŒ„ -->
        <section id="blood-pressure" class="section">
            <div class="card">
                <h2 class="card-title">â¤ï¸ æ–°å¢è¡€å£“è¨˜éŒ„</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="bpDate" required>
                    </div>
                    <div class="form-group">
                        <label>æ™‚é–“</label>
                        <input type="time" id="bpTime" required>
                    </div>
                    <div class="form-group">
                        <label>æ”¶ç¸®å£“ (mmHg)</label>
                        <input type="number" id="systolic" placeholder="ä¾‹å¦‚ï¼š120" required>
                    </div>
                    <div class="form-group">
                        <label>èˆ’å¼µå£“ (mmHg)</label>
                        <input type="number" id="diastolic" placeholder="ä¾‹å¦‚ï¼š80" required>
                    </div>
                    <div class="form-group">
                        <label>è„ˆæ (æ¬¡/åˆ†)</label>
                        <input type="number" id="pulse" placeholder="ä¾‹å¦‚ï¼š72">
                    </div>
                </div>
                <button class="btn" onclick="addBloodPressure()">æ–°å¢è¡€å£“è¨˜éŒ„</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“Š è¡€å£“çµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgSystolic">--</div>
                        <div class="stat-label">å¹³å‡æ”¶ç¸®å£“</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDiastolic">--</div>
                        <div class="stat-label">å¹³å‡èˆ’å¼µå£“</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgPulse">--</div>
                        <div class="stat-label">å¹³å‡è„ˆæ</div>
                    </div>
                </div>
                <div id="bpAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">ğŸ’¡ è¡€å£“å»ºè­°</div>
                    <div id="bpAdviceContent"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“‹ è¡€å£“è¨˜éŒ„</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">ç¯©é¸ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setBPFilter('all')">æ‰€æœ‰è¨˜éŒ„</button>
                    <button class="filter-btn" onclick="setBPFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setBPFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setBPFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setBPFilter('custom')">è‡ªè¨‚å€é–“</button>
                    <div class="date-inputs" id="bpDateInputs">
                        <input type="date" id="bpStartDate">
                        <span>è‡³</span>
                        <input type="date" id="bpEndDate">
                        <button class="filter-btn" onclick="applyBPCustomFilter()">å¥—ç”¨</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="bpCount">0</span> ç­†è¨˜éŒ„</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('bloodPressure')">ğŸ“Š åŒ¯å‡º CSV</button>
                </div>
                <div id="bpList" class="records-list"></div>
            </div>
        </section>

        <!-- é‹å‹•è¨˜éŒ„ -->
        <section id="exercise" class="section">
            <div class="card">
                <h2 class="card-title">ğŸƒ æ–°å¢é‹å‹•è¨˜éŒ„</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="date" id="exerciseDate" required>
                    </div>
                    <div class="form-group">
                        <label>é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="exerciseStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>é‹å‹•é¡å‹</label>
                        <select id="exerciseType" required>
                            <option value="">è«‹é¸æ“‡é‹å‹•é¡å‹</option>
                            <option value="è·‘æ­¥">ğŸƒ è·‘æ­¥</option>
                            <option value="å¥èµ°">ğŸš¶ å¥èµ°</option>
                            <option value="é¨è»Š">ğŸš´ é¨è»Š</option>
                            <option value="æ¸¸æ³³">ğŸŠ æ¸¸æ³³</option>
                            <option value="é‡è¨“">ğŸ‹ï¸ é‡é‡è¨“ç·´</option>
                            <option value="ç‘œçˆ">ğŸ§˜ ç‘œçˆ</option>
                            <option value="çƒé¡">âš½ çƒé¡é‹å‹•</option>
                            <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é‹å‹•æ™‚é–“ (åˆ†é˜)</label>
                        <input type="number" id="exerciseDuration" placeholder="ä¾‹å¦‚ï¼š30" required>
                    </div>
                    <div class="form-group">
                        <label>æ¶ˆè€—å¡è·¯é‡Œ (é¸å¡«)</label>
                        <input type="number" id="exerciseCalories" placeholder="ä¾‹å¦‚ï¼š200">
                    </div>
                    <div class="form-group">
                        <label>é‹å‹•å¼·åº¦</label>
                        <select id="exerciseIntensity">
                            <option value="è¼•åº¦">ğŸ˜Œ è¼•åº¦</option>
                            <option value="ä¸­åº¦" selected>ğŸ˜Š ä¸­åº¦</option>
                            <option value="é«˜å¼·åº¦">ğŸ˜¤ é«˜å¼·åº¦</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>å‚™è¨»</label>
                        <textarea id="exerciseNote" placeholder="é‹å‹•å¿ƒå¾—ã€åœ°é»ç­‰..." rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addExercise()">æ–°å¢é‹å‹•è¨˜éŒ„</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“Š é‹å‹•çµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyExercises">0</div>
                        <div class="stat-label">æœ¬é€±é‹å‹•æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyDuration">0</div>
                        <div class="stat-label">æœ¬é€±é‹å‹•æ™‚é–“ (åˆ†)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weeklyCalories">0</div>
                        <div class="stat-label">æœ¬é€±æ¶ˆè€—å¡è·¯é‡Œ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="exerciseStreak">0</div>
                        <div class="stat-label">é€£çºŒé‹å‹•å¤©æ•¸</div>
                    </div>
                </div>
                <div id="exerciseAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">ğŸ’¡ é‹å‹•å»ºè­°</div>
                    <div id="exerciseAdviceContent"></div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“‹ é‹å‹•è¨˜éŒ„</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">ç¯©é¸ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setExerciseFilter('all')">æ‰€æœ‰è¨˜éŒ„</button>
                    <button class="filter-btn" onclick="setExerciseFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setExerciseFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setExerciseFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setExerciseFilter('custom')">è‡ªè¨‚å€é–“</button>
                    <div class="date-inputs" id="exerciseDateInputs">
                        <input type="date" id="exerciseStartDate">
                        <span>è‡³</span>
                        <input type="date" id="exerciseEndDate">
                        <button class="filter-btn" onclick="applyExerciseCustomFilter()">å¥—ç”¨</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="exerciseCount">0</span> ç­†è¨˜éŒ„</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('exercises')">ğŸ“Š åŒ¯å‡º CSV</button>
                </div>
                <div id="exercisesList" class="records-list"></div>
            </div>
        </section>

        <!-- ä¾‹è¡Œä»»å‹™ -->
        <section id="tasks" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ“‹ æ–°å¢ä¾‹è¡Œä»»å‹™</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ä»»å‹™åç¨±</label>
                        <input type="text" id="taskName" placeholder="ä¾‹å¦‚ï¼šç¹³é›»è²»" required>
                    </div>        
                    <div class="form-group">
                        <label>ä¸‹æ¬¡åˆ°æœŸæ—¥</label>
                        <input type="date" id="taskNextDate" required>
                    </div>
                    <div class="form-group">
                        <label>é‡è¤‡é–“éš”</label>
                        <select id="taskInterval" required>
                            <option value="">è«‹é¸æ“‡é‡è¤‡é–“éš”</option>
                            <option value="weekly">æ¯é€±</option>
                            <option value="biweekly">æ¯é›™é€±</option>
                            <option value="monthly">æ¯æœˆ</option>
                            <option value="quarterly">æ¯å­£</option>
                            <option value="semiannual">æ¯åŠå¹´</option>
                            <option value="annual">æ¯å¹´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å„ªå…ˆç´š</label>
                        <select id="taskPriority">
                            <option value="low">ğŸŸ¢ ä½</option>
                            <option value="medium" selected>ğŸŸ¡ ä¸­</option>
                            <option value="high">ğŸ”´ é«˜</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>å‚™è¨»</label>
                        <textarea id="taskNote" placeholder="ä»»å‹™èªªæ˜ã€æé†’äº‹é …ç­‰..." rows="2"></textarea>
                    </div>
                </div>
                <button class="btn" onclick="addTask()">æ–°å¢ä¾‹è¡Œä»»å‹™</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“… å¾…è¾¦ä»»å‹™åˆ—è¡¨</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="taskCount">0</span> é …ä»»å‹™</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="showCompletedTasks()">ğŸ“‹ å·²å®Œæˆè¨˜éŒ„</button>
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('tasks')">ğŸ“Š åŒ¯å‡º CSV</button>
                    </div>
                </div>
                <div id="tasksList" class="records-list"></div>
            </div>

            <div class="card" id="completedTasksCard" style="display: none;">
                <h3 class="card-title">âœ… å·²å®Œæˆä»»å‹™è¨˜éŒ„</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">ç¯©é¸ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setCompletedTaskFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setCompletedTaskFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setCompletedTaskFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setCompletedTaskFilter('all')">æ‰€æœ‰è¨˜éŒ„</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="completedTaskCount">0</span> ç­†è¨˜éŒ„</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="hideCompletedTasks()">éš±è—</button>
                </div>
                <div id="completedTasksList" class="records-list"></div>
            </div>
        </section>
 
        <!-- ç°¡æ˜“æ—¥èªŒ -->
        <section id="diary" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ“– ä»Šæ—¥è¨˜éŒ„</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: 500;">æ—¥æœŸ:</label>
                        <input type="date" id="diaryDate" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 8px;">
                    </div>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="loadDiaryForDate()">è¼‰å…¥è©²æ—¥è¨˜éŒ„</button>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>ä»Šæ—¥æ­¥æ•¸</label>
                        <input type="number" id="diarySteps" placeholder="ä¾‹å¦‚ï¼š8000">
                    </div>
                    <div class="form-group">
                        <label>å¿ƒæƒ…è©•åˆ†</label>
                        <select id="diaryMood">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="5">ğŸ˜„ éå¸¸å¥½</option>
                            <option value="4">ğŸ˜Š å¾ˆå¥½</option>
                            <option value="3">ğŸ˜ æ™®é€š</option>
                            <option value="2">ğŸ˜” ä¸å¤ªå¥½</option>
                            <option value="1">ğŸ˜ å¾ˆç³Ÿ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <label>ç¿’æ…£æ‰“å¡</label>
                    <div id="habitsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                        <!-- ç¿’æ…£é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;" onclick="addHabit()">+ æ–°å¢ç¿’æ…£</button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>ä»Šæ—¥å°è¨˜</label>
                    <textarea id="diaryContent" placeholder="è¨˜éŒ„ä»Šå¤©ç™¼ç”Ÿçš„äº‹æƒ…ã€æ„Ÿæƒ³ã€æ”¶ç©«..." rows="5"></textarea>
                </div>

                <button class="btn" onclick="saveDiary()">å„²å­˜ä»Šæ—¥è¨˜éŒ„</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“Š ç¿’æ…£çµ±è¨ˆ</h3>
                <div id="habitsStats" class="stats-grid">
                    <!-- ç¿’æ…£çµ±è¨ˆå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“ æ—¥èªŒè¨˜éŒ„</h3>
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">ç¯©é¸ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setDiaryFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setDiaryFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setDiaryFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setDiaryFilter('all')">æ‰€æœ‰è¨˜éŒ„</button>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="color: #6b7280;">å…± <span id="diaryCount">0</span> ç­†è¨˜éŒ„</span>
                    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;" onclick="exportSingleCSV('diary')">ğŸ“Š åŒ¯å‡º CSV</button>
                </div>
                <div id="diaryList" class="records-list"></div>
            </div>
        </section>

        <!-- åŸºæœ¬è³‡æ–™ -->
        <section id="profile" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™è¨­å®š</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="profileName" placeholder="æ‚¨çš„å§“å">
                    </div>
                    <div class="form-group">
                        <label>ç”Ÿæ—¥</label>
                        <input type="date" id="profileBirthday">
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <select id="profileGender">
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èº«é«˜ (cm)</label>
                        <input type="number" id="profileHeight" placeholder="ä¾‹å¦‚ï¼š170" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>æ´»å‹•é‡</label>
                        <select id="profileActivity">
                            <option value="sedentary">ä¹…åå°‘å‹•</option>
                            <option value="light" selected>è¼•åº¦æ´»å‹•</option>
                            <option value="moderate">ä¸­åº¦æ´»å‹•</option>
                            <option value="active">ç©æ¥µæ´»å‹•</option>
                            <option value="very_active">éå¸¸æ´»èº</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="saveProfile()">å„²å­˜åŸºæœ¬è³‡æ–™</button>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“Š å€‹äººè³‡è¨Š</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="displayAge">--</div>
                        <div class="stat-label">å¹´é½¡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="displayBMI">--</div>
                        <div class="stat-label">ç›®å‰ BMI</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="displayTargetWeight">--</div>
                        <div class="stat-label">å»ºè­°é«”é‡ç¯„åœ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="displayDailyCalories">--</div>
                        <div class="stat-label">å»ºè­°æ—¥æ¶ˆè€—</div>
                    </div>
                </div>
                <div id="profileAdvice" class="health-advice" style="display: none;">
                    <div class="advice-title">ğŸ’¡ å€‹äººåŒ–å»ºè­°</div>
                    <div id="profileAdviceContent"></div>
                </div>
            </div>
        </section>

        <!-- åœ–è¡¨åˆ†æ -->
        <section id="charts" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ“ˆ æ•¸æ“šåœ–è¡¨åˆ†æ</h2>
        
                <!-- æ™‚é–“å€é–“é¸æ“‡ -->
                <div class="filter-controls">
                    <span style="font-weight: 500; color: #555;">åˆ†ææ™‚é–“ç¯„åœï¼š</span>
                    <button class="filter-btn active" onclick="setChartFilter('week')">è¿‘ä¸ƒæ—¥</button>
                    <button class="filter-btn" onclick="setChartFilter('month')">è¿‘ä¸€å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setChartFilter('quarter')">è¿‘ä¸‰å€‹æœˆ</button>
                    <button class="filter-btn" onclick="setChartFilter('half-year')">è¿‘åŠå¹´</button>
                    <button class="filter-btn" onclick="setChartFilter('year')">è¿‘ä¸€å¹´</button>
                    <button class="filter-btn" onclick="setChartFilter('all')">å…¨éƒ¨æ•¸æ“š</button>
                </div>
        
                <div style="text-align: center; margin: 15px 0; color: #6b7280;">
                    <span>ç•¶å‰åˆ†æç¯„åœï¼š<span id="chartRangeText">è¿‘ä¸ƒæ—¥</span> | æ•¸æ“šæ›´æ–°æ™‚é–“ï¼š<span id="chartUpdateTime">--</span></span>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ’° æ”¯å‡ºåˆ†é¡åˆ†æ</h3>
                <div class="chart-container">
                    <canvas id="expenseChart" width="400" height="300"></canvas>
                </div>
                <div id="expenseChartStats" style="margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <!-- æ”¯å‡ºçµ±è¨ˆæ•¸æ“šå°‡åœ¨æ­¤é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">âš–ï¸ é«”é‡è®ŠåŒ–è¶¨å‹¢</h3>
                <div class="chart-container">
                    <canvas id="weightChart" width="400" height="300"></canvas>
                </div>
                <div id="weightChartStats" style="margin-top: 15px;">
                    <!-- é«”é‡çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">â¤ï¸ è¡€å£“ç›£æ§åœ–è¡¨</h3>
                <div class="chart-container">
                    <canvas id="bpChart" width="400" height="300"></canvas>
                </div>
                <div id="bpChartStats" style="margin-top: 15px;">
                    <!-- è¡€å£“çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸƒ é‹å‹•çµ±è¨ˆåœ–è¡¨</h3>
                <div class="chart-container">
                    <canvas id="exerciseChart" width="400" height="300"></canvas>
                </div>
                <div id="exerciseChartStats" style="margin-top: 15px;">
                    <!-- é‹å‹•çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“‹ ä»»å‹™å®Œæˆç‡çµ±è¨ˆ</h3>
                <div class="chart-container">
                    <canvas id="taskChart" width="400" height="300"></canvas>
                </div>
                <div id="taskChartStats" style="margin-top: 15px;">
                    <!-- ä»»å‹™çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“– ç¿’æ…£é¤Šæˆåˆ†æ</h3>
                <div class="chart-container">
                    <canvas id="habitChart" width="400" height="300"></canvas>
                </div>
                <div id="habitChartStats" style="margin-top: 15px;">
                    <!-- ç¿’æ…£çµ±è¨ˆå°‡åœ¨æ­¤é¡¯ç¤º -->
                </div>
            </div>
        </section>

        <!-- è¨­å®šç®¡ç† -->
        <section id="settings" class="section">
            <div class="card">
                <h2 class="card-title">ğŸ’° é ç®—è¨­å®š</h2>
                <p style="color: #6b7280; margin-bottom: 15px;">è¨­å®šæ¯æœˆå„é¡åˆ¥çš„é ç®—ä¸Šé™ï¼Œç³»çµ±æœƒåœ¨æ”¯å‡ºé é¢é¡¯ç¤ºä½¿ç”¨ç‹€æ³</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ğŸ½ï¸ é£Ÿç‰©é ç®— (NT$)</label>
                        <input type="number" id="budgetFood" placeholder="8000">
                    </div>
                    <div class="form-group">
                        <label>ğŸš— äº¤é€šé ç®— (NT$)</label>
                        <input type="number" id="budgetTransport" placeholder="3000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ¬ å¨›æ¨‚é ç®— (NT$)</label>
                        <input type="number" id="budgetEntertainment" placeholder="2000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ›ï¸ è³¼ç‰©é ç®— (NT$)</label>
                        <input type="number" id="budgetShopping" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ¥ é†«ç™‚é ç®— (NT$)</label>
                        <input type="number" id="budgetMedical" placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“š æ•™è‚²é ç®— (NT$)</label>
                        <input type="number" id="budgetEducation" placeholder="3000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ’¸ è¦è²»é ç®— (NT$)</label>
                        <input type="number" id="budgetUtilities" placeholder="4000">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ å…¶ä»–é ç®— (NT$)</label>
                        <input type="number" id="budgetOther" placeholder="2000">
                    </div>
                </div>
                <button class="btn" onclick="saveBudgets()">å„²å­˜é ç®—è¨­å®š</button>
            </div>

            <div class="card">
                <h2 class="card-title">âš™ï¸ è³‡æ–™ç®¡ç†</h2>
                <div class="export-buttons">
                    <button class="btn" onclick="exportData('json')">ğŸ“¤ åŒ¯å‡º JSON</button>
                    <button class="btn" onclick="exportData('csv')">ğŸ“Š åŒ¯å‡º CSV</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥æ•¸æ“š</button>
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•¸æ“š</button>
                    <button class="btn btn-secondary" onclick="clearTestData()">ğŸ”„ é‡ç½®ç‚ºç¯„ä¾‹æ•¸æ“š</button>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)">
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“± PWA å®‰è£</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">åœ¨æ‰‹æ©Ÿç€è¦½å™¨ä¸­ï¼Œæ‚¨å¯ä»¥å°‡æ­¤æ‡‰ç”¨ã€Œæ–°å¢åˆ°ä¸»ç•«é¢ã€ï¼Œå°±åƒå®‰è£ App ä¸€æ¨£ä½¿ç”¨ã€‚</p>
                    <button class="btn btn-secondary" onclick="installPWA()" id="installBtn" style="display: none;">ğŸ“± å®‰è£æ‡‰ç”¨</button>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalExpenses">0</div>
                        <div class="stat-label">æ”¯å‡ºè¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalWeight">0</div>
                        <div class="stat-label">é«”é‡è¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalBP">0</div>
                        <div class="stat-label">è¡€å£“è¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalExercise">0</div>
                        <div class="stat-label">é‹å‹•è¨˜éŒ„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dataSize">0KB</div>
                        <div class="stat-label">æ•¸æ“šå¤§å°</div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
    // æ•¸æ“šå­˜å„²
    let appData = {
        expenses: [],
        weights: [],
        bloodPressure: [],
        exercises: [],
        tasks: [],
        completedTasks: [],
        diary: [],
        habits: [],
        profile: {
            name: '',
            birthday: '',
            gender: '',
            height: '',
            activity: 'light'
        },
        budgets: {
            'é£Ÿç‰©': 8000,
            'äº¤é€š': 3000,
            'å¨›æ¨‚': 2000,
            'è³¼ç‰©': 5000,
            'é†«ç™‚': 1000,
            'æ•™è‚²': 3000,
            'è¦è²»': 4000,
            'å…¶ä»–': 2000
        },
        pomodoro: {
            workTime: 25,
            breakTime: 5,
            completedToday: 0,
            totalCompleted: 0,
            lastDate: null
        }
    };

    // ç•ªèŒ„é˜ç‹€æ…‹
    let pomodoroState = {
        isRunning: false,
        isPaused: false,
        isBreak: false,
        timeLeft: 25 * 60, // ç§’
        interval: null,
        reminderShown: false
    };

    // ç¯©é¸ç‹€æ…‹
    let filters = {
        expense: 'all',
        weight: 'all',
        bloodPressure: 'all',
        exercise: 'all',
        completedTask: 'week',
        diary: 'week'
    };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date().toTimeString().slice(0, 5);
            
            document.getElementById('expenseDate').value = today;
            document.getElementById('weightDate').value = today;
            document.getElementById('weightTime').value = now;
            document.getElementById('bpDate').value = today;
            document.getElementById('bpTime').value = now;
            document.getElementById('exerciseDate').value = today;
            document.getElementById('exerciseStartTime').value = now;
            document.getElementById('taskNextDate').value = today;
            document.getElementById('diaryDate').value = today;

            loadData();
            updateAllDisplays();
            loadTodayDiary();
            loadProfile();
            loadBudgets();
            setupPWAInstall();
            initPomodoro();
        });

        // é é¢åˆ‡æ›
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            
            const navBtns = document.querySelectorAll('.nav-btn');
            const sections = ['expenses', 'weight', 'blood-pressure', 'exercise', 'tasks', 'diary', 'charts', 'profile', 'settings'];
            const index = sections.indexOf(sectionName);
            if (index !== -1) {
                navBtns[index].classList.add('active');
            }
        }

        // è¼‰å…¥æ•¸æ“š
        function loadData() {
            try {
                const savedData = localStorage.getItem('dailyTrackerData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // ç¢ºä¿æ•¸æ“šçµæ§‹å®Œæ•´
                    appData = {
                        expenses: parsed.expenses || [],
                        weights: parsed.weights || [],
                        bloodPressure: parsed.bloodPressure || [],
                        exercises: parsed.exercises || [],
                        tasks: parsed.tasks || [],
                        completedTasks: parsed.completedTasks || [],
                        diary: parsed.diary || [],
                        habits: parsed.habits || [],
                        profile: {
                            name: '',
                            birthday: '',
                            gender: '',
                            height: '',
                            activity: 'light',
                            ...parsed.profile
                        },
                       budgets: {
                           'é£Ÿç‰©': 8000,
                           'äº¤é€š': 3000,
                           'å¨›æ¨‚': 2000,
                           'è³¼ç‰©': 5000,
                           'é†«ç™‚': 1000,
                           'æ•™è‚²': 3000,
                           'è¦è²»': 4000,
                           'å…¶ä»–': 2000,
                           ...parsed.budgets
                       },
                       pomodoro: {
                            workTime: 25,
                            breakTime: 5,
                            completedToday: 0,
                            totalCompleted: 0,
                            lastDate: null,
                            ...parsed.pomodoro
                        }
                    };
                    console.log('è¼‰å…¥å·²ä¿å­˜çš„æ•¸æ“š');
                } else {
                    // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè¼‰å…¥ç¯„ä¾‹æ•¸æ“š
                    addSampleData();
                    console.log('è¼‰å…¥ç¯„ä¾‹æ•¸æ“š');
                }
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                addSampleData();
            }
        }

        // ä¿å­˜æ•¸æ“š
        function saveData() {
            try {
                localStorage.setItem('dailyTrackerData', JSON.stringify(appData));
                console.log('æ•¸æ“šå·²ä¿å­˜åˆ°æœ¬æ©Ÿ');
            } catch (error) {
                console.error('ä¿å­˜æ•¸æ“šå¤±æ•—:', error);
                // å¦‚æœä¿å­˜å¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºå„²å­˜ç©ºé–“ä¸è¶³æˆ–ç€è¦½å™¨é™åˆ¶
                alert('ä¿å­˜æ•¸æ“šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æ¸…é™¤éƒ¨åˆ†æ•¸æ“š');
            }
        }

        // æ·»åŠ ç¤ºä¾‹æ•¸æ“š
        function addSampleData() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            appData.expenses = [
                {
                    id: Date.now() + 1,
                    date: today.toISOString().split('T')[0],
                    category: 'é£Ÿç‰©',
                    item: 'åˆé¤',
                    amount: 150,
                    note: 'ä¾¿ç•¶'
                },
                {
                    id: Date.now() + 2,
                    date: yesterday.toISOString().split('T')[0],
                    category: 'äº¤é€š',
                    item: 'æ·é‹',
                    amount: 30,
                    note: ''
                }
            ];

            appData.weights = [
                {
                    id: Date.now() + 3,
                    date: today.toISOString().split('T')[0],
                    time: '08:00',
                    weight: 65.5,
                    waist: 80,
                    height: 170,
                    bmi: 22.7
                }
            ];

            appData.bloodPressure = [
                {
                    id: Date.now() + 4,
                    date: today.toISOString().split('T')[0],
                    time: '09:00',
                    systolic: 120,
                    diastolic: 80,
                    pulse: 72
                }
            ];

            appData.exercises = [
                {
                    id: Date.now() + 5,
                    date: today.toISOString().split('T')[0],
                    startTime: '07:00',
                    type: 'è·‘æ­¥',
                    duration: 30,
                    calories: 200,
                    intensity: 'ä¸­åº¦',
                    note: 'æ™¨è·‘'
                }
            ];

            appData.tasks = [
                {
                    id: Date.now() + 6,
                    name: 'ç¹³é›»è²»',
                    nextDate: nextWeek.toISOString().split('T')[0],
                    interval: 'monthly',
                    priority: 'medium',
                    note: 'è¨˜å¾—åœ¨æœŸé™å‰ç¹³è²»',
                    created: today.toISOString().split('T')[0]
                }
            ];

            appData.habits = [
                { id: Date.now() + 7, name: 'å–æ°´8æ¯', created: today.toISOString().split('T')[0] },
                { id: Date.now() + 8, name: 'æ—©ç¡æ—©èµ·', created: today.toISOString().split('T')[0] },
                { id: Date.now() + 9, name: 'é–±è®€30åˆ†é˜', created: today.toISOString().split('T')[0] }
            ];

            appData.diary = [
                {
                    id: Date.now() + 10,
                    date: today.toISOString().split('T')[0],
                    steps: 8000,
                    mood: 4,
                    habits: { [Date.now() + 7]: true, [Date.now() + 8]: false, [Date.now() + 9]: true },
                    content: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½ï¼Œå‡ºé–€æ•£æ­¥äº†ä¸€æœƒå…’ã€‚',
                    created: new Date().toISOString()
                }
            ];
        }

        // æ—¥æœŸç¯©é¸è¼”åŠ©å‡½æ•¸
        function getDateRange(range) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(range) {
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return { start: weekAgo, end: today };
                    
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return { start: monthAgo, end: today };
                    
                case 'quarter':
                    const quarterAgo = new Date(today);
                    quarterAgo.setMonth(quarterAgo.getMonth() - 3);
                    return { start: quarterAgo, end: today };
                    
                default:
                    return { start: null, end: null };
            }
        }

        function filterRecordsByDate(records, range, customStart = null, customEnd = null) {
            if (range === 'all') return records;
            
            let dateRange;
            if (range === 'custom' && customStart && customEnd) {
                dateRange = {
                    start: new Date(customStart),
                    end: new Date(customEnd)
                };
            } else {
                dateRange = getDateRange(range);
            }
            
            if (!dateRange.start || !dateRange.end) return records;
            
            return records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= dateRange.start && recordDate <= dateRange.end;
            });
        }

        // ç¯©é¸åŠŸèƒ½
        function setExpenseFilter(range) {
            filters.expense = range;
            updateFilterButtons('expenses', range);
            const dateInputs = document.getElementById('expenseDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateExpensesList();
            }
        }

        function setWeightFilter(range) {
            filters.weight = range;
            updateFilterButtons('weight', range);
            const dateInputs = document.getElementById('weightDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateWeightsList();
            }
        }

        function setBPFilter(range) {
            filters.bloodPressure = range;
            updateFilterButtons('blood-pressure', range);
            const dateInputs = document.getElementById('bpDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateBPList();
            }
        }

        function setExerciseFilter(range) {
            filters.exercise = range;
            updateFilterButtons('exercise', range);
            const dateInputs = document.getElementById('exerciseDateInputs');
            if (range === 'custom') {
                dateInputs.classList.add('show');
            } else {
                dateInputs.classList.remove('show');
                updateExercisesList();
            }
        }

        function updateFilterButtons(sectionId, range) {
            const filterTexts = {
                'all': 'æ‰€æœ‰è¨˜éŒ„',
                'week': 'è¿‘ä¸ƒæ—¥',
                'month': 'è¿‘ä¸€å€‹æœˆ',
                'quarter': 'è¿‘ä¸‰å€‹æœˆ',
                'custom': 'è‡ªè¨‚å€é–“'
            };
            
            document.querySelectorAll(`#${sectionId} .filter-btn`).forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(filterTexts[range])) {
                    btn.classList.add('active');
                }
            });
        }

        function applyExpenseCustomFilter() {
            const startDate = document.getElementById('expenseStartDate').value;
            const endDate = document.getElementById('expenseEndDate').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }
            
            filters.expenseCustomStart = startDate;
            filters.expenseCustomEnd = endDate;
            updateExpensesList();
        }

        function applyWeightCustomFilter() {
            const startDate = document.getElementById('weightStartDate').value;
            const endDate = document.getElementById('weightEndDate').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }
            
            filters.weightCustomStart = startDate;
            filters.weightCustomEnd = endDate;
            updateWeightsList();
        }

        function applyBPCustomFilter() {
            const startDate = document.getElementById('bpStartDate').value;
            const endDate = document.getElementById('bpEndDate').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }
            
            filters.bpCustomStart = startDate;
            filters.bpCustomEnd = endDate;
            updateBPList();
        }

        function applyExerciseCustomFilter() {
            const startDate = document.getElementById('exerciseStartDate').value;
            const endDate = document.getElementById('exerciseEndDate').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ');
                return;
            }
            
            filters.exerciseCustomStart = startDate;
            filters.exerciseCustomEnd = endDate;
            updateExercisesList();
        }

        // æ–°å¢è¨˜éŒ„å‡½æ•¸
        function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const item = document.getElementById('expenseItem').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const note = document.getElementById('expenseNote').value;

            if (!date || !category || !item || !amount) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }

            const expense = {
                id: Date.now(),
                date,
                category,
                item,
                amount,
                note
            };

            appData.expenses.unshift(expense);
            saveData();
            updateExpensesList();
            updateStats();

            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseItem').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseNote').value = '';
            
            showSuccessMessage('æ”¯å‡ºè¨˜éŒ„å·²æ–°å¢ï¼');
        }

        function addWeight() {
            const date = document.getElementById('weightDate').value;
            const time = document.getElementById('weightTime').value;
            const weight = parseFloat(document.getElementById('weightValue').value);
            const waist = parseFloat(document.getElementById('waistValue').value) || null;

            if (!date || !time || !weight) {
                alert('è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“å’Œé«”é‡');
                return;
            }

            const height = appData.profile.height;
            let bmi = null;
            if (height) {
                bmi = (weight / ((height / 100) ** 2)).toFixed(1);
            }

            const weightRecord = {
                id: Date.now(),
                date,
                time,
                weight,
                waist,
                height,
                bmi: parseFloat(bmi)
            };

            appData.weights.unshift(weightRecord);
            saveData();
            updateWeightsList();
            updateWeightStats();
            updateProfileDisplay();

            document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('weightTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('weightValue').value = '';
            document.getElementById('waistValue').value = '';
            
            showSuccessMessage('é«”é‡è¨˜éŒ„å·²æ–°å¢ï¼');
        }

        function addBloodPressure() {
            const date = document.getElementById('bpDate').value;
            const time = document.getElementById('bpTime').value;
            const systolic = parseInt(document.getElementById('systolic').value);
            const diastolic = parseInt(document.getElementById('diastolic').value);
            const pulse = parseInt(document.getElementById('pulse').value) || null;

            if (!date || !time || !systolic || !diastolic) {
                alert('è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“ã€æ”¶ç¸®å£“å’Œèˆ’å¼µå£“');
                return;
            }

            const bpRecord = {
                id: Date.now(),
                date,
                time,
                systolic,
                diastolic,
                pulse
            };

            appData.bloodPressure.unshift(bpRecord);
            saveData();
            updateBPList();
            updateBPStats();

            document.getElementById('bpDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('bpTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('pulse').value = '';
            
            showSuccessMessage('è¡€å£“è¨˜éŒ„å·²æ–°å¢ï¼');
        }

        function addExercise() {
            const date = document.getElementById('exerciseDate').value;
            const startTime = document.getElementById('exerciseStartTime').value;
            const type = document.getElementById('exerciseType').value;
            const duration = parseInt(document.getElementById('exerciseDuration').value);
            const calories = parseInt(document.getElementById('exerciseCalories').value) || null;
            const intensity = document.getElementById('exerciseIntensity').value;
            const note = document.getElementById('exerciseNote').value;

            if (!date || !startTime || !type || !duration) {
                alert('è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“ã€é‹å‹•é¡å‹å’Œé‹å‹•æ™‚é–“');
                return;
            }

            const exercise = {
                id: Date.now(),
                date,
                startTime,
                type,
                duration,
                calories,
                intensity,
                note
            };

            appData.exercises.unshift(exercise);
            saveData();
            updateExercisesList();
            updateExerciseStats();

            document.getElementById('exerciseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('exerciseStartTime').value = new Date().toTimeString().slice(0, 5);
            document.getElementById('exerciseType').value = '';
            document.getElementById('exerciseDuration').value = '';
            document.getElementById('exerciseCalories').value = '';
            document.getElementById('exerciseIntensity').value = 'ä¸­åº¦';
            document.getElementById('exerciseNote').value = '';
            
            showSuccessMessage('é‹å‹•è¨˜éŒ„å·²æ–°å¢ï¼');
        }

        // æ›´æ–°åˆ—è¡¨å‡½æ•¸
        function updateExpensesList() {
            const container = document.getElementById('expensesList');
            const countElement = document.getElementById('expenseCount');
            
            let filteredExpenses = filterRecordsByDate(
                appData.expenses, 
                filters.expense, 
                filters.expenseCustomStart, 
                filters.expenseCustomEnd
            );
            
            countElement.textContent = filteredExpenses.length;
            
            if (filteredExpenses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æ­¤æ™‚é–“ç¯„åœå…§ç„¡æ”¯å‡ºè¨˜éŒ„</p>';
                return;
            }

            container.innerHTML = filteredExpenses.map(expense => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${expense.date}</div>
                        <div class="record-details">
                            <strong>${expense.category}</strong> - ${expense.item}
                            <span style="color: #ef4444; font-weight: 600; margin-left: 10px;">NT$ ${expense.amount}</span>
                            ${expense.note ? `<br><small style="color: #6b7280;">${expense.note}</small>` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('expenses', ${expense.id})">åˆªé™¤</button>
                </div>
            `).join('');

            // æ›´æ–°æœ¬æœˆæ”¯å‡ºæ¦‚è¦½
            updateMonthlyExpenseOverview();
        }

        // æ›´æ–°æœ¬æœˆæ”¯å‡ºæ¦‚è¦½
        function updateMonthlyExpenseOverview() {
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
            const thisMonthExpenses = appData.expenses.filter(expense => 
                expense.date.startsWith(currentMonth)
            );

            // æŒ‰é¡åˆ¥çµ±è¨ˆæœ¬æœˆæ”¯å‡º
            const categoryTotals = {};
            let totalThisMonth = 0;

            thisMonthExpenses.forEach(expense => {
                if (!categoryTotals[expense.category]) {
                    categoryTotals[expense.category] = 0;
                }
                categoryTotals[expense.category] += expense.amount;
                totalThisMonth += expense.amount;
            });

            const container = document.getElementById('monthlyExpenseOverview');
    
            if (Object.keys(categoryTotals).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        æœ¬æœˆå°šç„¡æ”¯å‡ºè¨˜éŒ„
                    </div>
                `;
                return;
            }

            // ç”Ÿæˆé ç®—vså¯¦éš›æ”¯å‡ºçš„å¡ç‰‡
            const categoryCards = Object.keys(appData.budgets).map(category => {
            const spent = categoryTotals[category] || 0;
            const budget = appData.budgets[category] || 0;
            const percentage = budget > 0 ? Math.round((spent / budget) * 100) : 0;
            
            let statusColor = '#10b981';
            let statusText = 'æ­£å¸¸';
            
            if (percentage >= 100) {
                statusColor = '#ef4444';
                statusText = 'è¶…æ”¯';
            } else if (percentage >= 80) {
                statusColor = '#f59e0b';
                statusText = 'è­¦ç¤º';
            }

            return `
                <div style="background: #f8fafc; border-radius: 8px; padding: 10px; border-left: 4px solid ${statusColor}; position: relative;">
                    <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 2px;">${getCategoryIcon(category)} ${category}</div>
                    <div style="font-size: 1rem; font-weight: 600; color: ${statusColor}; margin-bottom: 2px;">
                        NT$ ${spent.toLocaleString()}
                    </div>
                    <div style="font-size: 0.75rem; color: #6b7280;">
                        ${budget.toLocaleString()} (${percentage}%)
                    </div>
                    ${percentage >= 80 ? `<div style="font-size: 0.7rem; color: ${statusColor}; font-weight: 500;">${statusText}</div>` : ''}
                </div>
            `;
        }).join('');

            // ç¸½æ”¯å‡ºå¡ç‰‡
            const totalBudget = Object.values(appData.budgets).reduce((sum, budget) => sum + budget, 0);
            const totalPercentage = totalBudget > 0 ? Math.round((totalThisMonth / totalBudget) * 100) : 0;
    
            let totalStatusColor = '#10b981';
            if (totalPercentage >= 100) totalStatusColor = '#ef4444';
            else if (totalPercentage >= 80) totalStatusColor = '#f59e0b';

            container.innerHTML = `
                <div style="margin-bottom: 15px; text-align: center;">
                    <h3 style="color: #374151; margin-bottom: 10px; font-size: 1.1rem;">ğŸ“… ${new Date().getFullYear()}å¹´${new Date().getMonth() + 1}æœˆæ”¯å‡ºçµ±è¨ˆ</h3>
                </div>
                
                <!-- ç¸½æ”¯å‡ºæ¦‚è¦ -->
                <div style="background: linear-gradient(135deg, ${totalStatusColor}, ${totalStatusColor}dd); border-radius: 15px; padding: 15px; margin-bottom: 15px; color: white; text-align: center;">
                    <div style="font-size: 1.3rem; font-weight: 700; margin-bottom: 5px;">NT$ ${totalThisMonth.toLocaleString()}</div>
                    <div style="opacity: 0.9;">æœ¬æœˆç¸½æ”¯å‡º / é ç®—: NT$ ${totalBudget.toLocaleString()} (${totalPercentage}%)</div>
                </div>
                
                <!-- åˆ†é¡æ¦‚è¦½ - ç·Šæ¹Šæ ¼å¼ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 15px;">
                    ${categoryCards}
                </div>
            `;
        }

        function updateWeightsList() {
            const container = document.getElementById('weightsList');
            const countElement = document.getElementById('weightCount');
            
            let filteredWeights = filterRecordsByDate(
                appData.weights, 
                filters.weight, 
                filters.weightCustomStart, 
                filters.weightCustomEnd
            );
            
            countElement.textContent = filteredWeights.length;
            
            if (filteredWeights.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æ­¤æ™‚é–“ç¯„åœå…§ç„¡é«”é‡è¨˜éŒ„</p>';
                return;
            }

            container.innerHTML = filteredWeights.map(weight => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${weight.date} ${weight.time}</div>
                        <div class="record-details">
                            <strong>é«”é‡:</strong> ${weight.weight} kg
                            ${weight.waist ? ` | <strong>è…°åœ:</strong> ${weight.waist} cm` : ''}
                            ${weight.bmi ? ` | <strong>BMI:</strong> ${weight.bmi}` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('weights', ${weight.id})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        function updateBPList() {
            const container = document.getElementById('bpList');
            const countElement = document.getElementById('bpCount');
            
            let filteredBP = filterRecordsByDate(
                appData.bloodPressure, 
                filters.bloodPressure, 
                filters.bpCustomStart, 
                filters.bpCustomEnd
            );
            
            countElement.textContent = filteredBP.length;
            
            if (filteredBP.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æ­¤æ™‚é–“ç¯„åœå…§ç„¡è¡€å£“è¨˜éŒ„</p>';
                return;
            }

            container.innerHTML = filteredBP.map(bp => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${bp.date} ${bp.time}</div>
                        <div class="record-details">
                            <strong>${bp.systolic}/${bp.diastolic}</strong> mmHg
                            ${bp.pulse ? ` | <strong>è„ˆæ:</strong> ${bp.pulse} æ¬¡/åˆ†` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('bloodPressure', ${bp.id})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        function updateExercisesList() {
            const container = document.getElementById('exercisesList');
            const countElement = document.getElementById('exerciseCount');
            
            let filteredExercises = filterRecordsByDate(
                appData.exercises, 
                filters.exercise, 
                filters.exerciseCustomStart, 
                filters.exerciseCustomEnd
            );
            
            countElement.textContent = filteredExercises.length;
            
            if (filteredExercises.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æ­¤æ™‚é–“ç¯„åœå…§ç„¡é‹å‹•è¨˜éŒ„</p>';
                return;
            }

            container.innerHTML = filteredExercises.map(exercise => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${exercise.date} ${exercise.startTime}</div>
                        <div class="record-details">
                            <strong>${exercise.type}</strong> - ${exercise.duration} åˆ†é˜ (${exercise.intensity})
                            ${exercise.calories ? ` | <span style="color: #ef4444;">${exercise.calories} å¡è·¯é‡Œ</span>` : ''}
                            ${exercise.note ? `<br><small style="color: #6b7280;">${exercise.note}</small>` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord('exercises', ${exercise.id})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        // ä¾‹è¡Œä»»å‹™åŠŸèƒ½
        function addTask() {
            const name = document.getElementById('taskName').value;
            const nextDate = document.getElementById('taskNextDate').value;
            const interval = document.getElementById('taskInterval').value;
            const priority = document.getElementById('taskPriority').value;
            const note = document.getElementById('taskNote').value;

            if (!name || !nextDate || !interval) {
                alert('è«‹å¡«å¯«ä»»å‹™åç¨±ã€ä¸‹æ¬¡åˆ°æœŸæ—¥å’Œé‡è¤‡é–“éš”');
                return;
            }

            const task = {
                id: Date.now(),
                name,
                nextDate,
                interval,
                priority,
                note,
                created: new Date().toISOString().split('T')[0]
            };

            appData.tasks.push(task);
            saveData();
            updateTasksList();

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('taskName').value = '';
            document.getElementById('taskNextDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('taskInterval').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskNote').value = '';
    
            showSuccessMessage('ä¾‹è¡Œä»»å‹™å·²æ–°å¢ï¼');
        }

        function completeTask(id) {
            const taskIndex = appData.tasks.findIndex(task => task.id === id);
            if (taskIndex === -1) return;

            const task = appData.tasks[taskIndex];
    
            // è¨˜éŒ„å®Œæˆ
            const completedTask = {
                ...task,
                completedDate: new Date().toISOString().split('T')[0],
                completedTime: new Date().toTimeString().slice(0, 5)
            };
            appData.completedTasks.unshift(completedTask);

            // è¨ˆç®—ä¸‹æ¬¡æ—¥æœŸ
            const currentDate = new Date(task.nextDate);
            const nextDate = calculateNextDate(currentDate, task.interval);
            task.nextDate = nextDate.toISOString().split('T')[0];

            saveData();
            updateTasksList();
            updateCompletedTasksList();
            showSuccessMessage(`ä»»å‹™ã€Œ${task.name}ã€å·²å®Œæˆï¼ä¸‹æ¬¡æ—¥æœŸï¼š${task.nextDate}`);
        }

        function calculateNextDate(currentDate, interval) {
            const nextDate = new Date(currentDate);
    
            switch(interval) {
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'biweekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
                case 'quarterly':
                    nextDate.setMonth(nextDate.getMonth() + 3);
                    break;
                case 'semiannual':
                    nextDate.setMonth(nextDate.getMonth() + 6);
                    break;
                case 'annual':
                    nextDate.setFullYear(nextDate.getFullYear() + 1);
                    break;
            }
    
            return nextDate;
        }

        function updateTasksList() {
            const container = document.getElementById('tasksList');
            const countElement = document.getElementById('taskCount');
    
            // æŒ‰ç…§åˆ°æœŸæ—¥æ’åº
            const sortedTasks = [...appData.tasks].sort((a, b) => new Date(a.nextDate) - new Date(b.nextDate));
    
            countElement.textContent = sortedTasks.length;
    
            if (sortedTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">å°šç„¡ä¾‹è¡Œä»»å‹™</p>';
                return;
            }

            const today = new Date().toISOString().split('T')[0];
    
            container.innerHTML = sortedTasks.map(task => {
                const taskDate = new Date(task.nextDate);
                const todayDate = new Date(today);
                const daysDiff = Math.ceil((taskDate - todayDate) / (1000 * 60 * 60 * 24));
        
                let statusClass = 'upcoming';
                let statusText = `é‚„æœ‰ ${daysDiff} å¤©`;
        
                if (daysDiff < 0) {
                    statusClass = 'overdue';
                    statusText = `é€¾æœŸ ${Math.abs(daysDiff)} å¤©`;
                } else if (daysDiff === 0) {
                    statusClass = 'today';
                    statusText = 'ä»Šå¤©åˆ°æœŸ';
                } else if (daysDiff <= 3) {
                    statusClass = 'today';
                    statusText = `é‚„æœ‰ ${daysDiff} å¤©`;
                }

                return `
                    <div class="task-item ${statusClass}">
                        <input type="checkbox" class="task-checkbox" onclick="completeTask(${task.id})">
                        <div class="task-content">
                            <div class="task-name">${task.name}</div>
                            <div class="task-date">åˆ°æœŸæ—¥ï¼š${task.nextDate} (${statusText})</div>
                            ${task.note ? `<div style="font-size: 0.9rem; color: #6b7280; margin-top: 5px;">${task.note}</div>` : ''}
                        </div>
                        <div class="task-priority ${task.priority}">${getPriorityText(task.priority)}</div>
                        <button class="delete-btn" onclick="deleteRecord('tasks', ${task.id})">åˆªé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function getPriorityText(priority) {
            const priorities = {
                'high': 'ğŸ”´ é«˜',
                'medium': 'ğŸŸ¡ ä¸­',
                'low': 'ğŸŸ¢ ä½'
            };
            return priorities[priority] || 'ğŸŸ¡ ä¸­';
        }

        function showCompletedTasks() {
            document.getElementById('completedTasksCard').style.display = 'block';
            updateCompletedTasksList();
        }

        function hideCompletedTasks() {
            document.getElementById('completedTasksCard').style.display = 'none';
        }

        function setCompletedTaskFilter(range) {
            filters.completedTask = range;
            updateCompletedTasksList();
        }

        function updateCompletedTasksList() {
            const container = document.getElementById('completedTasksList');
            const countElement = document.getElementById('completedTaskCount');
    
            let filteredTasks = filterRecordsByDate(
                appData.completedTasks, 
                filters.completedTask, 
                null, 
                null
            );
    
            countElement.textContent = filteredTasks.length;
    
            if (filteredTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æ­¤æ™‚é–“ç¯„åœå…§ç„¡å·²å®Œæˆä»»å‹™</p>';
                return;
            }

            container.innerHTML = filteredTasks.map(task => `
                <div class="record-item">
                    <div class="record-content">
                        <div class="record-date">${task.completedDate} ${task.completedTime}</div>
                        <div class="record-details">
                            <strong>${task.name}</strong> (${getPriorityText(task.priority)})
                            ${task.note ? `<br><small style="color: #6b7280;">${task.note}</small>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ç°¡æ˜“æ—¥èªŒåŠŸèƒ½
        function loadTodayDiary() {
            const today = new Date().toISOString().split('T')[0];
            loadDiaryForSpecificDate(today);
            updateHabitsDisplay();
            updateHabitsStats();
        }

        function loadDiaryForDate() {
            const date = document.getElementById('diaryDate').value;
            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸ');
                return;
            }
            loadDiaryForSpecificDate(date);
        }

        function loadDiaryForSpecificDate(date) {
            const diary = appData.diary.find(d => d.date === date);
    
            if (diary) {
                document.getElementById('diarySteps').value = diary.steps || '';
                document.getElementById('diaryMood').value = diary.mood || '';
                document.getElementById('diaryContent').value = diary.content || '';
        
                // è¼‰å…¥ç¿’æ…£å®Œæˆç‹€æ…‹
                appData.habits.forEach(habit => {
                    const checkbox = document.querySelector(`input[data-habit-id="${habit.id}"]`);
                    if (checkbox) {
                        checkbox.checked = diary.habits && diary.habits[habit.id] || false;
                    }
                });
            } else {
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('diarySteps').value = '';
                document.getElementById('diaryMood').value = '';
                document.getElementById('diaryContent').value = '';
        
                // æ¸…ç©ºç¿’æ…£å‹¾é¸
                appData.habits.forEach(habit => {
                    const checkbox = document.querySelector(`input[data-habit-id="${habit.id}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                });
            }
        }

        function addHabit() {
            const habitName = prompt('è«‹è¼¸å…¥æ–°ç¿’æ…£åç¨±ï¼š');
            if (!habitName || !habitName.trim()) return;

            const habit = {
                id: Date.now(),
                name: habitName.trim(),
                created: new Date().toISOString().split('T')[0]
            };

            appData.habits.push(habit);
            saveData();
            updateHabitsDisplay();
            updateHabitsStats();
            showSuccessMessage('ç¿’æ…£å·²æ–°å¢ï¼');
        }

        function updateHabitsDisplay() {
            const container = document.getElementById('habitsContainer');
    
            if (appData.habits.length === 0) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">å°šæœªå»ºç«‹ç¿’æ…£é …ç›®</p>';
                return;
            }

            container.innerHTML = appData.habits.map(habit => {
                const streak = calculateHabitStreak(habit.id);
                return `
                    <div class="habit-item">
                        <input type="checkbox" class="habit-checkbox" data-habit-id="${habit.id}">
                        <span class="habit-name">${habit.name}</span>
                        <span class="habit-streak">${streak}å¤©</span>
                        <button onclick="deleteHabit(${habit.id})" style="background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;">åˆªé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function deleteHabit(habitId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¿’æ…£å—ï¼Ÿ')) return;
    
            appData.habits = appData.habits.filter(habit => habit.id !== habitId);
            saveData();
            updateHabitsDisplay();
            updateHabitsStats();
            showSuccessMessage('ç¿’æ…£å·²åˆªé™¤ï¼');
        }

        function calculateHabitStreak(habitId) {
            let streak = 0;
            const today = new Date();
    
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
        
                const diary = appData.diary.find(d => d.date === dateStr);
                if (diary && diary.habits && diary.habits[habitId]) {
                    streak++;
                } else {
                    break;
                }
            }
    
            return streak;
        }

        function saveDiary() {
            const date = document.getElementById('diaryDate').value;
            const steps = parseInt(document.getElementById('diarySteps').value) || null;
            const mood = parseInt(document.getElementById('diaryMood').value) || null;
            const content = document.getElementById('diaryContent').value;

            if (!date) {
                alert('è«‹é¸æ“‡æ—¥æœŸ');
                return;
            }

            // æ”¶é›†ç¿’æ…£å®Œæˆç‹€æ…‹
            const habits = {};
            appData.habits.forEach(habit => {
                const checkbox = document.querySelector(`input[data-habit-id="${habit.id}"]`);
                if (checkbox) {
                    habits[habit.id] = checkbox.checked;
                }
            });

            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰è©²æ—¥æœŸçš„è¨˜éŒ„
            const existingIndex = appData.diary.findIndex(d => d.date === date);
    
            const diaryRecord = {
                id: existingIndex >= 0 ? appData.diary[existingIndex].id : Date.now(),
                date,
                steps,
                mood,
                habits,
                content,
                pomodoroCount: appData.pomodoro.completedToday || 0,
                created: existingIndex >= 0 ? appData.diary[existingIndex].created : new Date().toISOString(),
                updated: new Date().toISOString()
            };

            if (existingIndex >= 0) {
                appData.diary[existingIndex] = diaryRecord;
            } else {
                appData.diary.unshift(diaryRecord);
            }

            saveData();
            updateDiaryList();
            updateHabitsStats();
            showSuccessMessage('æ—¥èªŒè¨˜éŒ„å·²å„²å­˜ï¼');
        }

        function updateHabitsStats() {
            const container = document.getElementById('habitsStats');
    
            if (appData.habits.length === 0) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 20px;">å°šæœªå»ºç«‹ç¿’æ…£çµ±è¨ˆ</p>';
                return;
            }

            container.innerHTML = appData.habits.map(habit => {
                const streak = calculateHabitStreak(habit.id);
        
                return `
                    <div class="stat-card">
                        <div class="stat-value">${streak}</div>
                        <div class="stat-label">${habit.name}é€£çºŒå¤©æ•¸</div>
                    </div>
                `;
            }).join('');
        }

        function setDiaryFilter(range) {
            filters.diary = range;
            updateDiaryList();
        }

        function updateDiaryList() {
            const container = document.getElementById('diaryList');
            const countElement = document.getElementById('diaryCount');
    
            let filteredDiary = filterRecordsByDate(
                appData.diary, 
                filters.diary, 
                null, 
                null
            );
    
            countElement.textContent = filteredDiary.length;
    
            if (filteredDiary.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">æ­¤æ™‚é–“ç¯„åœå…§ç„¡æ—¥èªŒè¨˜éŒ„</p>';
                return;
            }

            container.innerHTML = filteredDiary.map(diary => {
                const moodText = getMoodText(diary.mood);
                const completedHabits = appData.habits.filter(habit => diary.habits && diary.habits[habit.id]);
        
                return `
                    <div class="diary-entry">
                        <div class="diary-header">
                            <span class="diary-date">${diary.date}</span>
                            ${diary.mood ? `<span class="diary-mood mood-${diary.mood}">${moodText}</span>` : ''}
                        </div>
                
                        ${diary.content ? `<div class="diary-content">${diary.content}</div>` : ''}
                
                        ${completedHabits.length > 0 ? `
                            <div class="diary-habits">
                                ${completedHabits.map(habit => `<span class="diary-habit-tag completed">${habit.name}</span>`).join('')}
                            </div>
                        ` : ''}
                
                        <div class="diary-stats">
                            ${diary.steps ? `<span>ğŸ“± ${diary.steps} æ­¥</span>` : ''}
                            <span>âœ… ${completedHabits.length}/${appData.habits.length} ç¿’æ…£</span>
                        </div>
                
                        <button class="delete-btn" onclick="deleteRecord('diary', ${diary.id})">åˆªé™¤</button>
                    </div>
                `;
            }).join('');
        }

        function getMoodText(mood) {
            const moods = {
                5: 'ğŸ˜„ éå¸¸å¥½',
                4: 'ğŸ˜Š å¾ˆå¥½',
                3: 'ğŸ˜ æ™®é€š',
                2: 'ğŸ˜” ä¸å¤ªå¥½',
                1: 'ğŸ˜ å¾ˆç³Ÿ'
            };
            return moods[mood] || '';
        }

        // çµ±è¨ˆå‡½æ•¸
        function updateWeightStats() {
            if (appData.weights.length === 0) {
                document.getElementById('avgWeight').textContent = '--';
                document.getElementById('latestBMI').textContent = '--';
                document.getElementById('weightChange').textContent = '--';
                document.getElementById('weightAdvice').style.display = 'none';
                return;
            }

            const avgWeight = (appData.weights.reduce((sum, w) => sum + w.weight, 0) / appData.weights.length).toFixed(1);
            document.getElementById('avgWeight').textContent = avgWeight + ' kg';

            const latestWithBMI = appData.weights.find(w => w.bmi);
            if (latestWithBMI) {
                document.getElementById('latestBMI').textContent = latestWithBMI.bmi;
                
                const bmi = latestWithBMI.bmi;
                let advice = '';
                if (bmi < 18.5) {
                    advice = 'æ‚¨çš„ BMI åä½ï¼Œå»ºè­°å¢åŠ ç‡Ÿé¤Šæ”å–ä¸¦è«®è©¢é†«å¸«ã€‚';
                } else if (bmi >= 18.5 && bmi < 24) {
                    advice = 'æ‚¨çš„ BMI åœ¨æ­£å¸¸ç¯„åœå…§ï¼Œè«‹ä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼ã€‚';
                } else if (bmi >= 24 && bmi < 27) {
                    advice = 'æ‚¨çš„ BMI ç¨å¾®åé«˜ï¼Œå»ºè­°é©åº¦é‹å‹•å’Œå‡è¡¡é£²é£Ÿã€‚';
                } else {
                    advice = 'æ‚¨çš„ BMI éé«˜ï¼Œå»ºè­°è«®è©¢é†«å¸«åˆ¶å®šæ¸›é‡è¨ˆç•«ã€‚';
                }
                
                document.getElementById('weightAdviceContent').textContent = advice;
                document.getElementById('weightAdvice').style.display = 'block';
            } else {
                document.getElementById('latestBMI').textContent = '--';
                document.getElementById('weightAdvice').style.display = 'none';
            }

            const thisMonth = new Date().toISOString().slice(0, 7);
            const thisMonthWeights = appData.weights.filter(w => w.date.startsWith(thisMonth));
            
            if (thisMonthWeights.length >= 2) {
                const latest = thisMonthWeights[0].weight;
                const earliest = thisMonthWeights[thisMonthWeights.length - 1].weight;
                const change = (latest - earliest).toFixed(1);
                const changeText = change > 0 ? `+${change}` : change;
                document.getElementById('weightChange').textContent = changeText + ' kg';
            } else {
                document.getElementById('weightChange').textContent = '--';
            }
        }

        function updateBPStats() {
            if (appData.bloodPressure.length === 0) {
                document.getElementById('avgSystolic').textContent = '--';
                document.getElementById('avgDiastolic').textContent = '--';
                document.getElementById('avgPulse').textContent = '--';
                document.getElementById('bpAdvice').style.display = 'none';
                return;
            }

            const avgSystolic = Math.round(appData.bloodPressure.reduce((sum, bp) => sum + bp.systolic, 0) / appData.bloodPressure.length);
            const avgDiastolic = Math.round(appData.bloodPressure.reduce((sum, bp) => sum + bp.diastolic, 0) / appData.bloodPressure.length);
            
            document.getElementById('avgSystolic').textContent = avgSystolic;
            document.getElementById('avgDiastolic').textContent = avgDiastolic;

            const pulseBPs = appData.bloodPressure.filter(bp => bp.pulse);
            if (pulseBPs.length > 0) {
                const avgPulse = Math.round(pulseBPs.reduce((sum, bp) => sum + bp.pulse, 0) / pulseBPs.length);
                document.getElementById('avgPulse').textContent = avgPulse;
            } else {
                document.getElementById('avgPulse').textContent = '--';
            }

            let advice = '';
            if (avgSystolic < 120 && avgDiastolic < 80) {
                advice = 'æ‚¨çš„è¡€å£“åœ¨ç†æƒ³ç¯„åœå…§ï¼Œè«‹ä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼ã€‚';
            } else if (avgSystolic <= 139 && avgDiastolic <= 89) {
                advice = 'æ‚¨çš„è¡€å£“ç¨å¾®åé«˜ï¼Œå»ºè­°æ¸›å°‘é¹½åˆ†æ”å–ã€å¤šé‹å‹•ï¼Œä¸¦å®šæœŸç›£æ¸¬ã€‚';
            } else {
                advice = 'æ‚¨çš„è¡€å£“åé«˜ï¼Œå»ºè­°ç›¡å¿«è«®è©¢é†«å¸«ï¼Œä¸¦éµå¾ªé†«å¸«æŒ‡ç¤ºã€‚';
            }
            
            document.getElementById('bpAdviceContent').textContent = advice;
            document.getElementById('bpAdvice').style.display = 'block';
        }

        function updateExerciseStats() {
            if (appData.exercises.length === 0) {
                document.getElementById('weeklyExercises').textContent = '0';
                document.getElementById('weeklyDuration').textContent = '0';
                document.getElementById('weeklyCalories').textContent = '0';
                document.getElementById('exerciseStreak').textContent = '0';
                document.getElementById('exerciseAdvice').style.display = 'none';
                return;
            }

            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay());
            
            const thisWeekExercises = appData.exercises.filter(ex => {
                const exerciseDate = new Date(ex.date);
                return exerciseDate >= weekStart;
            });

            document.getElementById('weeklyExercises').textContent = thisWeekExercises.length;

            const weeklyDuration = thisWeekExercises.reduce((sum, ex) => sum + ex.duration, 0);
            document.getElementById('weeklyDuration').textContent = weeklyDuration;

            const weeklyCalories = thisWeekExercises.reduce((sum, ex) => sum + (ex.calories || 0), 0);
            document.getElementById('weeklyCalories').textContent = weeklyCalories;

            const sortedDates = [...new Set(appData.exercises.map(ex => ex.date))].sort().reverse();
            let streak = 0;
            
            for (let i = 0; i < sortedDates.length; i++) {
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                const expectedDateStr = expectedDate.toISOString().split('T')[0];
                
                if (sortedDates[i] === expectedDateStr) {
                    streak++;
                } else {
                    break;
                }
            }
            
            document.getElementById('exerciseStreak').textContent = streak;

            let advice = '';
            if (weeklyDuration < 150) {
                advice = 'å»ºè­°æ¯é€±è‡³å°‘é‹å‹• 150 åˆ†é˜ã€‚è©¦è‘—å¢åŠ é‹å‹•é »ç‡ï¼Œæ‚¨ç›®å‰é‚„éœ€è¦ ' + (150 - weeklyDuration) + ' åˆ†é˜ï¼';
            } else if (weeklyDuration >= 150 && weeklyDuration < 300) {
                advice = 'å¾ˆå¥½ï¼æ‚¨å·²é”åˆ°åŸºæœ¬é‹å‹•å»ºè­°ã€‚å¦‚æœæƒ³è¦æ›´å¥½çš„å¥åº·æ•ˆæœï¼Œå¯ä»¥å¢åŠ åˆ°æ¯é€± 300 åˆ†é˜ã€‚';
            } else {
                advice = 'å¤ªæ£’äº†ï¼æ‚¨çš„é‹å‹•é‡è¶…éå»ºè­°æ¨™æº–ï¼Œè«‹ä¿æŒé€™å€‹å¥½ç¿’æ…£ï¼Œæ³¨æ„é©åº¦ä¼‘æ¯é¿å…éåº¦è¨“ç·´ã€‚';
            }
            
            if (streak >= 7) {
                advice += ` é€£çºŒé‹å‹• ${streak} å¤©çœŸæ˜¯å¤ªå²å®³äº†ï¼`;
            } else if (streak >= 3) {
                advice += ` é€£çºŒ ${streak} å¤©é‹å‹•ï¼Œä¿æŒä¸‹å»ï¼`;
            }
            
            document.getElementById('exerciseAdviceContent').textContent = advice;
            document.getElementById('exerciseAdvice').style.display = 'block';
        }

        function updateStats() {
            document.getElementById('totalExpenses').textContent = appData.expenses.length;
            document.getElementById('totalWeight').textContent = appData.weights.length;
            document.getElementById('totalBP').textContent = appData.bloodPressure.length;
            document.getElementById('totalExercise').textContent = appData.exercises.length;
            
            const dataSize = new Blob([JSON.stringify(appData)]).size;
            const sizeKB = (dataSize / 1024).toFixed(1);
            document.getElementById('dataSize').textContent = sizeKB + ' KB';
        }

        // åŸºæœ¬è³‡æ–™ç›¸é—œå‡½æ•¸
        function saveProfile() {
            const name = document.getElementById('profileName').value;
            const birthday = document.getElementById('profileBirthday').value;
            const gender = document.getElementById('profileGender').value;
            const height = parseFloat(document.getElementById('profileHeight').value);
            const activity = document.getElementById('profileActivity').value;

            appData.profile = {
                name,
                birthday,
                gender,
                height,
                activity
            };

            saveData();
            updateProfileDisplay();
            showSuccessMessage('åŸºæœ¬è³‡æ–™å·²å„²å­˜ï¼');
        }

        function loadProfile() {
            if (appData.profile) {
                document.getElementById('profileName').value = appData.profile.name || '';
                document.getElementById('profileBirthday').value = appData.profile.birthday || '';
                document.getElementById('profileGender').value = appData.profile.gender || '';
                document.getElementById('profileHeight').value = appData.profile.height || '';
                document.getElementById('profileActivity').value = appData.profile.activity || 'light';
                
                updateProfileDisplay();
            }
        }

        function updateProfileDisplay() {
            const profile = appData.profile;
            
            if (profile.birthday) {
                const today = new Date();
                const birthDate = new Date(profile.birthday);
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                const finalAge = monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate()) ? age - 1 : age;
                document.getElementById('displayAge').textContent = finalAge + ' æ­²';
            } else {
                document.getElementById('displayAge').textContent = '--';
            }

            if (appData.weights.length > 0 && profile.height) {
                const latestWeight = appData.weights[0];
                const bmi = (latestWeight.weight / ((profile.height / 100) ** 2)).toFixed(1);
                document.getElementById('displayBMI').textContent = bmi;
            } else {
                document.getElementById('displayBMI').textContent = '--';
            }

            if (profile.height) {
                const heightM = profile.height / 100;
                const minWeight = (18.5 * heightM * heightM).toFixed(1);
                const maxWeight = (24 * heightM * heightM).toFixed(1);
                document.getElementById('displayTargetWeight').textContent = `${minWeight}-${maxWeight} kg`;
            } else {
                document.getElementById('displayTargetWeight').textContent = '--';
            }

            if (profile.height && profile.gender && appData.weights.length > 0) {
                const weight = appData.weights[0].weight;
                const age = profile.birthday ? new Date().getFullYear() - new Date(profile.birthday).getFullYear() : 30;
                
                let bmr;
                if (profile.gender === 'male') {
                    bmr = 10 * weight + 6.25 * profile.height - 5 * age + 5;
                } else {
                    bmr = 10 * weight + 6.25 * profile.height - 5 * age - 161;
                }

                const activityMultipliers = {
                    'sedentary': 1.2,
                    'light': 1.375,
                    'moderate': 1.55,
                    'active': 1.725,
                    'very_active': 1.9
                };

                const tdee = Math.round(bmr * activityMultipliers[profile.activity]);
                document.getElementById('displayDailyCalories').textContent = tdee + ' å¡';
            } else {
                document.getElementById('displayDailyCalories').textContent = '--';
            }

            if (profile.height && profile.gender && appData.weights.length > 0) {
                let advice = [];
                
                const latestWeight = appData.weights[0].weight;
                const bmi = latestWeight / ((profile.height / 100) ** 2);
                
                if (bmi < 18.5) {
                    advice.push('æ‚¨çš„ BMI åä½ï¼Œå»ºè­°å¢åŠ ç‡Ÿé¤Šæ”å–ã€‚');
                } else if (bmi >= 18.5 && bmi < 24) {
                    advice.push('æ‚¨çš„ BMI åœ¨ç†æƒ³ç¯„åœå…§ï¼Œè«‹ä¿æŒç›®å‰çš„å¥åº·ç¿’æ…£ã€‚');
                } else if (bmi >= 24 && bmi < 27) {
                    advice.push('æ‚¨çš„ BMI ç¨å¾®åé«˜ï¼Œå»ºè­°æ§åˆ¶é£²é£Ÿä¸¦å¢åŠ é‹å‹•ã€‚');
                } else {
                    advice.push('æ‚¨çš„ BMI éé«˜ï¼Œå»ºè­°è«®è©¢ç‡Ÿé¤Šå¸«åˆ¶å®šæ¸›é‡è¨ˆç•«ã€‚');
                }

                const age = profile.birthday ? new Date().getFullYear() - new Date(profile.birthday).getFullYear() : null;
                if (age) {
                    if (age >= 65) {
                        advice.push('å»ºè­°é€²è¡Œé©åº¦çš„æœ‰æ°§é‹å‹•å’Œé˜»åŠ›è¨“ç·´ï¼Œæ³¨æ„å¹³è¡¡è¨“ç·´é é˜²è·Œå€’ã€‚');
                    } else if (age >= 40) {
                        advice.push('å»ºè­°æ¯é€±è‡³å°‘ 150 åˆ†é˜ä¸­ç­‰å¼·åº¦é‹å‹•ï¼ŒåŒ…å«è‚ŒåŠ›è¨“ç·´ã€‚');
                    } else {
                        advice.push('å¹´è¼•å°±æ˜¯æœ¬éŒ¢ï¼å»ºè­°é¤Šæˆè¦å¾‹é‹å‹•ç¿’æ…£ï¼Œç‚ºæœªä¾†å¥åº·æ‰“åŸºç¤ã€‚');
                    }
                }

                const weeklyExercises = appData.exercises.filter(ex => {
                    const exerciseDate = new Date(ex.date);
                    const weekStart = new Date();
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    return exerciseDate >= weekStart;
                });

                if (weeklyExercises.length < 3) {
                    advice.push('å»ºè­°æ¯é€±è‡³å°‘é‹å‹• 3 æ¬¡ï¼Œæ¯æ¬¡ 30 åˆ†é˜ä»¥ä¸Šã€‚');
                }

                if (advice.length > 0) {
                    document.getElementById('profileAdviceContent').innerHTML = advice.join('<br>');
                    document.getElementById('profileAdvice').style.display = 'block';
                } else {
                    document.getElementById('profileAdvice').style.display = 'none';
                }
            } else {
                document.getElementById('profileAdvice').style.display = 'none';
            }
        }

        // åˆªé™¤è¨˜éŒ„
        function deleteRecord(type, id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
            
            appData[type] = appData[type].filter(record => record.id !== id);
            saveData();
            updateAllDisplays();
            showSuccessMessage('è¨˜éŒ„å·²åˆªé™¤ï¼');
        }

        // æ›´æ–°æ‰€æœ‰é¡¯ç¤º
        function updateAllDisplays() {
            updateExpensesList();
            updateWeightsList();
            updateBPList();
            updateExercisesList();
            updateTasksList();
            updateCompletedTasksList();
            updateDiaryList();
            updateWeightStats();
            updateBPStats();
            updateExerciseStats();
            updateHabitsDisplay();
            updateHabitsStats();
            updateStats();
            updateProfileDisplay();
            updateAllCharts();
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportData(format = 'json') {
            const timestamp = new Date().toISOString().split('T')[0];
            
            if (format === 'json') {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `daily_tracker_backup_${timestamp}.json`;
                link.click();
                
                showSuccessMessage('JSON æ•¸æ“šåŒ¯å‡ºå®Œæˆï¼');
            } else if (format === 'csv') {
                exportCSV(timestamp);
            }
        }

        function exportCSV(timestamp) {
            const csvContent = [];
            
            if (appData.profile && (appData.profile.name || appData.profile.birthday)) {
                csvContent.push('=== åŸºæœ¬è³‡æ–™ ===');
                csvContent.push('é …ç›®,å…§å®¹');
                csvContent.push(`å§“å,${appData.profile.name || ''}`);
                csvContent.push(`ç”Ÿæ—¥,${appData.profile.birthday || ''}`);
                csvContent.push(`æ€§åˆ¥,${appData.profile.gender === 'male' ? 'ç”·æ€§' : appData.profile.gender === 'female' ? 'å¥³æ€§' : ''}`);
                csvContent.push(`èº«é«˜,${appData.profile.height || ''}`);
                csvContent.push(`æ´»å‹•é‡,${appData.profile.activity || ''}`);
                csvContent.push('');
            }

            if (appData.expenses.length > 0) {
                csvContent.push('=== æ”¯å‡ºè¨˜éŒ„ ===');
                csvContent.push('æ—¥æœŸ,åˆ†é¡,é …ç›®,é‡‘é¡,å‚™è¨»');
                appData.expenses.forEach(expense => {
                    csvContent.push(`${expense.date},${expense.category},${expense.item},${expense.amount},"${expense.note || ''}"`);
                });
                csvContent.push('');
            }

            if (appData.weights.length > 0) {
                csvContent.push('=== é«”é‡è¨˜éŒ„ ===');
                csvContent.push('æ—¥æœŸ,æ™‚é–“,é«”é‡(kg),è…°åœ(cm),èº«é«˜(cm),BMI');
                appData.weights.forEach(weight => {
                    csvContent.push(`${weight.date},${weight.time},${weight.weight},${weight.waist || ''},${weight.height || ''},${weight.bmi || ''}`);
                });
                csvContent.push('');
            }

            if (appData.bloodPressure.length > 0) {
                csvContent.push('=== è¡€å£“è¨˜éŒ„ ===');
                csvContent.push('æ—¥æœŸ,æ™‚é–“,æ”¶ç¸®å£“(mmHg),èˆ’å¼µå£“(mmHg),è„ˆæ(æ¬¡/åˆ†)');
                appData.bloodPressure.forEach(bp => {
                    csvContent.push(`${bp.date},${bp.time},${bp.systolic},${bp.diastolic},${bp.pulse || ''}`);
                });
                csvContent.push('');
            }

            if (appData.exercises.length > 0) {
                csvContent.push('=== é‹å‹•è¨˜éŒ„ ===');
                csvContent.push('æ—¥æœŸ,é–‹å§‹æ™‚é–“,é‹å‹•é¡å‹,æ™‚é•·(åˆ†é˜),æ¶ˆè€—å¡è·¯é‡Œ,å¼·åº¦,å‚™è¨»');
                appData.exercises.forEach(exercise => {
                    csvContent.push(`${exercise.date},${exercise.startTime},${exercise.type},${exercise.duration},${exercise.calories || ''},${exercise.intensity},"${exercise.note || ''}"`);
                });
                csvContent.push('');
            }

            if (appData.tasks.length > 0) {
                csvContent.push('=== ä¾‹è¡Œä»»å‹™ ===');
                csvContent.push('ä»»å‹™åç¨±,ä¸‹æ¬¡åˆ°æœŸæ—¥,é‡è¤‡é–“éš”,å„ªå…ˆç´š,å‚™è¨»,å»ºç«‹æ—¥æœŸ');
                appData.tasks.forEach(task => {
                    const taskNote = (task.note || '').replace(/"/g, '""');
                    csvContent.push(`${task.name},${task.nextDate},${task.interval},${task.priority},"${taskNote}",${task.created}`);
                });
                csvContent.push('');
            }

            if (appData.completedTasks.length > 0) {
                csvContent.push('=== å·²å®Œæˆä»»å‹™è¨˜éŒ„ ===');
                csvContent.push('ä»»å‹™åç¨±,å®Œæˆæ—¥æœŸ,å®Œæˆæ™‚é–“,é‡è¤‡é–“éš”,å„ªå…ˆç´š,å‚™è¨»');
                appData.completedTasks.forEach(task => {
                    csvContent.push(`${task.name},${task.completedDate},${task.completedTime},${task.interval},${task.priority},"${task.note || ''}"`);
                });
                csvContent.push('');
            }

            if (appData.habits.length > 0) {
                csvContent.push('=== ç¿’æ…£åˆ—è¡¨ ===');
                csvContent.push('ç¿’æ…£åç¨±,å»ºç«‹æ—¥æœŸ');
                appData.habits.forEach(habit => {
                    csvContent.push(`${habit.name},${habit.created}`);
                });
                csvContent.push('');
            }

            if (appData.diary.length > 0) {
                csvContent.push('=== æ—¥èªŒè¨˜éŒ„ ===');
                csvContent.push('æ—¥æœŸ,æ­¥æ•¸,å¿ƒæƒ…è©•åˆ†,æ—¥èªŒå…§å®¹,å®Œæˆç¿’æ…£æ•¸,ç¿’æ…£è©³æƒ…');
                appData.diary.forEach(diary => {
                    const completedHabits = appData.habits.filter(habit => diary.habits && diary.habits[habit.id]);
                    const habitsDetail = completedHabits.map(h => h.name).join(';');
                    const content = (diary.content || '').replace(/"/g, '""'); // è™•ç†é›™å¼•è™Ÿ
                    csvContent.push(`${diary.date},${diary.steps || ''},${diary.mood || ''},"${content}",${completedHabits.length},"${habitsDetail}"`);
                });
                csvContent.push('');
            }

            csvContent.push('=== æ•¸æ“šçµ±è¨ˆ ===');
            csvContent.push('é¡å‹,è¨˜éŒ„æ•¸é‡');
            csvContent.push(`æ”¯å‡ºè¨˜éŒ„,${appData.expenses.length}`);
            csvContent.push(`é«”é‡è¨˜éŒ„,${appData.weights.length}`);
            csvContent.push(`è¡€å£“è¨˜éŒ„,${appData.bloodPressure.length}`);
            csvContent.push(`é‹å‹•è¨˜éŒ„,${appData.exercises.length}`);
            csvContent.push(`ä¾‹è¡Œä»»å‹™,${appData.tasks.length}`);
            csvContent.push(`å·²å®Œæˆä»»å‹™,${appData.completedTasks.length}`);
            csvContent.push(`ç¿’æ…£é …ç›®,${appData.habits.length}`);
            csvContent.push(`æ—¥èªŒè¨˜éŒ„,${appData.diary.length}`);
            csvContent.push(`åŒ¯å‡ºæ—¥æœŸ,${timestamp}`);

            const csvString = csvContent.join('\n');
            const BOM = '\uFEFF';
            const dataBlob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `daily_tracker_data_${timestamp}.csv`;
            link.click();
            
            showSuccessMessage('CSV æ•¸æ“šåŒ¯å‡ºå®Œæˆï¼');
        }

        function exportSingleCSV(type) {
            const timestamp = new Date().toISOString().split('T')[0];
            let csvContent = [];
            let filename = '';

            switch(type) {
                case 'expenses':
                    csvContent.push('æ—¥æœŸ,åˆ†é¡,é …ç›®,é‡‘é¡,å‚™è¨»');
                    appData.expenses.forEach(expense => {
                        const expenseNote = (expense.note || '').replace(/"/g, '""');
                        csvContent.push(`${expense.date},${expense.category},${expense.item},${expense.amount},"${expenseNote}"`);
                    });
                    filename = `expenses_${timestamp}.csv`;
                    break;

                case 'weights':
                    csvContent.push('æ—¥æœŸ,æ™‚é–“,é«”é‡(kg),è…°åœ(cm),èº«é«˜(cm),BMI');
                    appData.weights.forEach(weight => {
                        csvContent.push(`${weight.date},${weight.time},${weight.weight},${weight.waist || ''},${weight.height || ''},${weight.bmi || ''}`);
                    });
                    filename = `weights_${timestamp}.csv`;
                    break;

                case 'bloodPressure':
                    csvContent.push('æ—¥æœŸ,æ™‚é–“,æ”¶ç¸®å£“(mmHg),èˆ’å¼µå£“(mmHg),è„ˆæ(æ¬¡/åˆ†)');
                    appData.bloodPressure.forEach(bp => {
                        csvContent.push(`${bp.date},${bp.time},${bp.systolic},${bp.diastolic},${bp.pulse || ''}`);
                    });
                    filename = `blood_pressure_${timestamp}.csv`;
                    break;

                case 'exercises':
                    csvContent.push('æ—¥æœŸ,é–‹å§‹æ™‚é–“,é‹å‹•é¡å‹,æ™‚é•·(åˆ†é˜),æ¶ˆè€—å¡è·¯é‡Œ,å¼·åº¦,å‚™è¨»');
                    appData.exercises.forEach(exercise => {
                        const exerciseNote = (exercise.note || '').replace(/"/g, '""');
                        csvContent.push(`${exercise.date},${exercise.startTime},${exercise.type},${exercise.duration},${exercise.calories || ''},${exercise.intensity},"${exerciseNote}"`);
                    });
                    filename = `exercises_${timestamp}.csv`;
                    break;

                case 'tasks':
                    csvContent.push('ä»»å‹™åç¨±,ä¸‹æ¬¡åˆ°æœŸæ—¥,é‡è¤‡é–“éš”,å„ªå…ˆç´š,å‚™è¨»,å»ºç«‹æ—¥æœŸ');
                    appData.tasks.forEach(task => {
                        csvContent.push(`${task.name},${task.nextDate},${task.interval},${task.priority},"${task.note || ''}",${task.created}`);
                    });
                    filename = `tasks_${timestamp}.csv`;
                    break;

                case 'diary':
                    csvContent.push('æ—¥æœŸ,æ­¥æ•¸,å¿ƒæƒ…è©•åˆ†,æ—¥èªŒå…§å®¹,å®Œæˆç¿’æ…£æ•¸,ç¿’æ…£è©³æƒ…');
                    appData.diary.forEach(diary => {
                        const completedHabits = appData.habits.filter(habit => diary.habits && diary.habits[habit.id]);
                        const habitsDetail = completedHabits.map(h => h.name).join(';');
                        csvContent.push(`${diary.date},${diary.steps || ''},${diary.mood || ''},"${diary.content || ''}",${completedHabits.length},"${habitsDetail}"`);
                    });
                    filename = `diary_${timestamp}.csv`;
                    break;
            }

            if (csvContent.length <= 1) {
                alert('æ²’æœ‰æ•¸æ“šå¯ä»¥åŒ¯å‡º');
                return;
            }

            const csvString = csvContent.join('\n');
            const BOM = '\uFEFF';
            const dataBlob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            showSuccessMessage('CSV åŒ¯å‡ºå®Œæˆï¼');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('åŒ¯å…¥æ•¸æ“šå°‡è¦†è“‹ç¾æœ‰æ•¸æ“šï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                        appData = importedData;
                        saveData();
                        updateAllDisplays();
                        loadProfile();
                        showSuccessMessage('æ•¸æ“šåŒ¯å…¥æˆåŠŸï¼');
                    }
                } catch (error) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¢º');
                }
            };
            reader.readAsText(file);
            
            input.value = '';
        }

        function clearAllData() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            
            appData = {
                expenses: [],
                weights: [],
                bloodPressure: [],
                exercises: [],
                tasks: [],
                completedTasks: [],
                diary: [],
                habits: [],
                profile: {
                    name: '',
                    birthday: '',
                    gender: '',
                    height: '',
                    activity: 'light'
                }
            };
            
            saveData();
            updateAllDisplays();
            loadProfile();
            showSuccessMessage('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼');
        }

        function clearTestData() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ¸¬è©¦æ•¸æ“šä¸¦é‡æ–°è¼‰å…¥ç¯„ä¾‹å—ï¼Ÿ')) return;
            
            try {
                localStorage.removeItem('dailyTrackerData');
                location.reload(); // é‡æ–°è¼‰å…¥é é¢ä»¥è¼‰å…¥æ–°çš„ç¯„ä¾‹æ•¸æ“š
            } catch (error) {
                console.error('æ¸…é™¤æ•¸æ“šå¤±æ•—:', error);
            }
        }

        // PWA åŠŸèƒ½
        let deferredPrompt;

        function setupPWAInstall() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installBtn').style.display = 'inline-block';
            });
        }

        setTimeout(() => {
            updateAllCharts();
        }, 500);

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showSuccessMessage('æ‡‰ç”¨å®‰è£æˆåŠŸï¼');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                });
            }
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: 500;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // åœ–è¡¨ç›¸é—œè®Šæ•¸
        let chartFilter = 'week';
        let charts = {};

        // åœ–è¡¨æ™‚é–“å€é–“è¨­å®š
        function setChartFilter(range) {
            chartFilter = range;
    
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#charts .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
    
            // æ›´æ–°é¡¯ç¤ºæ–‡å­—
            const rangeTexts = {
                'week': 'è¿‘ä¸ƒæ—¥',
                'month': 'è¿‘ä¸€å€‹æœˆ', 
                'quarter': 'è¿‘ä¸‰å€‹æœˆ',
                'half-year': 'è¿‘åŠå¹´',
                'year': 'è¿‘ä¸€å¹´',
                'all': 'å…¨éƒ¨æ•¸æ“š'
            };
    
            document.getElementById('chartRangeText').textContent = rangeTexts[range];
            document.getElementById('chartUpdateTime').textContent = new Date().toLocaleString();
    
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰åœ–è¡¨
            updateAllCharts();
        }

        // ç²å–åœ–è¡¨æ•¸æ“šçš„æ™‚é–“ç¯„åœ
        function getChartDateRange(range) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
            switch(range) {
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return { start: weekAgo, end: today };
            
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return { start: monthAgo, end: today };
            
                case 'quarter':
                    const quarterAgo = new Date(today);
                    quarterAgo.setMonth(quarterAgo.getMonth() - 3);
                    return { start: quarterAgo, end: today };
            
                case 'half-year':
                    const halfYearAgo = new Date(today);
                    halfYearAgo.setMonth(halfYearAgo.getMonth() - 6);
                    return { start: halfYearAgo, end: today };
            
                case 'year':
                    const yearAgo = new Date(today);
                    yearAgo.setFullYear(yearAgo.getFullYear() - 1);
                    return { start: yearAgo, end: today };
            
                default: // 'all'
                    return { start: null, end: null };
            }
        }

        // æ ¹æ“šæ™‚é–“ç¯„åœéæ¿¾æ•¸æ“š
        function filterDataByChartRange(records, range) {
            if (range === 'all') return records;
    
            const dateRange = getChartDateRange(range);
            if (!dateRange.start || !dateRange.end) return records;
    
            return records.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= dateRange.start && recordDate <= dateRange.end;
            });
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨
        function updateAllCharts() {
            updateExpenseChart();
            updateWeightChart();
            updateBPChart();
            updateExerciseChart();
            updateTaskChart();
            updateHabitChart();
        }

        // æ”¯å‡ºåˆ†é¡åœ“é¤…åœ–
        function updateExpenseChart() {
            const filteredExpenses = filterDataByChartRange(appData.expenses, chartFilter);
    
            if (filteredExpenses.length === 0) {
                showEmptyChart('expenseChart', 'æ­¤æ™‚é–“ç¯„åœå…§ç„¡æ”¯å‡ºæ•¸æ“š');
                document.getElementById('expenseChartStats').innerHTML = '';
                return;
            }

            // æŒ‰åˆ†é¡çµ±è¨ˆæ”¯å‡º
            const categoryData = {};
            let totalAmount = 0;
    
            filteredExpenses.forEach(expense => {
                if (!categoryData[expense.category]) {
                    categoryData[expense.category] = 0;
                }
                categoryData[expense.category] += expense.amount;
                totalAmount += expense.amount;
            });

            const labels = Object.keys(categoryData);
            const amounts = Object.values(categoryData);
            const colors = ['#8b5cf6', '#06d6a0', '#f72585', '#4cc9f0', '#f77f00', '#fcbf49'];

            const ctx = document.getElementById('expenseChart').getContext('2d');
    
            if (charts.expense) {
                charts.expense.destroy();
            }
    
            charts.expense = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // é¡¯ç¤ºçµ±è¨ˆæ•¸æ“š
            const statsHTML = labels.map((label, index) => {
                const percentage = ((amounts[index] / totalAmount) * 100).toFixed(1);
                return `
                    <div style="text-align: center; padding: 10px; background: ${colors[index]}20; border-radius: 8px;">
                        <div style="font-weight: 600; color: ${colors[index]};">${label}</div>
                        <div style="font-size: 0.9rem;">NT$ ${amounts[index]}</div>
                        <div style="font-size: 0.8rem; color: #6b7280;">${percentage}%</div>
                    </div>
                `;
            }).join('');
    
            document.getElementById('expenseChartStats').innerHTML = statsHTML;
        }

        // é«”é‡è®ŠåŒ–è¶¨å‹¢ç·šåœ–
        function updateWeightChart() {
            const filteredWeights = filterDataByChartRange(appData.weights, chartFilter);
    
            if (filteredWeights.length === 0) {
                showEmptyChart('weightChart', 'æ­¤æ™‚é–“ç¯„åœå…§ç„¡é«”é‡æ•¸æ“š');
                document.getElementById('weightChartStats').innerHTML = '';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedWeights = filteredWeights.sort((a, b) => new Date(a.date) - new Date(b.date));
    
            const labels = sortedWeights.map(w => w.date);
            const weights = sortedWeights.map(w => w.weight);
            const bmis = sortedWeights.map(w => w.bmi).filter(bmi => bmi);

            const ctx = document.getElementById('weightChart').getContext('2d');
    
            if (charts.weight) {
                charts.weight.destroy();
            }
    
            charts.weight = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é«”é‡ (kg)',
                        data: weights,
                        borderColor: '#8b5cf6',
                        backgroundColor: '#8b5cf620',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'é«”é‡ (kg)'
                            }
                        }
                    }
                }
            });

            // é¡¯ç¤ºçµ±è¨ˆ
            const avgWeight = (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1);
            const weightChange = weights.length > 1 ? (weights[weights.length - 1] - weights[0]).toFixed(1) : '0';
            const avgBMI = bmis.length > 0 ? (bmis.reduce((a, b) => a + b, 0) / bmis.length).toFixed(1) : '--';
    
            document.getElementById('weightChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgWeight} kg</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">å¹³å‡é«”é‡</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: ${weightChange > 0 ? '#ef4444' : '#10b981'};">${weightChange > 0 ? '+' : ''}${weightChange} kg</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">æœŸé–“è®ŠåŒ–</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgBMI}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">å¹³å‡ BMI</div>
                    </div>
                </div>
            `;
        }

        // è¡€å£“ç›£æ§åœ–è¡¨ï¼ˆæ—©æ™šåˆ†åˆ¥é¡¯ç¤ºï¼‰
        function updateBPChart() {
            const filteredBP = filterDataByChartRange(appData.bloodPressure, chartFilter);
    
            if (filteredBP.length === 0) {
                showEmptyChart('bpChart', 'æ­¤æ™‚é–“ç¯„åœå…§ç„¡è¡€å£“æ•¸æ“š');
                document.getElementById('bpChartStats').innerHTML = '';
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedBP = filteredBP.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
    
            // åˆ†æ—©ä¸Šï¼ˆ06:00-12:00ï¼‰å’Œæ™šä¸Šï¼ˆ18:00-23:59ï¼‰
            const morningBP = sortedBP.filter(bp => {
                const hour = parseInt(bp.time.split(':')[0]);
                return hour >= 6 && hour < 12;
            });
    
            const eveningBP = sortedBP.filter(bp => {
                const hour = parseInt(bp.time.split(':')[0]);
                return hour >= 18 && hour < 24;
            });

            // æº–å‚™åœ–è¡¨æ•¸æ“š
            const allDates = [...new Set(sortedBP.map(bp => bp.date))].sort();
    
            const morningSystolic = allDates.map(date => {
                const dayData = morningBP.find(bp => bp.date === date);
                return dayData ? dayData.systolic : null;
            });
    
            const morningDiastolic = allDates.map(date => {
                const dayData = morningBP.find(bp => bp.date === date);
                return dayData ? dayData.diastolic : null;
            });
    
            const eveningSystolic = allDates.map(date => {
                const dayData = eveningBP.find(bp => bp.date === date);
                return dayData ? dayData.systolic : null;
            });
    
            const eveningDiastolic = allDates.map(date => {
                const dayData = eveningBP.find(bp => bp.date === date);
                return dayData ? dayData.diastolic : null;
            });

            const ctx = document.getElementById('bpChart').getContext('2d');
    
            if (charts.bp) {
                charts.bp.destroy();
            }
    
            charts.bp = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates,
                    datasets: [
                        {
                            label: 'æ—©ä¸Šæ”¶ç¸®å£“',
                            data: morningSystolic,
                            borderColor: '#ef4444',
                            backgroundColor: '#ef444420',
                            borderWidth: 2,
                            borderDash: [],
                            tension: 0.4
                        },
                        {
                            label: 'æ—©ä¸Šèˆ’å¼µå£“', 
                            data: morningDiastolic,
                            borderColor: '#f97316',
                            backgroundColor: '#f9731620',
                            borderWidth: 2,
                            borderDash: [],
                            tension: 0.4
                        },
                        {
                            label: 'æ™šä¸Šæ”¶ç¸®å£“',
                            data: eveningSystolic,
                            borderColor: '#8b5cf6',
                            backgroundColor: '#8b5cf620',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        },
                        {
                            label: 'æ™šä¸Šèˆ’å¼µå£“',
                            data: eveningDiastolic,
                            borderColor: '#06d6a0',
                            backgroundColor: '#06d6a020',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'è¡€å£“ (mmHg)'
                            },
                            min: 40,
                            max: 180
                        }
                    }
                }
            });

            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const allSystolic = sortedBP.map(bp => bp.systolic);
            const allDiastolic = sortedBP.map(bp => bp.diastolic);
            const avgSystolic = Math.round(allSystolic.reduce((a, b) => a + b, 0) / allSystolic.length);
            const avgDiastolic = Math.round(allDiastolic.reduce((a, b) => a + b, 0) / allDiastolic.length);
    
            const morningAvgSys = morningBP.length > 0 ? Math.round(morningBP.reduce((sum, bp) => sum + bp.systolic, 0) / morningBP.length) : '--';
            const eveningAvgSys = eveningBP.length > 0 ? Math.round(eveningBP.reduce((sum, bp) => sum + bp.systolic, 0) / eveningBP.length) : '--';
    
            document.getElementById('bpChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgSystolic}/${avgDiastolic}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">æ•´é«”å¹³å‡</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">${morningAvgSys}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">æ—©ä¸Šå¹³å‡æ”¶ç¸®å£“</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${eveningAvgSys}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">æ™šä¸Šå¹³å‡æ”¶ç¸®å£“</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">${sortedBP.length}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">æ¸¬é‡æ¬¡æ•¸</div>
                    </div>
                </div>
            `;
        }

        // é‹å‹•çµ±è¨ˆåœ–è¡¨
        function updateExerciseChart() {
            const filteredExercises = filterDataByChartRange(appData.exercises, chartFilter);
    
            if (filteredExercises.length === 0) {
                showEmptyChart('exerciseChart', 'æ­¤æ™‚é–“ç¯„åœå…§ç„¡é‹å‹•æ•¸æ“š');
                document.getElementById('exerciseChartStats').innerHTML = '';
                return;
            }

            // æŒ‰é‹å‹•é¡å‹çµ±è¨ˆæ™‚é•·
            const typeData = {};
            let totalDuration = 0;
            let totalCalories = 0;
    
            filteredExercises.forEach(exercise => {
                if (!typeData[exercise.type]) {
                    typeData[exercise.type] = { duration: 0, calories: 0, count: 0 };
                }
                typeData[exercise.type].duration += exercise.duration;
                typeData[exercise.type].calories += exercise.calories || 0;
                typeData[exercise.type].count += 1;
                totalDuration += exercise.duration;
                totalCalories += exercise.calories || 0;
            });

            const labels = Object.keys(typeData);
            const durations = Object.values(typeData).map(data => data.duration);
            const colors = ['#8b5cf6', '#06d6a0', '#f72585', '#4cc9f0', '#f77f00', '#fcbf49', '#c77dff', '#7209b7'];

            const ctx = document.getElementById('exerciseChart').getContext('2d');
    
            if (charts.exercise) {
                charts.exercise.destroy();
            }
    
            charts.exercise = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é‹å‹•æ™‚é•· (åˆ†é˜)',
                        data: durations,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ™‚é•· (åˆ†é˜)'
                            }
                        }
                    }
                }
            });

            document.getElementById('exerciseChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${totalDuration}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">ç¸½é‹å‹•æ™‚é•· (åˆ†)</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #f77f00;">${totalCalories}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">ç¸½æ¶ˆè€—å¡è·¯é‡Œ</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #06d6a0;">${filteredExercises.length}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">é‹å‹•æ¬¡æ•¸</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #f72585;">${Math.round(totalDuration / filteredExercises.length)}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">å¹³å‡æ™‚é•· (åˆ†)</div>
                    </div>
                </div>
            `;
        }

        // ä»»å‹™å®Œæˆç‡çµ±è¨ˆ
        function updateTaskChart() {
            const dateRange = getChartDateRange(chartFilter);
            let filteredCompletedTasks;
    
            if (chartFilter === 'all') {
                filteredCompletedTasks = appData.completedTasks;
            } else {
                filteredCompletedTasks = appData.completedTasks.filter(task => {
                    const taskDate = new Date(task.completedDate);
                    return taskDate >= dateRange.start && taskDate <= dateRange.end;
                });
            }
    
            if (filteredCompletedTasks.length === 0) {
                showEmptyChart('taskChart', 'æ­¤æ™‚é–“ç¯„åœå…§ç„¡å®Œæˆä»»å‹™æ•¸æ“š');
                document.getElementById('taskChartStats').innerHTML = '';
                return;
            }

            // æŒ‰å„ªå…ˆç´šçµ±è¨ˆ
            const priorityData = { high: 0, medium: 0, low: 0 };
            filteredCompletedTasks.forEach(task => {
                priorityData[task.priority]++;
            });

            const labels = ['é«˜å„ªå…ˆç´š', 'ä¸­å„ªå…ˆç´š', 'ä½å„ªå…ˆç´š'];
            const counts = [priorityData.high, priorityData.medium, priorityData.low];
            const colors = ['#ef4444', '#f59e0b', '#10b981'];

            const ctx = document.getElementById('taskChart').getContext('2d');
    
            if (charts.task) {
                charts.task.destroy();
            }
    
            charts.task = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // è¨ˆç®—å®Œæˆç‡ï¼ˆå‡è¨­æœªå®Œæˆä»»å‹™ä¹Ÿåœ¨æ™‚é–“ç¯„åœå…§ï¼‰
            const totalTasks = appData.tasks.length + filteredCompletedTasks.length;
            const completionRate = totalTasks > 0 ? Math.round((filteredCompletedTasks.length / totalTasks) * 100) : 0;
    
            document.getElementById('taskChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">${filteredCompletedTasks.length}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">å·²å®Œæˆä»»å‹™</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">${priorityData.high}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">é«˜å„ªå…ˆç´šå®Œæˆ</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #0ea5e9;">${completionRate}%</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">å®Œæˆç‡</div>
                    </div>
                </div>
            `;
        }

        // ç¿’æ…£é¤Šæˆåˆ†æ
        function updateHabitChart() {
            if (appData.habits.length === 0) {
                showEmptyChart('habitChart', 'å°šæœªå»ºç«‹ç¿’æ…£é …ç›®');
                document.getElementById('habitChartStats').innerHTML = '';
                return;
            }

            const dateRange = getChartDateRange(chartFilter);
            let dateList = [];
    
            if (chartFilter === 'all') {
                // å–æ‰€æœ‰æ—¥èªŒè¨˜éŒ„çš„æ—¥æœŸ
                dateList = [...new Set(appData.diary.map(d => d.date))].sort();
            } else {
                // ç”Ÿæˆæ—¥æœŸç¯„åœå…§çš„æ‰€æœ‰æ—¥æœŸ
                const start = dateRange.start;
                const end = dateRange.end;
                const current = new Date(start);
        
                while (current <= end) {
                    dateList.push(current.toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }
            }

            // è¨ˆç®—æ¯å€‹ç¿’æ…£çš„å®Œæˆç‡
            const habitData = appData.habits.map(habit => {
                let completedDays = 0;
                let totalDays = 0;
        
                dateList.forEach(date => {
                    const diary = appData.diary.find(d => d.date === date);
                    if (diary) {
                        totalDays++;
                        if (diary.habits && diary.habits[habit.id]) {
                            completedDays++;
                        }
                    }
                });
        
                return {
                    name: habit.name,
                    rate: totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0,
                    completed: completedDays,
                    total: totalDays
                };
            });

            const labels = habitData.map(h => h.name);
            const rates = habitData.map(h => h.rate);
            const colors = ['#8b5cf6', '#06d6a0', '#f72585', '#4cc9f0', '#f77f00', '#fcbf49', '#c77dff', '#7209b7'];

            const ctx = document.getElementById('habitChart').getContext('2d');
    
            if (charts.habit) {
                charts.habit.destroy();
            }
    
            charts.habit = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å®Œæˆç‡ (%)',
                        data: rates,
                        borderColor: '#8b5cf6',
                        backgroundColor: '#8b5cf620',
                        borderWidth: 2,
                        pointBackgroundColor: '#8b5cf6',
                        pointBorderColor: '#fff',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });

            const avgRate = habitData.length > 0 ? Math.round(rates.reduce((a, b) => a + b, 0) / rates.length) : 0;
            const bestHabit = habitData.reduce((best, current) => current.rate > best.rate ? current : best, habitData[0]);
    
            document.getElementById('habitChartStats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #8b5cf6;">${avgRate}%</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">å¹³å‡å®Œæˆç‡</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f0fdf4; border-radius: 10px;">
                        <div style="font-size: 1rem; font-weight: 600; color: #10b981;">${bestHabit ? bestHabit.name : '--'}</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">è¡¨ç¾æœ€ä½³ç¿’æ…£</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fef2f2; border-radius: 10px;">
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">${bestHabit ? bestHabit.rate : 0}%</div>
                        <div style="font-size: 0.9rem; color: #6b7280;">æœ€é«˜å®Œæˆç‡</div>
                    </div>
                </div>
            `;
        }

        // ç©ºåœ–è¡¨é¡¯ç¤ºå‡½æ•¸
        function showEmptyChart(canvasId, message) {
            const ctx = document.getElementById(canvasId).getContext('2d');
    
            if (charts[canvasId.replace('Chart', '')]) {
                charts[canvasId.replace('Chart', '')].destroy();
            }
    
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = '#6b7280';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(message, ctx.canvas.width / 2, ctx.canvas.height / 2);
        }

        // ç²å–åˆ†é¡åœ–ç¤º
        function getCategoryIcon(category) {
            const icons = {
                'é£Ÿç‰©': 'ğŸ½ï¸',
                'äº¤é€š': 'ğŸš—',
                'å¨›æ¨‚': 'ğŸ¬',
                'è³¼ç‰©': 'ğŸ›ï¸',
                'é†«ç™‚': 'ğŸ¥',
                'æ•™è‚²': 'ğŸ“š',
                'è¦è²»': 'ğŸ’¸',
                'å…¶ä»–': 'ğŸ“'
            };
            return icons[category] || 'ğŸ“';
        }

        // é ç®—è¨­å®šç›¸é—œå‡½æ•¸
        function saveBudgets() {
            const budgetMapping = {
                budgetFood: 'é£Ÿç‰©',
                budgetTransport: 'äº¤é€š',
                budgetEntertainment: 'å¨›æ¨‚',
                budgetShopping: 'è³¼ç‰©',
                budgetMedical: 'é†«ç™‚',
                budgetEducation: 'æ•™è‚²',
                budgetUtilities: 'è¦è²»',
                budgetOther: 'å…¶ä»–'
            };

            Object.keys(budgetMapping).forEach(inputId => {
                const value = parseFloat(document.getElementById(inputId).value);
                if (value && value > 0) {
                    appData.budgets[budgetMapping[inputId]] = value;
                }
            });

            saveData();
            updateMonthlyExpenseOverview();
            showSuccessMessage('é ç®—è¨­å®šå·²å„²å­˜ï¼');
        }

        function loadBudgets() {
            const budgetMapping = {
                budgetFood: 'é£Ÿç‰©',
                budgetTransport: 'äº¤é€š',
                budgetEntertainment: 'å¨›æ¨‚',
                budgetShopping: 'è³¼ç‰©',
                budgetMedical: 'é†«ç™‚',
                budgetEducation: 'æ•™è‚²',
                budgetUtilities: 'è¦è²»',
                budgetOther: 'å…¶ä»–'
            };

            Object.keys(budgetMapping).forEach(inputId => {
                const category = budgetMapping[inputId];
                if (appData.budgets && appData.budgets[category]) {
                    document.getElementById(inputId).value = appData.budgets[category];
                }
            });
        }

        function showBudgetSettings() {
            showSection('settings');
        }

        // ç•ªèŒ„é˜åŠŸèƒ½å‡½æ•¸
        function togglePomodoroPanel() {
            const panel = document.getElementById('pomodoroPanel');
            panel.classList.toggle('show');
        }

        function startPomodoro() {
            if (pomodoroState.isPaused) {
                // å¾æš«åœç‹€æ…‹æ¢å¾©
                pomodoroState.isPaused = false;
            } else {
                // é–‹å§‹æ–°çš„ç•ªèŒ„é˜
                const workMinutes = parseInt(document.getElementById('workTime').value) || 25;
                pomodoroState.timeLeft = workMinutes * 60;
                pomodoroState.isBreak = false;
            }
            
            pomodoroState.isRunning = true;
            updatePomodoroButton();
            
            pomodoroState.interval = setInterval(() => {
                pomodoroState.timeLeft--;
                updatePomodoroDisplay();
                
                if (pomodoroState.timeLeft <= 0) {
                    pomodoroComplete();
                }
            }, 1000);
            
            showFocusReminder();
            updatePomodoroDisplay();
        }

        function pausePomodoro() {
            if (pomodoroState.isRunning) {
                pomodoroState.isRunning = false;
                pomodoroState.isPaused = true;
                clearInterval(pomodoroState.interval);
                updatePomodoroButton();
                hideFocusReminder();
            }
        }

        function resetPomodoro() {
            pomodoroState.isRunning = false;
            pomodoroState.isPaused = false;
            pomodoroState.isBreak = false;
            clearInterval(pomodoroState.interval);
            
            const workMinutes = parseInt(document.getElementById('workTime').value) || 25;
            pomodoroState.timeLeft = workMinutes * 60;
            
            updatePomodoroDisplay();
            updatePomodoroButton();
            hideFocusReminder();
        }

        function pomodoroComplete() {
            clearInterval(pomodoroState.interval);
            pomodoroState.isRunning = false;
            
            if (!pomodoroState.isBreak) {
                // å·¥ä½œæ™‚é–“çµæŸï¼Œé–‹å§‹ä¼‘æ¯
                appData.pomodoro.completedToday++;
                appData.pomodoro.totalCompleted++;
                appData.pomodoro.lastDate = new Date().toISOString().split('T')[0];
                
                const breakMinutes = parseInt(document.getElementById('breakTime').value) || 5;
                pomodoroState.timeLeft = breakMinutes * 60;
                pomodoroState.isBreak = true;
                
                saveData();
                updatePomodoroStats();
                showPomodoroNotification('å·¥ä½œå®Œæˆï¼é–‹å§‹ä¼‘æ¯æ™‚é–“', 'ä½ å‰›å®Œæˆäº†ä¸€å€‹ç•ªèŒ„é˜ï¼Œç¾åœ¨é–‹å§‹ä¼‘æ¯å§ï¼');
                
                // è‡ªå‹•é–‹å§‹ä¼‘æ¯è¨ˆæ™‚
                startPomodoro();
            } else {
                // ä¼‘æ¯æ™‚é–“çµæŸ
                const workMinutes = parseInt(document.getElementById('workTime').value) || 25;
                pomodoroState.timeLeft = workMinutes * 60;
                pomodoroState.isBreak = false;
                
                showPomodoroNotification('ä¼‘æ¯å®Œæˆï¼', 'æº–å‚™é–‹å§‹ä¸‹ä¸€å€‹ç•ªèŒ„é˜äº†å—ï¼Ÿ');
                updatePomodoroDisplay();
                updatePomodoroButton();
                hideFocusReminder();
            }
        }

        function updatePomodoroDisplay() {
            const minutes = Math.floor(pomodoroState.timeLeft / 60);
            const seconds = pomodoroState.timeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('pomodoroDisplay').textContent = timeString;
            
            // æ›´æ–°æé†’æ¢
            if (pomodoroState.isRunning) {
                const statusText = pomodoroState.isBreak ? 'ä¼‘æ¯æ™‚é–“' : 'å°ˆæ³¨æ™‚é–“';
                document.getElementById('focusReminderText').textContent = `${statusText}é€²è¡Œä¸­ï¼šé‚„å‰© ${timeString}`;
            }
        }

        function updatePomodoroButton() {
            const btn = document.getElementById('pomodoroBtn');
            
            if (pomodoroState.isRunning) {
                const minutes = Math.floor(pomodoroState.timeLeft / 60);
                btn.textContent = minutes.toString();
                btn.className = pomodoroState.isBreak ? 'pomodoro-btn break' : 'pomodoro-btn running';
            } else {
                btn.textContent = 'ğŸ…';
                btn.className = 'pomodoro-btn';
            }
        }

        function showFocusReminder() {
            if (pomodoroState.isRunning && !pomodoroState.isBreak) {
                document.getElementById('focusReminder').classList.add('show');
                pomodoroState.reminderShown = true;
            }
        }

        function hideFocusReminder() {
            document.getElementById('focusReminder').classList.remove('show');
            pomodoroState.reminderShown = false;
        }

        function updatePomodoroStats() {
            const today = new Date().toISOString().split('T')[0];
            
            // é‡ç½®æ¯æ—¥è¨ˆæ•¸
            if (appData.pomodoro.lastDate !== today) {
                appData.pomodoro.completedToday = 0;
                appData.pomodoro.lastDate = today;
            }
            
            document.getElementById('pomodoroStats').textContent = 
                `ä»Šæ—¥å®Œæˆ: ${appData.pomodoro.completedToday} å€‹ç•ªèŒ„`;
        }

        function showPomodoroNotification(title, message) {
            // ä½¿ç”¨ç¾æœ‰çš„æˆåŠŸè¨Šæ¯ç³»çµ±
            showSuccessMessage(`${title} ${message}`);
            
            // æ’­æ”¾æç¤ºéŸ³ï¼ˆå¦‚æœç€è¦½å™¨æ”¯æŒï¼‰
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmgaBCSF0fPTgjMGHm7A7+OZSA0PVqzn77BdGAg+ltryxnkpBSl+zPLZiToIGGS57OihUgwLUKXh8bllHgg2jdXzzn0vBSF1xe/glEILElyx6OyrWBUIQ5zd8sFuIAUuhM/z3YU2Bhxqvu7mnEoODlOq5O+zYBoGPJPY88p9KwUme8rx4I5FDBFYr+ftrVoXCECY2/PHdSMELYDN8tuJOQcZZ7zs5Z1NEgxPpeDwtWUcBjiS2fDOeSsFJHfH8N2QQAoUXrTp66hVFApGnt/yvmgaBCOB0PPTgjQGHW/A7eSaRw4OVKzm7bJeGQc9k9nxy3osBSZ8y/DdkUMKElmt5+qvVhgIQ5zb88NwIwUsf8zy3Io5CBhnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0OY2fLGdSMELYDN8tyJOQcZZ7vs5Z1NHQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgISJvb88NwIwUtf8zy3Yo4CBpnvOzlnUkODFCl4PC2ZRsHOI7Y8M59LQUjdcbw3I9FCRNcrubrqlkVB0CY2fPGdSMELYDN8tyJOQgZZ7vs5Z1NDQxPpODwt2UcBjmR2PDPeSsEJXjH8N2QQAoUXrTp66hVFAlGnt/yv2gaBCOB0PPTgzQGHm/A7eSaSA4OVKzm7bJeGgU9k9nxy3osBSV8y/HdkUMKElmt5+qvVhgI');
                audio.play().catch(() => {}); // å¿½ç•¥æ’­æ”¾å¤±æ•—çš„éŒ¯èª¤
            } catch (e) {}
        }

        // åˆå§‹åŒ–ç•ªèŒ„é˜
        function initPomodoro() {
            // è¼‰å…¥è¨­å®š
            if (appData.pomodoro) {
                document.getElementById('workTime').value = appData.pomodoro.workTime;
                document.getElementById('breakTime').value = appData.pomodoro.breakTime;
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©ï¼Œé‡ç½®æ¯æ—¥è¨ˆæ•¸
                const today = new Date().toISOString().split('T')[0];
                if (appData.pomodoro.lastDate !== today) {
                    appData.pomodoro.completedToday = 0;
                    appData.pomodoro.lastDate = today;
                    saveData();
                }
                
                updatePomodoroStats();
            }
            
            // ç›£è½æ™‚é–“è¨­å®šè®Šæ›´
            document.getElementById('workTime').addEventListener('change', savePomodoroSettings);
            document.getElementById('breakTime').addEventListener('change', savePomodoroSettings);
            
            // ç›£è½é é¢åˆ‡æ›
            setupNavigationListeners();
            
            // ç›£è½é é¢é›¢é–‹
            window.addEventListener('beforeunload', handleBeforeUnload);
            
            // é»æ“Šå¤–éƒ¨é—œé–‰é¢æ¿
            document.addEventListener('click', function(e) {
                const panel = document.getElementById('pomodoroPanel');
                const btn = document.getElementById('pomodoroBtn');
                
                if (!panel.contains(e.target) && !btn.contains(e.target)) {
                    panel.classList.remove('show');
                }
            });
        }

        function savePomodoroSettings() {
            appData.pomodoro.workTime = parseInt(document.getElementById('workTime').value) || 25;
            appData.pomodoro.breakTime = parseInt(document.getElementById('breakTime').value) || 5;
            saveData();
            
            // å¦‚æœç•¶å‰æ²’æœ‰åœ¨é‹è¡Œï¼Œæ›´æ–°é¡¯ç¤ºæ™‚é–“
            if (!pomodoroState.isRunning) {
                pomodoroState.timeLeft = appData.pomodoro.workTime * 60;
                updatePomodoroDisplay();
            }
        }

        function setupNavigationListeners() {
            // ç›£è½å°èˆªæŒ‰éˆ•é»æ“Š
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (pomodoroState.isRunning && !pomodoroState.isBreak && !pomodoroState.reminderShown) {
                        showFocusReminder();
                    }
                });
            });
        }

        function handleBeforeUnload(e) {
            if (pomodoroState.isRunning && !pomodoroState.isBreak) {
                e.preventDefault();
                e.returnValue = 'å°ˆæ³¨æ™‚é–“å°šæœªçµæŸï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return 'å°ˆæ³¨æ™‚é–“å°šæœªçµæŸï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        }

        // Service Worker è¨»å†Š
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript,const CACHE_NAME="daily-tracker-v1";const urlsToCache=["/"];self.addEventListener("install",event=>{event.waitUntil(caches.open(CACHE_NAME).then(cache=>cache.addAll(urlsToCache)))});self.addEventListener("fetch",event=>{event.respondWith(caches.match(event.request).then(response=>{return response||fetch(event.request)}))});')
                .then(registration => {
                    console.log('Service Worker è¨»å†ŠæˆåŠŸ');
                })
                .catch(error => {
                    console.log('Service Worker è¨»å†Šå¤±æ•—:', error);
                });
        }
    </script>
    <!-- æµ®å‹•ç•ªèŒ„é˜ -->
    <div class="pomodoro-float">
        <button class="pomodoro-btn" id="pomodoroBtn" onclick="togglePomodoroPanel()">ğŸ…</button>
        
        <div class="pomodoro-panel" id="pomodoroPanel">
            <div class="pomodoro-time-display" id="pomodoroDisplay">25:00</div>
            
            <div class="pomodoro-controls">
                <button class="pomodoro-control-btn pomodoro-start" onclick="startPomodoro()">é–‹å§‹</button>
                <button class="pomodoro-control-btn pomodoro-pause" onclick="pausePomodoro()">æš«åœ</button>
                <button class="pomodoro-control-btn pomodoro-reset" onclick="resetPomodoro()">é‡ç½®</button>
            </div>
            
            <div class="pomodoro-settings">
                <span>å·¥ä½œ: <input type="number" id="workTime" value="25" min="1" max="60"> åˆ†</span>
                <span>ä¼‘æ¯: <input type="number" id="breakTime" value="5" min="1" max="30"> åˆ†</span>
            </div>
            
            <div class="pomodoro-stats" id="pomodoroStats">
                ä»Šæ—¥å®Œæˆ: 0 å€‹ç•ªèŒ„
            </div>
        </div>
    </div>

    <!-- å°ˆæ³¨æé†’æ¢ -->
    <div class="focus-reminder" id="focusReminder">
        <span id="focusReminderText">ç•ªèŒ„é˜é€²è¡Œä¸­ï¼šé‚„å‰© 25:00</span>
        <button onclick="hideFocusReminder()">æˆ‘çŸ¥é“äº†</button>
    </div>
</body>
</html>