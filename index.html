<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>我的日常記錄</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #f8f0fb;
      margin: 0;
      padding: 0;
    }
    header {
      background: #d8a7f0;
      color: white;
      text-align: center;
      padding: 1rem;
      font-size: 1.5rem;
      font-weight: bold;
    }
    nav {
      display: flex;
      background: #f3d9fa;
    }
    nav button {
      flex: 1;
      padding: 1rem;
      border: none;
      background: #f3d9fa;
      font-size: 1rem;
      cursor: pointer;
    }
    nav button.active {
      background: #d8a7f0;
      color: white;
    }
    .tab {
      display: none;
      padding: 1rem;
    }
    .tab.active {
      display: block;
    }
    form {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: auto;
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    input, select, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.2rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button[type="submit"] {
      background: #d8a7f0;
      color: white;
      border: none;
      margin-top: 1rem;
      cursor: pointer;
    }
    button[type="submit"]:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .loading {
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <header>我的日常記錄</header>
  
  <nav>
    <button class="active" onclick="showTab('expense')">支出</button>
    <button onclick="showTab('weight')">體重</button>
    <button onclick="showTab('bp')">血壓</button>
  </nav>

  <!-- 支出 -->
  <div id="expense" class="tab active">
    <form onsubmit="saveExpense(event)">
      <label>日期：
        <input type="date" id="expDate" required>
      </label>
      <label>分類：
        <select id="expCategory">
          <option>食</option>
          <option>衣</option>
          <option>住</option>
          <option>行</option>
          <option>其他</option>
        </select>
      </label>
      <label>金額：
        <input type="number" id="expAmount" required>
      </label>
      <label>備註：
        <input type="text" id="expNote">
      </label>
      <button type="submit">送出</button>
    </form>
  </div>

  <!-- 體重 -->
  <div id="weight" class="tab">
    <form onsubmit="saveWeight(event)">
      <label>時間：
        <input type="datetime-local" id="weightTime" required>
      </label>
      <label>體重 (kg)：
        <input type="number" step="0.1" id="weightValue" required>
      </label>
      <button type="submit">送出</button>
    </form>
  </div>

  <!-- 血壓 -->
  <div id="bp" class="tab">
    <form onsubmit="saveBP(event)">
      <label>時間：
        <input type="datetime-local" id="bpTime" required>
      </label>
      <label>收縮壓：
        <input type="number" id="bpSys" required>
      </label>
      <label>舒張壓：
        <input type="number" id="bpDia" required>
      </label>
      <label>脈搏：
        <input type="number" id="bpPulse">
      </label>
      <button type="submit">送出</button>
    </form>
  </div>

  <script>
    // 替換成您的實際 URL 和 API 金鑰
    const API_URL = "https://script.google.com/macros/s/AKfycbxPY-PGguDV0ugDXqUlCvO2JPdZ8ZlypXZc0IcWklIR9zYtIkP0ELjHp6A-nxAxYtQSjA/exec";
    const API_KEY = "1qazxsw23edc"; // 與後端相同的 API 金鑰

    function showTab(tabId) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      document.querySelector(`nav button[onclick="showTab('${tabId}')"]`).classList.add("active");
    }

    function submitData(data, form) {
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '送出中...';
      form.classList.add('loading');

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          apiKey: API_KEY,
          ...data
        }),
        headers: { 
          "Content-Type": "application/json"
        }
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          alert("✅ 記錄已保存！");
          form.reset();
          // 為日期和時間欄位設置當前時間
          setCurrentDateTime();
        } else {
          alert("❌ 儲存失敗：" + (result.error || "未知錯誤"));
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert("❌ 發生網路錯誤，請檢查連線或稍後再試");
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = '送出';
        form.classList.remove('loading');
      });
    }

    function saveExpense(e) {
      e.preventDefault();
      const data = {
        type: "expense",
        date: document.getElementById("expDate").value,
        category: document.getElementById("expCategory").value,
        amount: document.getElementById("expAmount").value,
        note: document.getElementById("expNote").value
      };
      submitData(data, e.target);
    }

    function saveWeight(e) {
      e.preventDefault();
      const data = {
        type: "weight",
        datetime: document.getElementById("weightTime").value,
        weight: document.getElementById("weightValue").value
      };
      submitData(data, e.target);
    }

    function saveBP(e) {
      e.preventDefault();
      const data = {
        type: "bp",
        datetime: document.getElementById("bpTime").value,
        sys: document.getElementById("bpSys").value,
        dia: document.getElementById("bpDia").value,
        pulse: document.getElementById("bpPulse").value
      };
      submitData(data, e.target);
    }

    function setCurrentDateTime() {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      const datetimeStr = now.toISOString().slice(0, 16);
      
      // 設置當前日期
      document.getElementById("expDate").value = dateStr;
      
      // 設置當前時間
      document.getElementById("weightTime").value = datetimeStr;
      document.getElementById("bpTime").value = datetimeStr;
    }

    // 頁面載入時設置當前日期時間
    document.addEventListener('DOMContentLoaded', setCurrentDateTime);
  </script>
</body>
</html>